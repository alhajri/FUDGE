<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc &#8212; Fudge and GND 4.2.2 beta documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '4.2.2 beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/gnd-20121206-favicon.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Fudge and GND 4.2.2 beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc</h1><div class="highlight"><pre>
<span></span><span class="c1"># &lt;&lt;BEGIN-copyright&gt;&gt;</span>
<span class="c1"># &lt;&lt;END-copyright&gt;&gt;</span>

<span class="n">epsilonExponent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">energyUnit</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">pqu</span> <span class="k">import</span> <span class="n">PQU</span> <span class="k">as</span> <span class="n">PQUModule</span>

<span class="kn">from</span> <span class="nn">fudge.core.math</span> <span class="k">import</span> <span class="n">matrix</span> <span class="k">as</span> <span class="n">gndMatrix</span>
<span class="kn">from</span> <span class="nn">fudge.core.math</span> <span class="k">import</span> <span class="n">linearAlgebra</span> <span class="k">as</span> <span class="n">linearAlgebraModule</span>

<span class="kn">import</span> <span class="nn">xData.standards</span> <span class="k">as</span> <span class="nn">standardsModule</span>
<span class="kn">import</span> <span class="nn">xData.axes</span> <span class="k">as</span> <span class="nn">axesModule</span>
<span class="kn">import</span> <span class="nn">xData.constant</span> <span class="k">as</span> <span class="nn">constantModule</span>
<span class="kn">import</span> <span class="nn">xData.values</span> <span class="k">as</span> <span class="nn">valuesModule</span>
<span class="kn">import</span> <span class="nn">xData.XYs</span> <span class="k">as</span> <span class="nn">XYsModule</span>
<span class="kn">import</span> <span class="nn">xData.regions</span> <span class="k">as</span> <span class="nn">regionsModule</span>
<span class="kn">import</span> <span class="nn">xData.link</span> <span class="k">as</span> <span class="nn">linkModule</span>
<span class="kn">import</span> <span class="nn">xData.multiD_XYs</span> <span class="k">as</span> <span class="nn">multiD_XYsModule</span>
<span class="kn">import</span> <span class="nn">xData.array</span> <span class="k">as</span> <span class="nn">arrayModule</span>
<span class="kn">import</span> <span class="nn">xData.gridded</span> <span class="k">as</span> <span class="nn">griddedModule</span>
<span class="kn">import</span> <span class="nn">xData.uncertainties</span> <span class="k">as</span> <span class="nn">uncertaintiesModule</span>

<span class="kn">from</span> <span class="nn">PoPs</span> <span class="k">import</span> <span class="n">misc</span> <span class="k">as</span> <span class="n">miscPoPsModule</span>
<span class="kn">from</span> <span class="nn">PoPs</span> <span class="k">import</span> <span class="n">IDs</span> <span class="k">as</span> <span class="n">IDsPoPsModule</span>
<span class="kn">from</span> <span class="nn">PoPs</span> <span class="k">import</span> <span class="n">alias</span> <span class="k">as</span> <span class="n">PoPsAliasModule</span>
<span class="kn">from</span> <span class="nn">PoPs.families</span> <span class="k">import</span> <span class="n">nuclearLevel</span> <span class="k">as</span> <span class="n">nuclearLevelPoPsModule</span>

<span class="kn">from</span> <span class="nn">fudge.gnd</span> <span class="k">import</span> <span class="n">physicalQuantity</span> <span class="k">as</span> <span class="n">physicalQuantityModule</span>

<span class="kn">import</span> <span class="nn">fudge.gnd.alias</span> <span class="k">as</span> <span class="nn">aliasModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.tokens</span> <span class="k">as</span> <span class="nn">tokensModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.resonances</span> <span class="k">as</span> <span class="nn">resonancesModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.sums</span> <span class="k">as</span> <span class="nn">sumsModule</span>
<span class="kn">from</span> <span class="nn">fudge.gnd.differentialCrossSection</span> <span class="k">import</span> <span class="n">CoulombElastic</span> <span class="k">as</span> <span class="n">CoulombElasticModule</span>

<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.base</span> <span class="k">as</span> <span class="nn">covarianceBaseModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.covarianceSuite</span> <span class="k">as</span> <span class="nn">covarianceSuiteModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.section</span> <span class="k">as</span> <span class="nn">covarianceSectionModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.summed</span> <span class="k">as</span> <span class="nn">covarianceSummedModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.mixed</span> <span class="k">as</span> <span class="nn">covarianceMixedModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.modelParameters</span> <span class="k">as</span> <span class="nn">covarianceModelParametersModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.covariances.distributions</span> <span class="k">as</span> <span class="nn">covarianceDistributionsModule</span>

<span class="kn">import</span> <span class="nn">fudge.gnd.channels</span> <span class="k">as</span> <span class="nn">channelsModule</span>

<span class="kn">import</span> <span class="nn">fudge.gnd.channelData.fissionEnergyReleased</span> <span class="k">as</span> <span class="nn">fissionEnergyReleasedModule</span>

<span class="kn">import</span> <span class="nn">fudge.gnd.reactions.reaction</span> <span class="k">as</span> <span class="nn">reactionModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.reactions.production</span> <span class="k">as</span> <span class="nn">productionModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.reactionData.crossSection</span> <span class="k">as</span> <span class="nn">crossSectionModule</span>

<span class="kn">import</span> <span class="nn">fudge.gnd.productData.multiplicity</span> <span class="k">as</span> <span class="nn">multiplicityModule</span>
<span class="kn">from</span> <span class="nn">fudge.gnd.productData</span> <span class="k">import</span> <span class="n">energyDeposition</span> <span class="k">as</span> <span class="n">energyDepositionModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.unknown</span> <span class="k">as</span> <span class="nn">unknownModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.unspecified</span> <span class="k">as</span> <span class="nn">unspecifiedModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.angular</span> <span class="k">as</span> <span class="nn">angularModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.energy</span> <span class="k">as</span> <span class="nn">energyModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.uncorrelated</span> <span class="k">as</span> <span class="nn">uncorrelatedModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.angularEnergy</span> <span class="k">as</span> <span class="nn">angularEnergyModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.energyAngular</span> <span class="k">as</span> <span class="nn">energyAngularModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.KalbachMann</span> <span class="k">as</span> <span class="nn">KalbachMannModule</span>
<span class="kn">import</span> <span class="nn">fudge.gnd.productData.distributions.reference</span> <span class="k">as</span> <span class="nn">referenceModule</span>

<span class="kn">from</span> <span class="nn">fudge.legacy.converting</span> <span class="k">import</span> <span class="n">endf_endl</span> <span class="k">as</span> <span class="n">endf_endlModule</span>
<span class="kn">from</span> <span class="nn">fudge.legacy.converting</span> <span class="k">import</span> <span class="n">toGNDMisc</span> <span class="k">as</span> <span class="n">toGNDMiscModule</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">endfFileToGNDMisc</span> <span class="k">as</span> <span class="n">endfFileToGNDMiscModule</span>

<span class="n">MTWithOnlyNeutonProducts</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
<span class="k">for</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span> <span class="p">:</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span><span class="p">[</span><span class="n">MT</span><span class="p">][</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">or</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span><span class="o">.</span><span class="n">isFission</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">MTWithOnlyNeutonProducts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">MT</span> <span class="p">)</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">centerOfMassToken</span> <span class="p">}</span>
<span class="n">FUDGE_EPS</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">FUDGE_EPS</span>
<span class="n">productNameToZA</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;n&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span> <span class="p">:</span> <span class="mi">1001</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span> <span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;H3&#39;</span> <span class="p">:</span> <span class="mi">1003</span><span class="p">,</span> <span class="s1">&#39;He3&#39;</span> <span class="p">:</span> <span class="mi">2003</span><span class="p">,</span> <span class="s1">&#39;He4&#39;</span> <span class="p">:</span> <span class="mi">2004</span><span class="p">,</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="n">lightIsotopeNames</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;H3&#39;</span><span class="p">,</span> <span class="s1">&#39;He3&#39;</span><span class="p">,</span> <span class="s1">&#39;He4&#39;</span> <span class="p">]</span>

<span class="c1"># The following is a kludge for ENDF/B-VII.1 files that are missing some MF 8 data. Namely,</span>
<span class="c1">#    n-020_Ca_040, n-020_Ca_042, n-020_Ca_043, n-020_Ca_044, n-020_Ca_046, n-020_Ca_048,</span>
<span class="c1">#    n-082_Pb_204, n-082_Pb_206, n-082_Pb_207 and n-082_Pb_208.</span>
<span class="c1"># Data for the following meta-stables are bogus as I could not find values:</span>
<span class="c1"># Re182_m1, Ir186_m1, Au185_m1, Hg187_m1, Hg189_m1, Hg191_m1, Tl186_m1, Tl188_m1, Tl190_m1, Tl191_m1, Tl193_m1, Tl194_m1, Pb193_m1 and Pb199_m1.</span>
<span class="c1"># Meta-stable energies in eV. Data as ( levelIndex, levelEnergy )</span>
<span class="n">metaStableData</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Al26_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">228305.</span> <span class="p">),</span>     <span class="s2">&quot;Cl34_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">146360.</span> <span class="p">),</span>     <span class="s2">&quot;W179_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">221926.</span> <span class="p">),</span>         <span class="s2">&quot;W183_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">309493.</span> <span class="p">),</span>
    <span class="s2">&quot;W185_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">197383.</span> <span class="p">),</span>     <span class="s2">&quot;Re182_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Re184_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">188010.</span> <span class="p">),</span>        <span class="s2">&quot;Re186_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">149000.</span> <span class="p">),</span>
    <span class="s2">&quot;Re188_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">172069.</span> <span class="p">),</span>    <span class="s2">&quot;Re190_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">210000.</span> <span class="p">),</span>    <span class="s2">&quot;Os181_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">49200.</span> <span class="p">),</span>         <span class="s2">&quot;Os183_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">170710.</span> <span class="p">),</span>
    <span class="s2">&quot;Os189_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">30812.</span> <span class="p">),</span>     <span class="s2">&quot;Os191_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">74382.</span> <span class="p">),</span>     <span class="s2">&quot;Ir186_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>          <span class="s2">&quot;Ir190_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">26100.</span> <span class="p">),</span>
    <span class="s2">&quot;Ir190_m2&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">37</span><span class="p">,</span> <span class="mf">376400.</span> <span class="p">)</span> <span class="p">,</span>  <span class="s2">&quot;Ir191_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">171240.</span> <span class="p">),</span>    <span class="s2">&quot;Ir192_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">56720.</span> <span class="p">),</span>         <span class="s2">&quot;Ir192_m2&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">16</span><span class="p">,</span> <span class="mf">168140.</span> <span class="p">),</span>
    <span class="s2">&quot;Ir193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">80239.</span> <span class="p">),</span>     <span class="s2">&quot;Ir194_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">147072.</span> <span class="p">),</span>    <span class="s2">&quot;Ir195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="n">e5</span> <span class="p">),</span>            <span class="s2">&quot;Ir196_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">410000.</span> <span class="p">),</span>
    <span class="s2">&quot;Ir197_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">115000.</span> <span class="p">),</span>    <span class="s2">&quot;Pt183_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">34500.</span> <span class="p">),</span>     <span class="s2">&quot;Pt185_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">103410.</span> <span class="p">),</span>        <span class="s2">&quot;Pt193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">149780.</span> <span class="p">),</span>
    <span class="s2">&quot;Pt195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">259300.</span> <span class="p">),</span>    <span class="s2">&quot;Pt197_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">9</span><span class="p">,</span> <span class="mf">399590.</span> <span class="p">),</span>    <span class="s2">&quot;Pt199_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">424000.</span> <span class="p">),</span>        <span class="s2">&quot;Au185_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>
    <span class="s2">&quot;Au187_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">120510.</span> <span class="p">),</span>    <span class="s2">&quot;Au189_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">247230.</span> <span class="p">),</span>    <span class="s2">&quot;Au193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">290190.</span> <span class="p">),</span>        <span class="s2">&quot;Au195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">318580.</span> <span class="p">),</span>
    <span class="s2">&quot;Au196_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">84656.</span> <span class="p">),</span>     <span class="s2">&quot;Au197_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">409150.</span> <span class="p">),</span>    <span class="s2">&quot;Au200_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">11</span><span class="p">,</span> <span class="mf">962000.</span> <span class="p">),</span>       <span class="s2">&quot;Hg185_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">99300.</span> <span class="p">),</span>
    <span class="s2">&quot;Hg187_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Hg189_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Hg191_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>          <span class="s2">&quot;Hg193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">140760.</span> <span class="p">),</span>
    <span class="s2">&quot;Hg195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">176070.</span> <span class="p">),</span>    <span class="s2">&quot;Hg197_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">298930.</span> <span class="p">),</span>    <span class="s2">&quot;Hg199_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">532480.</span> <span class="p">),</span>        <span class="s2">&quot;Tl186_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>
    <span class="s2">&quot;Tl187_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">335009.</span> <span class="p">),</span>    <span class="s2">&quot;Tl188_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Tl189_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">257600.</span> <span class="p">),</span>        <span class="s2">&quot;Tl190_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>
    <span class="s2">&quot;Tl191_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Tl192_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">156000.</span> <span class="p">),</span>    <span class="s2">&quot;Tl193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>          <span class="s2">&quot;Tl194_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>
    <span class="s2">&quot;Tl195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">482630.</span> <span class="p">),</span>    <span class="s2">&quot;Tl196_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">394200.</span> <span class="p">),</span>    <span class="s2">&quot;Tl198_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">543500.</span> <span class="p">),</span>        <span class="s2">&quot;Pb187_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">81000.</span> <span class="p">),</span>
    <span class="s2">&quot;Pb191_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">138000.</span> <span class="p">),</span>    <span class="s2">&quot;Pb193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Pb195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">202900.</span> <span class="p">),</span>        <span class="s2">&quot;Pb197_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">319310.</span> <span class="p">),</span>
    <span class="s2">&quot;Pb199_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1000.</span> <span class="p">),</span>      <span class="s2">&quot;Pb201_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">629100.</span> <span class="p">),</span>    <span class="s2">&quot;Pb202_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">13</span><span class="p">,</span> <span class="mf">2169830.</span> <span class="p">),</span>      <span class="s2">&quot;Pb203_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">825200.</span> <span class="p">),</span>
    <span class="s2">&quot;Sc42_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">616300.</span> <span class="p">),</span>    <span class="s2">&quot;Sc44_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">271240.</span> <span class="p">),</span>    <span class="s2">&quot;Sc46_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">142528.</span> <span class="p">),</span>
    <span class="s2">&quot;Mn50_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">225280.</span> <span class="p">),</span>    <span class="s2">&quot;Mn52_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">377749.</span> <span class="p">),</span>
    <span class="s2">&quot;Se73_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">25710.</span> <span class="p">),</span>    <span class="s2">&quot;Se77_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">161922.3</span> <span class="p">),</span>   <span class="s2">&quot;Se79_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">95770.</span> <span class="p">),</span>         <span class="s2">&quot;Se81_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">103000.</span> <span class="p">),</span>
    <span class="s2">&quot;Br74_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">13580.</span> <span class="p">),</span>    <span class="s2">&quot;Br76_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">102580.</span> <span class="p">),</span>    <span class="s2">&quot;Br77_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">105860.</span> <span class="p">),</span>        <span class="s2">&quot;Br79_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">207610.</span> <span class="p">),</span>
    <span class="s2">&quot;Br80_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">85843.</span> <span class="p">),</span>    <span class="s2">&quot;Br82_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">45949.2</span> <span class="p">),</span>   <span class="s2">&quot;Br84_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">320000.</span> <span class="p">),</span>
    <span class="s2">&quot;Kr79_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">129770.</span> <span class="p">),</span>    <span class="s2">&quot;Kr81_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">190640.</span> <span class="p">),</span>    <span class="s2">&quot;Kr83_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">41557.5</span> <span class="p">),</span>       <span class="s2">&quot;Kr85_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">304871.</span> <span class="p">),</span>
    <span class="s2">&quot;Rb81_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">86317.1</span> <span class="p">),</span>    <span class="s2">&quot;Rb82_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">69000.</span> <span class="p">),</span>    <span class="s2">&quot;Rb84_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">463591.</span> <span class="p">),</span>        <span class="s2">&quot;Rb86_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">556051.</span> <span class="p">),</span>
    <span class="s2">&quot;Rb90_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">106901.</span> <span class="p">),</span>
    <span class="s2">&quot;Sr83_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">259151.</span> <span class="p">),</span>    <span class="s2">&quot;Sr85_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">238791.</span> <span class="p">),</span>    <span class="s2">&quot;Sr87_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">388533.</span> <span class="p">),</span>
    <span class="s2">&quot;Y83_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">62047.1</span> <span class="p">),</span>   <span class="s2">&quot;Y85_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">196800.</span> <span class="p">),</span>    <span class="s2">&quot;Y86_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">218211.</span> <span class="p">),</span>        <span class="s2">&quot;Y87_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">380821.</span> <span class="p">),</span>
    <span class="s2">&quot;Y89_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">908971.</span> <span class="p">),</span>    <span class="s2">&quot;Y90_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">681671.</span> <span class="p">),</span>    <span class="s2">&quot;Y91_m1&quot;</span>   <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">555580.</span> <span class="p">),</span>
    <span class="s2">&quot;Zr85_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">292281.</span> <span class="p">),</span>    <span class="s2">&quot;Zr87_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">335841.</span> <span class="p">),</span>    <span class="s2">&quot;Zr89_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">587821.</span> <span class="p">),</span>
    <span class="s2">&quot;Nb90_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">124670.</span> <span class="p">),</span>    <span class="s2">&quot;Nb91_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">104601.</span> <span class="p">),</span>    <span class="s2">&quot;Nb92_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">135501.</span> <span class="p">),</span>        <span class="s2">&quot;Nb93_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">30770.1</span> <span class="p">),</span>
    <span class="s2">&quot;Mo91_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">653011.</span> <span class="p">),</span>
    <span class="s2">&quot;Tc90_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">100000.</span> <span class="p">),</span>    <span class="s2">&quot;Tc91_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">139300.</span> <span class="p">),</span>    <span class="s2">&quot;Tc93_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">391840.</span> <span class="p">),</span>        <span class="s2">&quot;Tc94_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">76000.</span> <span class="p">),</span>
    <span class="s2">&quot;Tc95_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">38900.</span> <span class="p">),</span>    <span class="s2">&quot;Tc96_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mf">34230.</span> <span class="p">),</span>
    <span class="s2">&quot;Bi192_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">147000.</span> <span class="p">),</span>    <span class="s2">&quot;Bi193_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">308000.</span> <span class="p">),</span>    <span class="s2">&quot;Bi194_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">109000.</span> <span class="p">),</span>        <span class="s2">&quot;Bi194_m2&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">200000.</span> <span class="p">),</span>
    <span class="s2">&quot;Bi195_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">401000.</span> <span class="p">),</span>    <span class="s2">&quot;Bi196_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">271000.</span> <span class="p">),</span>    <span class="s2">&quot;Bi197_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">500000.</span> <span class="p">),</span>        <span class="s2">&quot;Bi198_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">100000.</span> <span class="p">),</span>
    <span class="s2">&quot;Bi198_m2&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span>  <span class="mf">248500.</span> <span class="p">),</span>   <span class="s2">&quot;Bi199_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">667000.</span> <span class="p">),</span>    <span class="s2">&quot;Bi200_m1&quot;</span> <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">428200.</span> <span class="p">),</span>        <span class="s2">&quot;Bi201_m1&quot;</span>  <span class="p">:</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">846350.</span> <span class="p">)</span> <span class="p">}</span>

<span class="n">crossSectionAxes</span> <span class="o">=</span> <span class="n">crossSectionModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">multiplicityAxes</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">energyDepositionAxes</span> <span class="o">=</span> <span class="n">energyDepositionModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">angularAxes</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">energyAxes</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">energyAngularAxes</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">angularEnergyAxes</span> <span class="o">=</span> <span class="n">angularEnergyModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">KalbachMann_f_Axes</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">fSubform</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">KalbachMann_r_Axes</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">rSubform</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">KalbachMann_a_Axes</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">aSubform</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>
<span class="n">fissionEnergyReleasedAxes</span> <span class="o">=</span> <span class="n">fissionEnergyReleasedModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span> <span class="n">energyUnit</span> <span class="p">)</span>

<div class="viewcode-block" id="particleZA"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.particleZA">[docs]</a><span class="k">def</span> <span class="nf">particleZA</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">particleID</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">particle</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">PoPs</span><span class="p">[</span><span class="n">particleID</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">miscPoPsModule</span><span class="o">.</span><span class="n">ZA</span><span class="p">(</span> <span class="n">particle</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="myIter"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.myIter">[docs]</a><span class="k">class</span> <span class="nc">myIter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Iterator that keeps track of line number.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span> <span class="n">iterable</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">iterable</span> <span class="p">)</span>

<div class="viewcode-block" id="myIter.next"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.myIter.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">next_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">next_</span></div></div>

<span class="c1"># Two useful shortcuts for reading ENDF data.</span>
<span class="n">funkyF</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span>
<div class="viewcode-block" id="funkyFI"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.funkyFI">[docs]</a><span class="k">def</span> <span class="nf">funkyFI</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="p">)</span> <span class="p">:</span>   <span class="c1"># read ENDF line with 2 floats and 4 ints</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">logFile</span> <span class="p">)</span> <span class="p">)</span></div>

<span class="c1"># create some custom Exceptions:</span>
<div class="viewcode-block" id="BadResonances"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.BadResonances">[docs]</a><span class="k">class</span> <span class="nc">BadResonances</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">)</span> <span class="p">:</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="BadCovariance"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.BadCovariance">[docs]</a><span class="k">class</span> <span class="nc">BadCovariance</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">)</span> <span class="p">:</span> <span class="k">pass</span></div>

<div class="viewcode-block" id="dummyCrossSection"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.dummyCrossSection">[docs]</a><span class="k">class</span> <span class="nc">dummyCrossSection</span> <span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span><span class="p">,</span> <span class="n">unit</span> <span class="p">)</span> <span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__domainMin</span> <span class="o">=</span> <span class="n">domainMin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__domainMax</span> <span class="o">=</span> <span class="n">domainMax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__unit</span> <span class="o">=</span> <span class="n">unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domainMin</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__domainMin</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domainMax</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__domainMax</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domainUnit</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unit</span> <span class="p">)</span></div>

<div class="viewcode-block" id="calculateZA"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.calculateZA">[docs]</a><span class="k">def</span> <span class="nf">calculateZA</span><span class="p">(</span> <span class="n">ZACompound</span><span class="p">,</span> <span class="n">ZAOther</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This function handles the removal (or addition) of ZAOther to ZACompound include natural compound (but not a natural other).&quot;&quot;&quot;</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZACompound</span> <span class="o">%</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZAOther</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ZAOther</span> <span class="o">//</span> <span class="mi">1000</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">minus</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">ZACompound</span> <span class="o">-</span> <span class="n">ZAOther</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">ZACompound</span> <span class="o">+</span> <span class="n">ZAOther</span> <span class="p">)</span></div>

<div class="viewcode-block" id="printAWR_mode"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.printAWR_mode">[docs]</a><span class="k">def</span> <span class="nf">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">AWR_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">AWR_mode</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;AWR_mode:: MT: </span><span class="si">%s</span><span class="s2">: MF: </span><span class="si">%s</span><span class="s2">: ZA: </span><span class="si">%s</span><span class="s2">:  AWR: </span><span class="si">%s</span><span class="s2">::</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="nudgeValue"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.nudgeValue">[docs]</a><span class="k">def</span> <span class="nf">nudgeValue</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">sign</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;FIXME&#39;</span> <span class="p">)</span>
    <span class="n">valueEpsilon</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">epsilonExponent</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">value</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">valueEpsilon</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getCrossSectionForm"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.getCrossSectionForm">[docs]</a><span class="k">def</span> <span class="nf">getCrossSectionForm</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">crossSectionRegions</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">crossSectionAxes</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">crossSectionRegions</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>         <span class="c1"># Store as XYs1d.</span>
        <span class="n">crossSectionForm</span> <span class="o">=</span> <span class="n">crossSectionModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">crossSectionRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> 
                <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">crossSectionRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">crossSectionForm</span> <span class="o">=</span> <span class="n">crossSectionModule</span><span class="o">.</span><span class="n">regions1d</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">crossSectionRegions</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">crossSectionForm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">crossSectionForm</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getMultiplicity"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.getMultiplicity">[docs]</a><span class="k">def</span> <span class="nf">getMultiplicity</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">Ein</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span>   <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span><span class="p">(</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">Ein</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">regionsModule</span><span class="o">.</span><span class="n">regions1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">multiplicity</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">Ein</span> <span class="o">&lt;=</span> <span class="n">region</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">region</span><span class="o">.</span><span class="n">domainMax</span> <span class="o">==</span> <span class="n">EPrior</span> <span class="o">==</span> <span class="n">Ein</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>          <span class="c1"># Next region is the one we want.</span>
                <span class="k">return</span><span class="p">(</span> <span class="n">region</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">Ein</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;unsupported multiplicity form &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span></div>

<div class="viewcode-block" id="uncorrelated"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.uncorrelated">[docs]</a><span class="k">def</span> <span class="nf">uncorrelated</span><span class="p">(</span> <span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">_angularSubform</span> <span class="o">=</span> <span class="n">uncorrelatedModule</span><span class="o">.</span><span class="n">angularSubform</span><span class="p">(</span> <span class="n">angularSubform</span> <span class="p">)</span>
    <span class="n">_energySubform</span> <span class="o">=</span> <span class="n">uncorrelatedModule</span><span class="o">.</span><span class="n">energySubform</span><span class="p">(</span> <span class="n">energySubform</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">uncorrelatedModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">_angularSubform</span><span class="p">,</span> <span class="n">_energySubform</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getMultiplicityPointwiseOrPieceWise"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.getMultiplicityPointwiseOrPieceWise">[docs]</a><span class="k">def</span> <span class="nf">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span>  <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span><span class="p">,</span> 
                <span class="n">interpolation</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span> <span class="p">)</span>
<span class="c1"># BRB : fix me.</span>
<span class="c1">#    elif( ( len( data ) == 2 ) and ( data[0][-1] == data[1][0] ) and</span>
<span class="c1">#            ( data[0].axes[0].interpolation == data[1].axes[0].interpolation ) ) :</span>
<span class="c1">#        xys = data[1].copyDataToXYs( )      # This is a XYs1d data masquerading as regions1d, convert to XYs1d.</span>
<span class="c1">#        xys[0][0] *= ( 1 + FUDGE_EPS )</span>
<span class="c1">#        xys = data[0].copyDataToXYs( ) + xys</span>
<span class="c1">#        multiplicity = multiplicityModule.XYs1d( data = xys, axes = axea )</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">regions1d</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">:</span>
            <span class="n">_region</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">_region</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span>
            <span class="n">multiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">_region</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">multiplicity</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getTotalOrPromptFission"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.getTotalOrPromptFission">[docs]</a><span class="k">def</span> <span class="nf">getTotalOrPromptFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT456Data</span><span class="p">,</span> <span class="n">totalOrPrompt</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LNU</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MT456Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LNU</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LNU</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;     </span><span class="si">%s</span><span class="s1"> fission neutron data: LNU = </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">totalOrPrompt</span><span class="p">,</span> <span class="n">LNU</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LNU</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">polynomial</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MT456Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="n">e6</span>        <span class="c1"># BRB, these need to be set from data</span>
        <span class="n">fissionMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">polynomial</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">polynomial</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> 
                <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span><span class="p">,</span> <span class="n">domainMin</span> <span class="o">=</span> <span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span> <span class="o">=</span> <span class="n">domainMax</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">multiplicityRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MT456Data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">fissionMultiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">multiplicityRegions</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">fissionMultiplicity</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getDelayedFission"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.getDelayedFission">[docs]</a><span class="k">def</span> <span class="nf">getDelayedFission</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT455Data</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;     Delayed fission neutron data (MT=455)&#39;</span> <span class="p">)</span>
    <span class="n">MT455DataMF1</span> <span class="o">=</span> <span class="n">MT455Data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LDG</span><span class="p">,</span> <span class="n">LNU</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MT455DataMF1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LDG</span><span class="p">,</span> <span class="n">LNU</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LDG</span> <span class="p">),</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LNU</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; LDG=</span><span class="si">%s</span><span class="s1"> LNU=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LDG</span><span class="p">,</span> <span class="n">LNU</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LDG</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Only energy-independent delayed fission neutrons are supported&quot;</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LNU</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Only tables of delayed fission neutrons are supported&quot;</span> <span class="p">)</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">decayRateData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MT455DataMF1</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">NNF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">decayRateData</span><span class="p">[</span><span class="s1">&#39;NPL&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">decayRates</span> <span class="o">=</span> <span class="n">decayRateData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">multiplicityRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MT455DataMF1</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">totalDelayedMultiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">multiplicityRegions</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>

    <span class="n">interps</span> <span class="o">=</span> <span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">interpolation</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">multiplicityRegions</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">interps</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Currently only one interpolation flag is supported&quot;</span><span class="p">)</span>
    <span class="n">nubarInterpolation</span> <span class="o">=</span> <span class="n">multiplicityRegions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span>

    <span class="k">if</span><span class="p">(</span> <span class="mi">5</span> <span class="ow">in</span> <span class="n">MT455Data</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">delayedNeutronEnergies</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">readMF5</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">455</span><span class="p">,</span> <span class="n">MT455Data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">delayNeutrons</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
        <span class="n">weightsSum</span> <span class="o">=</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="p">[],</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interpolation</span> <span class="p">)</span>  <span class="c1"># Renormalize weights to sum to 1.</span>
        <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span> <span class="p">:</span> <span class="n">weightsSum</span> <span class="o">=</span> <span class="n">weightsSum</span> <span class="o">+</span> <span class="n">weight</span>
        <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span> <span class="p">:</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">pointwiseXY</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span> <span class="n">weight</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">weightsSum</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">delayedNeutronEnergies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="o">*</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span>
        <span class="n">totalDelayedMultiplicity_</span> <span class="o">=</span> <span class="p">[</span> <span class="n">region</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">multiplicityRegions</span> <span class="p">]</span> 
        <span class="n">nuBar</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">totalDelayedMultiplicity_</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;More than one delayed fission neutron decay time but no MF = 5 data&#39;</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">delayedNeutronEnergies</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;MF1 MT455 claims </span><span class="si">%d</span><span class="s2"> delayed neutron groups, but MF5 MT455 claims </span><span class="si">%d</span><span class="s2"> groups&quot;</span> <span class="o">%</span> \
                <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">),</span> <span class="nb">len</span><span class="p">(</span> <span class="n">delayedNeutronEnergies</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">decayRates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delayedNeutrons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">decayRate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">decayRates</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">energySubform</span> <span class="o">=</span> <span class="n">delayedNeutronEnergies</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">energySubform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
            <span class="n">weightsInterpolation</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">interpolation</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weightsInterpolation</span> <span class="o">==</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">flatToken</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">nubarInterpolation</span> <span class="o">==</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">linlinToken</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">weightsInterpolation</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">linlinToken</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">xy</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">weight</span> <span class="p">],</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">axes</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weightsInterpolation</span> <span class="o">!=</span> <span class="n">nubarInterpolation</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;For total nubar and energy interpolation differ which is currently not supported&#39;</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weightsInterpolation</span> <span class="o">!=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">linlinToken</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;For energy only &quot;lin-lin&quot; interpolation is supported: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">weightsInterpolation</span> <span class="p">)</span>
            <span class="n">totalDelayedM</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">totalDelayedMultiplicity</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">totalDelayedMultiplicity</span><span class="o">.</span><span class="n">domainMax</span> <span class="o">&gt;</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">totalDelayedM</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">totalDelayedMultiplicity</span><span class="o">.</span><span class="n">domainSlice</span><span class="p">(</span> <span class="n">domainMax</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMax</span> <span class="o">&gt;</span> <span class="n">totalDelayedM</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span> <span class="p">:</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainSlice</span><span class="p">(</span> <span class="n">domainMax</span> <span class="o">=</span> <span class="n">totalDelayedM</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainMin</span> <span class="o">&lt;</span> <span class="n">totalDelayedM</span><span class="o">.</span><span class="n">domainMin</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">domainSlice</span><span class="p">(</span> <span class="n">domainMin</span> <span class="o">=</span> <span class="n">totalDelayedM</span><span class="o">.</span><span class="n">domainMin</span> <span class="p">)</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">totalDelayedM</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">nuBar</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="p">[</span> <span class="n">multiplicity</span> <span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>

        <span class="n">particle</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">nuBar</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">nuBar</span> <span class="p">)</span>
        <span class="n">particle</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;emissionMode&#39;</span><span class="p">,</span> <span class="n">tokensModule</span><span class="o">.</span><span class="n">delayedToken</span> <span class="p">)</span>
        <span class="n">particle</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;decayRate&#39;</span><span class="p">,</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">PQU</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">decayRate</span> <span class="p">),</span> <span class="s2">&quot;1/s&quot;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">energySubform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="n">delayedNeutrons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">particle</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">delayedNeutrons</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getFissionEnergies"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.getFissionEnergies">[docs]</a><span class="k">def</span> <span class="nf">getFissionEnergies</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For NPLY = 0 this data consists of pairs ( energy, standard deviation ).  The energies are:</span>
<span class="sd">    EFR: kinetic energy of all fission fragments</span>
<span class="sd">    ENP: energy of prompt fission neutrons</span>
<span class="sd">    END: energy of delayed fission neutrons</span>
<span class="sd">    EGP: energy of prompt fission gammas</span>
<span class="sd">    EGD: energy of delayed fission gammas</span>
<span class="sd">    EB: energy of delayed fission betas</span>
<span class="sd">    ENU: energy of fission neutrinos</span>
<span class="sd">    ER: EFR + ENP + END + EGP + EGD + EB, fission Q minus the neutrinos</span>
<span class="sd">    ET: ER + ENU, total fission Q</span>
<span class="sd">    For NPLY &gt; 0 the fission energies are polynomials of degree NPLY in the incident energy,</span>
<span class="sd">    and the structure of the above table is repeated, once for each polynomial coefficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MF1Data</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">fissionEnergyReleaseData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dataLine</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF1Data</span><span class="p">[</span><span class="n">dataLine</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>

    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NPLY</span><span class="p">,</span> <span class="n">N1</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF1Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">N2</span> <span class="o">!=</span> <span class="p">(</span><span class="n">NPLY</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">9</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">N1</span> <span class="o">!=</span> <span class="n">N2</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Inconsistent N1/N2/NPLY in section MF=1 MT=458!&quot;</span> <span class="p">)</span>
    <span class="n">nCoeffs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">N2</span> <span class="p">)</span> <span class="c1"># total number of coefficients for all energy release components (each also has an uncertainty)</span>

    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">nFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">nCoeffs</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF1Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

    <span class="n">FERterms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">monikers</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;promptProductKE&#39;</span><span class="p">,</span><span class="s1">&#39;promptNeutronKE&#39;</span><span class="p">,</span><span class="s1">&#39;delayedNeutronKE&#39;</span><span class="p">,</span><span class="s1">&#39;promptGammaEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;delayedGammaEnergy&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;delayedBetaEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;neutrinoEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;nonNeutrinoEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;totalEnergy&#39;</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">moniker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">monikers</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">coeffs</span><span class="p">,</span> <span class="n">uncerts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">energies</span><span class="p">[</span><span class="n">idx</span><span class="p">::</span><span class="mi">9</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">poly1d</span> <span class="o">=</span> <span class="n">fissionEnergyReleasedModule</span><span class="o">.</span><span class="n">polynomial1d</span><span class="p">(</span> <span class="n">coefficients</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
            <span class="n">domainMin</span><span class="o">=</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span><span class="o">=</span><span class="n">domainMax</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">fissionEnergyReleasedAxes</span><span class="p">,</span>
            <span class="n">coefficientUncertainties</span><span class="o">=</span><span class="n">uncerts</span> <span class="p">)</span>

        <span class="n">Class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span> <span class="n">fissionEnergyReleasedModule</span><span class="p">,</span> <span class="n">moniker</span> <span class="p">)</span>
        <span class="n">FERterms</span><span class="p">[</span> <span class="n">moniker</span> <span class="p">]</span> <span class="o">=</span> <span class="n">Class</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="n">poly1d</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">fissionEnergyReleasedModule</span><span class="o">.</span><span class="n">fissionEnergyReleased</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="o">**</span><span class="n">FERterms</span> <span class="p">)</span></div>

<div class="viewcode-block" id="angularLegendrePiecewiseToPointwiseIfPossible"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.angularLegendrePiecewiseToPointwiseIfPossible">[docs]</a><span class="k">def</span> <span class="nf">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">piecewiseForm</span> <span class="p">)</span>
    <span class="n">pointwise</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">piecewiseForm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">pointwise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">series</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">pointwise</span> <span class="p">)</span></div>

<div class="viewcode-block" id="angularLegendreToPointwiseOrPiecewiseLegendre"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.angularLegendreToPointwiseOrPiecewiseLegendre">[docs]</a><span class="k">def</span> <span class="nf">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">subformPointwise</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># list of regions.</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">priorEnergy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">lists</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">]</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">interpolationFlag</span> <span class="ow">in</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Unsupported interpolation = </span><span class="si">%s</span><span class="s1"> for MF=</span><span class="si">%s</span><span class="s1">, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">interpolationFlag</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationEin</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">)</span>
            <span class="n">region</span> <span class="o">=</span> <span class="p">[</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationEin</span><span class="p">,</span> <span class="p">[]</span> <span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">i1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">lists</span><span class="p">[</span><span class="n">i1</span><span class="p">][</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastRegion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">lastRegion</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i3</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">lists</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="s1">&#39;C2&#39;</span><span class="p">],</span> <span class="p">[</span> <span class="mf">1.0</span> <span class="p">]</span> <span class="o">+</span> <span class="n">lists</span><span class="p">[</span><span class="n">i3</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">priorEnergy</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">==</span> <span class="n">lastRegion</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="p">[</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationEin</span><span class="p">,</span> <span class="p">[]</span> <span class="p">]</span>
                <span class="n">lastRegion</span> <span class="o">=</span> <span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="p">)</span>
                <span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">lastRegion</span> <span class="p">)</span>
                <span class="n">priorEnergy</span> <span class="o">=</span> <span class="n">energy</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i2</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;ValueError occurred when constructing LegendreSeries: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span> <span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">regions</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">subformPointwise</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationEin</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subformLegendre</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationEin</span><span class="p">,</span>
                <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">subformLegendre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span><span class="p">,</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">subformLegendre</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">regionInfo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">regions</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationEin</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">regionInfo</span>
            <span class="n">LegendreRegion</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationEin</span><span class="p">,</span>
                    <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">LegendreRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span><span class="p">,</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">subformLegendre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">LegendreRegion</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">subformPointwise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">subformPointwise</span><span class="p">,</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="s1">&#39;hell - need to implement this&#39;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">subformPointwise</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                    <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">subformPointwise</span><span class="o">.</span><span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">subformPointwise</span> <span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>
                <span class="n">subformLegendre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">subformLegendre</span> <span class="p">)</span></div>

<div class="viewcode-block" id="convertNuclearPlusInterferenceDataToPiecewise"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.convertNuclearPlusInterferenceDataToPiecewise">[docs]</a><span class="k">def</span> <span class="nf">convertNuclearPlusInterferenceDataToPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">identicalParticles</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return three terms (nuclear + real/imaginary interference). These in turn contain</span>
<span class="sd">    Legendre expansions at various incident energies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span>
    <span class="n">nuclear</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
    <span class="n">interferenceReal</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
    <span class="n">interferenceImaginary</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">lastRegion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">lists</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">end</span><span class="p">,</span> <span class="n">interpolationFlag</span> <span class="ow">in</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationE_in</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">interpolationFlag</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Unsupported interpolation = </span><span class="si">%s</span><span class="s1"> for MF=</span><span class="si">%s</span><span class="s1">, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">interpolationFlag</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c1">#interpolationE_in, interpolationCl, interpolationQualifier = endfFileToGNDMiscModule.ENDFInterpolationToGNDAxes3plusd( interpolationFlag )</span>
        <span class="n">region_Nuc</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationE_in</span> <span class="p">)</span>
        <span class="n">region_IntReal</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationE_in</span> <span class="p">)</span>
        <span class="n">region_IntImaginary</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationE_in</span> <span class="p">)</span>
        <span class="n">priorEnergy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">lastRegion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">lists</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastRegion</span> <span class="p">)</span> <span class="p">:</span> <span class="c1"># ensure no gaps between regions</span>
                <span class="n">region_Nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">nuclear_term</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">region_IntReal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">interference_termReal</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">region_IntImaginary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">interference_termImaginary</span><span class="p">,</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">lastRegion</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="p">)</span> <span class="p">:</span>
            <span class="nb">list</span> <span class="o">=</span> <span class="n">lists</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">priorEnergy</span> <span class="p">)</span> <span class="p">:</span>                           <span class="c1"># This fixes a problem with some data having two same energy values.</span>
                <span class="n">energy</span> <span class="o">+=</span> <span class="n">FUDGE_EPS</span> <span class="o">*</span> <span class="n">energy</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;same energies, second one being incremented for MT = </span><span class="si">%d</span><span class="s1">, MF = </span><span class="si">%d</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">msg</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">priorEnergy</span> <span class="o">=</span> <span class="n">energy</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">identicalParticles</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">splitPoint</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;N2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">splitPoint</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;N2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">nuclear_term</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:</span><span class="n">splitPoint</span><span class="p">]</span>
            <span class="n">interference_term</span><span class="p">,</span> <span class="n">interference_termReal</span><span class="p">,</span> <span class="n">interference_termImaginary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">splitPoint</span><span class="p">:],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">interference_term</span> <span class="p">),</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">interference_termReal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">interference_term</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">interference_termImaginary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">interference_term</span><span class="p">[</span><span class="n">jdx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">region_Nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">nuclear_term</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">region_IntReal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">interference_termReal</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">region_IntImaginary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">interference_termImaginary</span><span class="p">,</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">lastRegion</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">nuclear</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_Nuc</span>
        <span class="n">interferenceReal</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_IntReal</span>
        <span class="n">interferenceImaginary</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_IntImaginary</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">nuclear</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">nuclearTerm</span><span class="p">(</span> <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">nuclear</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">interferenceReal</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">realInterferenceTerm</span><span class="p">(</span> 
            <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">interferenceReal</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">interferenceImaginary</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">imaginaryInterferenceTerm</span><span class="p">(</span>
            <span class="n">angularLegendrePiecewiseToPointwiseIfPossible</span><span class="p">(</span> <span class="n">interferenceImaginary</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">nuclear</span><span class="p">,</span> <span class="n">interferenceReal</span><span class="p">,</span> <span class="n">interferenceImaginary</span> <span class="p">)</span></div>

<div class="viewcode-block" id="convertAngularToPointwiseOrPiecewiseFromTAB2_TAB1"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.convertAngularToPointwiseOrPiecewiseFromTAB2_TAB1">[docs]</a><span class="k">def</span> <span class="nf">convertAngularToPointwiseOrPiecewiseFromTAB2_TAB1</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularTAB1</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">angularData</span> <span class="o">=</span> <span class="n">angularTAB1</span><span class="p">[</span><span class="s1">&#39;TAB2s&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">angularData</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">interplation</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>      <span class="c1"># BRB: need to check interpolation?</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">xys</span> <span class="ow">in</span> <span class="n">angularData</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">xys</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - need to support this&#39;</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">xys</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">xys</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">xys</span><span class="o">.</span><span class="n">value</span> <span class="p">)</span>
            <span class="n">subform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xys</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="s1">&#39;hell - regions2d tabulated angular not currently supported&#39;</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span></div>

<div class="viewcode-block" id="convertAngularToPointwiseOrPiecewiseFromTAB2_List"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.convertAngularToPointwiseOrPiecewiseFromTAB2_List">[docs]</a><span class="k">def</span> <span class="nf">convertAngularToPointwiseOrPiecewiseFromTAB2_List</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">angularList</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Like convertAngularToPointwiseOrPiecewiseFromTAB2_TAB1 except mu,P given as LISTs instead of TAB1s.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">angularData</span> <span class="o">=</span> <span class="n">angularList</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">]</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">12</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}[</span><span class="n">LANG</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;interpolation = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">interpolation</span>
        <span class="k">raise</span> <span class="s1">&#39;hell - what is this and how does it differ from 12&#39;</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND1d</span><span class="p">(</span> <span class="n">interpolation</span> <span class="p">)</span>
    <span class="n">subform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
    <span class="n">e_in_Prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="nb">list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">angularData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">LANG_e_in</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LANG_e_in</span> <span class="o">!=</span> <span class="n">LANG_e_in</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - need to implement this&#39;</span>
        <span class="n">e_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">e_in</span> <span class="o">==</span> <span class="n">e_in_Prior</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - need to implement this&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">526</span> <span class="p">)</span> <span class="p">:</span>        <span class="c1"># Some MT 526 have data like &#39;0.999998+0 2.046010+5 0.999998+0 2.870580+5&#39; which this fixes.</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">j3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">),</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">j2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="n">j2</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="n">j3</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">j2</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="n">j2</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">dataForm</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span><span class="p">,</span> 
                <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e_in</span> <span class="p">)</span>
        <span class="n">subform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xys</span> <span class="p">)</span>
        <span class="n">e_in_Prior</span> <span class="o">=</span> <span class="n">e_in</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span></div>

<div class="viewcode-block" id="toPointwiseOrPiecewiseEnergy"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.toPointwiseOrPiecewiseEnergy">[docs]</a><span class="k">def</span> <span class="nf">toPointwiseOrPiecewiseEnergy</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">TAB2</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">def</span> <span class="nf">getEpP</span><span class="p">(</span> <span class="n">energyPrior</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">EpP</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">EpP</span><span class="o">.</span><span class="n">value</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">EpP</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">EpP</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">EpP</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">EpP</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">regions1d</span><span class="p">(</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">:</span>
                <span class="n">EpP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">datum</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">datum</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span><span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">EpP</span> <span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">TAB2</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">interpolation</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">TAB2</span><span class="p">[</span><span class="s1">&#39;TAB2s&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">interpolation</span> <span class="p">)</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
        <span class="n">subformRegion</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> 
                <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
        <span class="n">energyPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">EpP</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">:</span>
            <span class="n">EIn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">EpP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">EIn</span> <span class="o">==</span> <span class="n">energyPrior</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">subformRegion</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">subform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">subformRegion</span> <span class="p">)</span>
                <span class="n">subformRegion</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
                <span class="n">energyPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">energyPrior</span><span class="p">,</span> <span class="n">EpPp</span> <span class="o">=</span> <span class="n">getEpP</span><span class="p">(</span> <span class="n">energyPrior</span><span class="p">,</span> <span class="n">EpP</span> <span class="p">)</span>
            <span class="n">subformRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EpPp</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">subformRegion</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">subform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">subformRegion</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
        <span class="n">TAB2s</span> <span class="o">=</span> <span class="n">TAB2</span><span class="p">[</span><span class="s1">&#39;TAB2s&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="p">(</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">TAB1s</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">TAB2s</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">interpolation</span> <span class="p">)</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
            <span class="n">energyPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">EpP</span> <span class="ow">in</span> <span class="n">TAB1s</span> <span class="p">:</span>
                <span class="n">energyPrior</span><span class="p">,</span> <span class="n">EpPp</span> <span class="o">=</span> <span class="n">getEpP</span><span class="p">(</span> <span class="n">energyPrior</span><span class="p">,</span> <span class="n">EpP</span> <span class="p">)</span>
                <span class="n">region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EpPp</span> <span class="p">)</span>
            <span class="n">subform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span></div>

<div class="viewcode-block" id="discreteOrPrimaryGamma"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.discreteOrPrimaryGamma">[docs]</a><span class="k">def</span> <span class="nf">discreteOrPrimaryGamma</span><span class="p">(</span> <span class="n">cls</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">energySubform</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">domainMin</span><span class="p">,</span> <span class="n">domainMax</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">energySubform</span> <span class="p">)</span></div>

<div class="viewcode-block" id="translateENDFJpi"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.translateENDFJpi">[docs]</a><span class="k">def</span> <span class="nf">translateENDFJpi</span><span class="p">(</span> <span class="n">I</span><span class="p">,</span> <span class="n">P</span> <span class="p">):</span>
    <span class="c1"># endf uses weird convention for Jpi. Translate to simpler version:</span>
    <span class="n">spin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">I</span><span class="p">:</span> <span class="n">parity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">/</span> <span class="n">I</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">parity</span> <span class="o">=</span> <span class="n">P</span> <span class="ow">or</span> <span class="mi">1</span>  <span class="c1"># if (I,P)=(0,0) treat as &#39;0+&#39;</span>
    <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">spin</span><span class="p">),</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">parity</span><span class="p">(</span><span class="n">parity</span><span class="p">)</span></div>


<div class="viewcode-block" id="readMF2"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF2">[docs]</a><span class="k">def</span> <span class="nf">readMF2</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF2</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse MF2 into resonances class (and sub-classes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xData</span> <span class="k">import</span> <span class="n">table</span> <span class="k">as</span> <span class="n">tableModule</span>

    <span class="c1"># store MT #s for all reactions that need to include resonance data:</span>
    <span class="n">resonanceMTs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># check for inconsistent spins</span>
    <span class="n">targetSpins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">readResonanceSection</span><span class="p">(</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span><span class="p">,</span> <span class="n">NRO</span><span class="p">,</span> <span class="n">NAPS</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function, read in resonance info for one energy range.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">NRO</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># energy-dependent scattering radius</span>
            <span class="k">if</span> <span class="n">NAPS</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;NAPS=2 option not yet supported!&quot;</span><span class="p">)</span>
            <span class="n">line1</span> <span class="o">=</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NR</span><span class="p">,</span> <span class="n">NP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">line1</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">nLines</span> <span class="o">=</span> <span class="n">NR</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="n">NR</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span>  <span class="o">+</span>  <span class="n">NP</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="n">NP</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLines</span><span class="p">)]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">labelsUnits</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;energy_in&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">),</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;10*fm&#39;</span> <span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;multi-region scattering radius&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">convertAxisToUnit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;fm&#39;</span><span class="p">)</span>
            <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># scattering radius only. Note AP given in 10*fm</span>
            <span class="n">SPI</span><span class="p">,</span> <span class="n">AP</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NLS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">targetSpins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">SPI</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span> <span class="c1"># no parity information</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">labelsUnits</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;energy_in&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">),</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;fm&#39;</span> <span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
            <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span>
                <span class="n">constantModule</span><span class="o">.</span><span class="n">constant1d</span><span class="p">(</span> <span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">domainMin</span><span class="o">=</span><span class="n">EL</span><span class="p">,</span> <span class="n">domainMax</span><span class="o">=</span><span class="n">EH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">scatRadius</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>   <span class="c1">#SLBW or MLBW form</span>
            <span class="n">SPI</span><span class="p">,</span> <span class="n">AP</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NLS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">targetSpins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">SPI</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">NRO</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span>
                        <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;fm&quot;</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">resList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">negativeJs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                <span class="n">AWRI</span><span class="p">,</span> <span class="n">QX</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">LRX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NRS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s2">&quot;incorrect values in resonance section line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                    <span class="n">e</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gtot</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">negativeJs</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gtot</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">negativeJs</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;Encountered negative J-values for SLBW/MLBW&quot;</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;totalWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;neutronWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;captureWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">6</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fissionWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span> <span class="p">],</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span><span class="p">(</span><span class="n">res</span><span class="p">):</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>   <span class="c1"># sort by energy only</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;totalWidth&quot;</span><span class="p">,</span><span class="s2">&quot;fissionWidth&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span> <span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="p">):</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">SLBW</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span>
                        <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">MLBW</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span>
                        <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>     <span class="c1"># Reich-Moore form, convert it to look like LRF=7</span>
            <span class="n">ENDFconversionFlags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LRF3&#39;</span><span class="p">]</span>
            <span class="n">SPI</span><span class="p">,</span> <span class="n">AP</span><span class="p">,</span> <span class="n">LAD</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NLS</span><span class="p">,</span> <span class="n">NLSC</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">NLSC</span><span class="p">:</span>
                <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LvaluesNeededForConvergence=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">NLSC</span><span class="p">)</span>
            <span class="n">targetSpins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">SPI</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span> <span class="c1"># store spin in GND particle list</span>
            <span class="k">assert</span> <span class="n">NRO</span><span class="o">==</span><span class="mi">0</span>
            <span class="n">resDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">LdependentAP</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">haveFission</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                <span class="n">AWRI</span><span class="p">,</span> <span class="n">APL</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NRS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;incorrect values in resonance section line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">APL</span><span class="p">:</span>
                    <span class="n">LdependentAP</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">APL</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                    <span class="n">e</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gf1</span><span class="p">,</span><span class="n">gf2</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">gf1</span> <span class="ow">or</span> <span class="n">gf2</span><span class="p">):</span> <span class="n">haveFission</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">channelSpin</span> <span class="o">=</span> <span class="n">SPI</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">SPI</span><span class="o">-</span><span class="n">L</span><span class="o">==</span><span class="mf">0.5</span><span class="p">:</span>
                            <span class="n">channelSpin</span> <span class="o">=</span> <span class="n">SPI</span><span class="o">-</span><span class="mf">0.5</span>
                        <span class="k">elif</span> <span class="n">SPI</span><span class="o">-</span><span class="n">L</span><span class="o">==-</span><span class="mf">0.5</span><span class="p">:</span>
                            <span class="n">channelSpin</span> <span class="o">=</span> <span class="n">SPI</span><span class="o">+</span><span class="mf">0.5</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
                    <span class="n">resDict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">L</span><span class="p">,{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">j</span><span class="p">),{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">channelSpin</span><span class="p">,[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">e</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">gn</span><span class="p">,</span><span class="n">gf1</span><span class="p">,</span><span class="n">gf2</span><span class="p">]</span> <span class="p">)</span>

                <span class="n">gsum</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">targetGSum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">SPI</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="n">resDict</span><span class="p">[</span><span class="n">L</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="n">resDict</span><span class="p">[</span><span class="n">L</span><span class="p">][</span><span class="n">J</span><span class="p">]:</span>
                        <span class="n">gsum</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gsum</span> <span class="o">&lt;</span> <span class="n">targetGSum</span><span class="p">:</span>  <span class="c1"># add extra spin groups (with no resonances) for potential scattering:</span>
                    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SPI</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">SPI</span><span class="o">+</span><span class="mf">0.5</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">J</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">S</span><span class="p">)</span>
                        <span class="n">jmax</span> <span class="o">=</span> <span class="n">L</span> <span class="o">+</span> <span class="n">S</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">jdict</span> <span class="o">=</span> <span class="n">resDict</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">J</span><span class="p">,{})</span>
                            <span class="k">if</span> <span class="n">S</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jdict</span><span class="p">:</span>
                                <span class="n">jdict</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">gsum</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">J</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">J</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">J</span> <span class="o">&gt;</span> <span class="n">jmax</span><span class="p">:</span> <span class="k">break</span>
                    <span class="k">if</span> <span class="n">gsum</span> <span class="o">!=</span> <span class="n">targetGSum</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Method to fix missing gfactor failed! gsum should be </span><span class="si">%f</span><span class="s2">, is </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
                                          <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">gsum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">SPI</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">LdependentAP</span><span class="p">:</span>
                <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;explicitAPL&#39;</span><span class="p">)</span>

            <span class="n">resonanceReactions</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceReactions</span><span class="p">()</span>
            <span class="n">mts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">haveFission</span><span class="p">:</span> <span class="n">mts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">18</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">mts</span><span class="p">:</span>
                <span class="n">gndChannel</span><span class="p">,</span> <span class="o">=</span> <span class="p">[</span><span class="n">chan</span> <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">ENDF_MT</span> <span class="o">==</span> <span class="n">MT</span><span class="p">]</span>
                <span class="n">eliminated</span> <span class="o">=</span> <span class="p">(</span><span class="n">MT</span><span class="o">==</span><span class="mi">102</span><span class="p">)</span>
                <span class="n">ejectile</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span> <span class="k">if</span> <span class="n">MT</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="n">reactionLink</span> <span class="o">=</span> <span class="n">linkModule</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">gndChannel</span><span class="p">)</span>
                <span class="n">resonanceReactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceReaction</span><span class="p">(</span> <span class="n">label</span><span class="o">=</span><span class="n">gndChannel</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">reactionLink</span><span class="o">=</span><span class="n">reactionLink</span><span class="p">,</span>
                            <span class="n">ejectile</span><span class="o">=</span><span class="n">ejectile</span><span class="p">,</span> <span class="n">computeShiftFactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eliminated</span><span class="o">=</span><span class="n">eliminated</span><span class="p">,</span>
                            <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span>
                                <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;fm&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">scatRadiusForm</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;fm&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
            <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">scatRadiusForm</span> <span class="p">)</span>

            <span class="n">columnHeaders</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;capture width&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;elastic width&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fission width_1&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">),</span>
                <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fission width_2&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="n">jdx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">spinGroups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resDict</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">channelSpin</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resDict</span><span class="p">[</span><span class="n">L</span><span class="p">][</span><span class="n">J</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columnHeaders</span><span class="p">[:],</span> <span class="n">data</span><span class="o">=</span><span class="n">resDict</span><span class="p">[</span><span class="n">L</span><span class="p">][</span><span class="n">J</span><span class="p">][</span><span class="n">channelSpin</span><span class="p">])</span>

                        <span class="n">channels</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channels</span><span class="p">()</span>
                        <span class="n">channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">resonanceReactions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">columnIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">L</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channelSpin</span><span class="o">=</span><span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">)</span>    <span class="c1"># capture</span>
                        <span class="n">channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">resonanceReactions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">columnIndex</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">L</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">L</span><span class="p">),</span> <span class="n">channelSpin</span><span class="o">=</span><span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">channelSpin</span><span class="p">))</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">LdependentAP</span> <span class="ow">and</span> <span class="n">LdependentAP</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">!=</span> <span class="n">AP</span><span class="p">:</span>
                            <span class="n">APL</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">LdependentAP</span><span class="p">[</span><span class="n">L</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;fm&quot;</span> <span class="p">)</span>
                            <span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span> <span class="n">APL</span> <span class="p">)</span>
                            <span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hardSphereRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">hardSphereRadius</span><span class="p">(</span> <span class="n">APL</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">haveFission</span><span class="p">:</span>
                            <span class="n">channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">resonanceReactions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">columnIndex</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channelSpin</span><span class="o">=</span><span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;fission width_2&#39;</span><span class="p">)</span> <span class="p">):</span>
                                <span class="n">channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">resonanceReactions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">columnIndex</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channelSpin</span><span class="o">=</span><span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">table</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="s1">&#39;fission width_2&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="s1">&#39;fission width_2&#39;</span><span class="p">)</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="s1">&#39;fission width_1&#39;</span><span class="p">)</span>

                        <span class="n">spinGroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spinGroup</span><span class="p">(</span><span class="n">jdx</span><span class="p">,</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">J</span><span class="p">)),</span>
                                <span class="n">resonancesModule</span><span class="o">.</span><span class="n">parity</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">channels</span><span class="p">,</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="p">(</span><span class="n">table</span><span class="p">))</span> <span class="p">)</span>
                        <span class="n">jdx</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">RMatrix</span><span class="p">(</span> <span class="n">resonanceReactions</span><span class="p">,</span> <span class="n">spinGroups</span><span class="p">,</span> <span class="n">approximation</span><span class="o">=</span><span class="s2">&quot;Reich_Moore&quot;</span><span class="p">,</span>
                    <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">),</span> <span class="n">reconstructAngular</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">LAD</span><span class="p">),</span>
                    <span class="n">LvaluesNeededForConvergence</span><span class="o">=</span><span class="n">NLSC</span><span class="p">,</span> <span class="n">relativisticKinematics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">reducedWidthAmplitudes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boundaryCondition</span><span class="o">=</span><span class="s2">&quot;S&quot;</span><span class="p">,</span>
                    <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ENDFconversionFlags</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>     <span class="c1"># Adler-Adler, not currently supported</span>
            <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s2">&quot;Adler-Adler resonance formalism not yet supported!&quot;</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>     <span class="c1"># R-Matrix Limited</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">IFG</span><span class="p">,</span><span class="n">KRM</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">KRL</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">KRM</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">approximation</span> <span class="o">=</span> <span class="s1">&#39;Reich_Moore&#39;</span>
            <span class="k">elif</span> <span class="n">KRM</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">approximation</span> <span class="o">=</span> <span class="s1">&#39;Full R-Matrix&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s2">&quot;R-Matrix with KRM=</span><span class="si">%d</span><span class="s2"> not yet implemented!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">KRM</span> <span class="p">)</span>

            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NPP</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp1</span><span class="p">,</span><span class="n">tmp2</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp1</span><span class="o">!=</span><span class="mi">12</span><span class="o">*</span><span class="n">NPP</span> <span class="ow">or</span> <span class="n">tmp2</span><span class="o">!=</span><span class="mi">2</span><span class="o">*</span><span class="n">NPP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s2">&quot;incorrect LRF7 header!&quot;</span> <span class="p">)</span>

            <span class="c1"># some helper functions:</span>
            <span class="k">def</span> <span class="nf">getOutgoingParticles</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">targZA</span><span class="p">,</span> <span class="n">projZA</span> <span class="p">):</span>
                <span class="n">reacStr</span> <span class="o">=</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">ENDF_MTZAEquation</span><span class="p">(</span><span class="n">projZA</span><span class="p">,</span><span class="n">targZA</span><span class="p">,</span> <span class="n">MT</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">outgoing</span> <span class="o">=</span> <span class="n">reacStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">pA</span><span class="p">,</span> <span class="n">pB</span> <span class="o">=</span> <span class="n">outgoing</span><span class="o">.</span><span class="n">split</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">pA</span><span class="p">,</span> <span class="n">pB</span>


            <span class="c1"># ENDF R-Matrix starts by listing outgoing particle pairs</span>
            <span class="c1"># these are referred back to later on:</span>
            <span class="n">resonanceReactions</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceReactions</span><span class="p">()</span>
            <span class="n">PNTs</span><span class="p">,</span> <span class="n">SHFs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPP</span><span class="p">):</span>
                <span class="n">MA</span><span class="p">,</span> <span class="n">MB</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">ZB</span><span class="p">,</span> <span class="n">IA</span><span class="p">,</span> <span class="n">IB</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">Q</span><span class="p">,</span> <span class="n">PNT</span><span class="p">,</span> <span class="n">SHF</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">PB</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="n">MT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
                <span class="n">resonanceMTs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span>
                <span class="n">PNTs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">PNT</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">SHF</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> <span class="n">SHF</span><span class="o">=</span><span class="mi">0</span>   <span class="c1"># format changed between ENDF-5 and -6, some evaluations still have old version</span>
                <span class="n">SHFs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">SHF</span> <span class="p">)</span>

                <span class="c1"># identify the channel using ZA and MT:</span>
                <span class="n">pA</span><span class="p">,</span><span class="n">pB</span> <span class="o">=</span> <span class="n">getOutgoingParticles</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZAM</span> <span class="p">),</span> <span class="n">info</span><span class="o">.</span><span class="n">projectileZA</span> <span class="p">)</span>
                <span class="c1"># get target spin. In future, this should already be present in particle list</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="n">pA</span><span class="p">]</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">IA</span><span class="p">,</span><span class="n">PA</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">MT</span> <span class="o">!=</span> <span class="mi">102</span><span class="p">:</span>   <span class="c1"># spin/parity of 2nd particle are always 0 for capture in ENDF</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="n">pB</span><span class="p">]</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">IB</span><span class="p">,</span><span class="n">PB</span><span class="p">)</span>

                <span class="c1"># note: ZA and ZB in ENDF are charges, not ZA numbers. Compute ZA and add to particle mass dictionary:</span>
                <span class="n">ZA_A</span><span class="p">,</span> <span class="n">ZA_B</span> <span class="o">=</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">ENDF_MTZAEquation</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ZAM</span><span class="p">),</span><span class="n">info</span><span class="o">.</span><span class="n">projectileZA</span><span class="p">,</span> <span class="n">MT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ZA_A</span> <span class="o">&gt;</span> <span class="n">ZA_B</span><span class="p">:</span> <span class="n">ZA_A</span><span class="p">,</span> <span class="n">ZA_B</span> <span class="o">=</span> <span class="n">ZA_B</span><span class="p">,</span> <span class="n">ZA_A</span>
                <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span><span class="n">ZA_A</span><span class="p">,</span> <span class="n">MA</span><span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span><span class="n">ZA_B</span><span class="p">,</span> <span class="n">MB</span><span class="p">)</span>

                <span class="n">channelName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pA</span><span class="p">,</span><span class="n">pB</span><span class="p">)</span>
                <span class="n">gndChannel</span><span class="p">,</span> <span class="o">=</span> <span class="p">[</span><span class="n">chan</span> <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">ENDF_MT</span> <span class="o">==</span> <span class="n">MT</span><span class="p">]</span>

                <span class="n">Qval</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">eliminated</span> <span class="o">=</span> <span class="p">(</span><span class="n">KRM</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">MT</span><span class="o">==</span><span class="mi">102</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Q</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">gndChannel</span><span class="o">.</span><span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">constant</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">gndChannel</span><span class="o">.</span><span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">constant</span> <span class="o">!=</span> <span class="n">Q</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Resonance region Q-value doesn&#39;t match the rest of the evaluation&quot;</span><span class="p">)</span>
                    <span class="n">Qval</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span> <span class="n">Q</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>

                <span class="n">reactionLink</span> <span class="o">=</span> <span class="n">linkModule</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">gndChannel</span><span class="p">)</span>
                <span class="n">resonanceReactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceReaction</span><span class="p">(</span> <span class="n">label</span><span class="o">=</span><span class="n">channelName</span><span class="p">,</span> <span class="n">reactionLink</span><span class="o">=</span><span class="n">reactionLink</span><span class="p">,</span>
                            <span class="n">ejectile</span><span class="o">=</span><span class="n">pA</span><span class="p">,</span> <span class="n">computeShiftFactor</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">SHF</span><span class="p">),</span> <span class="n">Q</span><span class="o">=</span><span class="n">Qval</span><span class="p">,</span> <span class="n">eliminated</span><span class="o">=</span><span class="n">eliminated</span> <span class="p">)</span> <span class="p">)</span>


            <span class="c1"># next we have NJS spin groups, each containing channels and resonances</span>
            <span class="n">spinGroups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">boundaryConditions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spinGroupIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                <span class="c1"># read scattering radius, binding, etc:</span>
                <span class="n">AJ</span><span class="p">,</span> <span class="n">PJ</span><span class="p">,</span> <span class="n">KBK</span><span class="p">,</span> <span class="n">KPS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NCH</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NCH</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;incorrect LRF7 header, line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channels</span><span class="p">()</span>
                <span class="n">columnHeaders</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span> <span class="p">]</span>
                <span class="n">channelNames</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
                    <span class="n">IPP</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">SCH</span><span class="p">,</span> <span class="n">BND</span><span class="p">,</span> <span class="n">APE</span><span class="p">,</span> <span class="n">APT</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">thisChannel</span> <span class="o">=</span> <span class="n">resonanceReactions</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">IPP</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">BC</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">BND</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">L</span><span class="p">):</span>
                        <span class="n">BC</span> <span class="o">=</span> <span class="n">BND</span>
                    <span class="n">channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">thisChannel</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">columnIndex</span><span class="o">=</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">L</span><span class="p">),</span>
                            <span class="n">channelSpin</span><span class="o">=</span><span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SCH</span><span class="p">),</span> <span class="n">boundaryConditionOverride</span> <span class="o">=</span> <span class="n">BC</span><span class="p">)</span> <span class="p">)</span>

                    <span class="n">channelName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> width&quot;</span> <span class="o">%</span> <span class="n">thisChannel</span><span class="o">.</span><span class="n">label</span>
                    <span class="n">jdx</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">channelName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channelNames</span><span class="p">:</span>
                            <span class="n">channelNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">channelName</span> <span class="p">);</span> <span class="k">break</span>
                        <span class="n">channelName</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> width_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thisChannel</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">jdx</span><span class="p">)</span>
                        <span class="n">jdx</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">radii</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">thisChannel</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">APT</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">APE</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">boundaryConditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">BND</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">columnHeaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">channelName</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span> <span class="p">)</span>

                <span class="c1"># resonances for this J:</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NRS</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NX</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NX</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;incorrect LRF7 header, line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">NRS</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>   <span class="c1"># skip empty line</span>
                <span class="n">resonances</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="p">(</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">6.0</span> <span class="p">))</span> <span class="c1"># Extra &quot;1&quot; is for the Eres column</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                        <span class="n">vals</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">resonances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">vals</span><span class="p">[:</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">table</span><span class="p">(</span> <span class="n">columns</span><span class="o">=</span><span class="n">columnHeaders</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">resonances</span> <span class="p">)</span>
                <span class="c1"># done with this spin group:</span>
                <span class="n">J</span><span class="p">,</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">AJ</span><span class="p">,</span><span class="n">PJ</span><span class="p">)</span>
                <span class="n">spinGroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spinGroup</span><span class="p">(</span><span class="n">spinGroupIndex</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span>
                        <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">KBK</span><span class="p">,</span> <span class="n">KPS</span> <span class="p">)</span> <span class="p">)</span>

            <span class="c1"># for each resonanceReaction, store default value for true radius and effective radius.</span>
            <span class="c1"># Only include them in specific channels if we need to override the default value.</span>
            <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
            <span class="k">for</span> <span class="n">resonanceReac</span> <span class="ow">in</span> <span class="n">resonanceReactions</span><span class="p">:</span>
                <span class="n">channel</span><span class="p">,</span> <span class="n">trueRad</span><span class="p">,</span> <span class="n">effRad</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">radii</span><span class="p">[</span><span class="n">resonanceReac</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">trueRad</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">effRad</span><span class="p">):</span> <span class="k">continue</span>     <span class="c1"># ignore radii for (n,gamma)</span>

                <span class="n">APTmostCommon</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">trueRad</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">resonanceReac</span><span class="o">.</span><span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span>
                    <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">APTmostCommon</span><span class="p">,</span> <span class="s1">&#39;fm&#39;</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">APEmostCommon</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">effRad</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">APEmostCommon</span> <span class="o">!=</span> <span class="n">APTmostCommon</span><span class="p">:</span>
                    <span class="n">resonanceReac</span><span class="o">.</span><span class="n">hardSphereRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">hardSphereRadius</span><span class="p">(</span>
                        <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">APEmostCommon</span><span class="p">,</span> <span class="s1">&#39;fm&#39;</span> <span class="p">)</span> <span class="p">)</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">val1</span><span class="p">,</span><span class="n">val2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">[</span><span class="n">resonanceReac</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">APTmostCommon</span><span class="p">:</span>
                        <span class="n">channel</span><span class="o">.</span><span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span>
                            <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">val1</span><span class="p">,</span> <span class="s1">&#39;fm&#39;</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">val2</span> <span class="o">!=</span> <span class="n">APEmostCommon</span><span class="p">:</span>
                        <span class="n">channel</span><span class="o">.</span><span class="n">hardSphereRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">hardSphereRadius</span><span class="p">(</span>
                            <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">val2</span><span class="p">,</span> <span class="s1">&#39;fm&#39;</span> <span class="p">)</span> <span class="p">)</span>

            <span class="c1"># determine boundary condition. Most common: all == 0 or -L</span>
            <span class="n">irregular</span> <span class="o">=</span> <span class="p">[</span><span class="n">bc</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">boundaryConditions</span> <span class="k">if</span> <span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">irregular</span><span class="p">:</span> <span class="n">boundaryConditions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">Ls</span><span class="p">,</span> <span class="n">BCs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">boundaryConditions</span><span class="p">)</span>
            <span class="n">BCset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">BCs</span><span class="p">)</span>
            <span class="n">BCset_irregular</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">irregular</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Ls_irregular</span><span class="p">,</span> <span class="n">BCs_irregular</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">irregular</span><span class="p">)</span>
                <span class="n">BCset_irregular</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">BCs_irregular</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">BCset</span> <span class="o">==</span> <span class="p">{</span><span class="mi">0</span><span class="p">}:</span>    <span class="c1"># BND = SHF, SAMMY convention</span>
                <span class="n">boundaryCondition</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">([</span><span class="n">shf</span><span class="o">==</span><span class="mi">2</span> <span class="k">for</span> <span class="n">shf</span> <span class="ow">in</span> <span class="n">SHFs</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Brune transform (SHF=2) proposed but not yet implemented&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span> <span class="p">[</span><span class="n">L</span><span class="o">==-</span><span class="n">BC</span> <span class="k">for</span> <span class="n">L</span><span class="p">,</span><span class="n">BC</span> <span class="ow">in</span> <span class="n">boundaryConditions</span><span class="p">]</span> <span class="p">):</span>
                <span class="n">boundaryCondition</span> <span class="o">=</span> <span class="s1">&#39;-L&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">BCset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">BCset_irregular</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># non-zero constant boundary condition for all channels</span>
                <span class="n">boundaryCondition</span> <span class="o">=</span> <span class="n">BCset_irregular</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">spinGroups</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">sg</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
                        <span class="n">chan</span><span class="o">.</span><span class="n">boundaryConditionOverride</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can&#39;t decipher boundary condition!&quot;</span><span class="p">)</span>

            <span class="n">calculatePenetrability</span><span class="o">=</span><span class="nb">any</span><span class="p">(</span><span class="n">PNTs</span><span class="p">)</span>

            <span class="c1"># end of spin groups. write RMatrix class:</span>
            <span class="c1">#spinGroups.sort()   # sort by Jpi. Disable for easier comparison with ENDF-6</span>
            <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">RMatrix</span><span class="p">(</span><span class="n">resonanceReactions</span><span class="p">,</span> <span class="n">spinGroups</span><span class="p">,</span> <span class="n">approximation</span><span class="o">=</span><span class="n">approximation</span><span class="p">,</span>
                                            <span class="n">relativisticKinematics</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">KRL</span><span class="p">),</span> <span class="n">reducedWidthAmplitudes</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">IFG</span><span class="p">),</span>
                                            <span class="n">calculateChannelRadius</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">NAPS</span><span class="p">),</span> <span class="n">boundaryCondition</span><span class="o">=</span><span class="n">boundaryCondition</span><span class="p">,</span>
                                            <span class="n">calculatePenetrability</span><span class="o">=</span><span class="n">calculatePenetrability</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># unresolved</span>
            <span class="n">L_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">LRF_LFW</span> <span class="o">=</span> <span class="s2">&quot;LRF,LFW=</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LRF</span><span class="p">,</span> <span class="n">LFW</span><span class="p">)</span>

            <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">LSSF</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NE</span><span class="p">,</span><span class="n">NLS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">LSSF</span> <span class="o">=</span> <span class="n">LSSF</span>
            <span class="n">targetSpins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">SPI</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">SPI</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">NRO</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">scatRadius</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">(</span>
                        <span class="n">resonancesModule</span><span class="o">.</span><span class="n">constantScatteringRadius</span><span class="p">(</span> <span class="n">AP</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;fm&quot;</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">LFW</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>   <span class="c1"># &#39;Case A&#39;, see ENDF 2010 manual page 70</span>
                <span class="n">NLS</span> <span class="o">=</span> <span class="n">NE</span>
                <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                    <span class="n">AWRI</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NJS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NJS</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;bad unresolved flag, line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">J_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">jidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">AJ</span><span class="p">,</span><span class="n">AMUN</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">AMUN</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="n">AMUN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AMUN</span><span class="p">)</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">GF</span> <span class="o">=</span> <span class="p">[</span><span class="n">PQUModule</span><span class="o">.</span><span class="n">PQU</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">a</span> <span class="p">),</span><span class="s1">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">J_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">URR_Jsection</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">AJ</span><span class="p">),</span> <span class="n">eDepWidths</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">constantWidths</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;levelSpacing&#39;</span><span class="p">:</span><span class="n">D</span><span class="p">,</span><span class="s1">&#39;neutronWidth&#39;</span><span class="p">:</span><span class="n">GNO</span><span class="p">,</span><span class="s1">&#39;captureWidth&#39;</span><span class="p">:</span><span class="n">GG</span><span class="p">,</span> <span class="s1">&#39;fissionWidthA&#39;</span><span class="p">:</span><span class="n">GF</span><span class="p">,</span>
                                            <span class="s1">&#39;competitiveWidth&#39;</span><span class="p">:</span><span class="n">PQUModule</span><span class="o">.</span><span class="n">PQU</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;eV&#39;</span><span class="p">)},</span>
                            <span class="n">neutronDOF</span><span class="o">=</span><span class="n">AMUN</span><span class="p">,</span> <span class="n">gammaDOF</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">competitiveDOF</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fissionDOF</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">URR_Lsection</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">J_list</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">unresolvedTabulatedWidths</span><span class="p">(</span> <span class="n">L_list</span><span class="p">,</span>
                        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">linlinToken</span><span class="p">,</span> 
                        <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span> <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">LRF_LFW</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">LFW</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># &#39;Case B&#39;</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NE</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                <span class="n">energyList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                    <span class="c1">#energyList += [PQUModule.PQU( PQUModule.pqu_float.surmiseSignificantDigits( a ),&#39;eV&#39;) for a in funkyF(mf2.next(), logFile = info.logs )]</span>
                    <span class="n">energyList</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                    <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">J_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">jidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">eDepWidths</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">MUF</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="n">NE</span><span class="o">+</span><span class="mi">6</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;Bad unresolved flag, line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">AJ</span><span class="p">,</span><span class="n">AMUN</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">AMUN</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="n">AMUN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">AMUN</span><span class="p">)</span>
                        <span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">GX</span> <span class="o">=</span> <span class="p">[</span><span class="n">PQUModule</span><span class="o">.</span><span class="n">PQU</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">a</span> <span class="p">),</span><span class="s1">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">widthList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                            <span class="c1">#widthList += [PQUModule.PQU( PQUModule.pqu_float.surmiseSignificantDigits( a ),&#39;eV&#39;) for a in funkyF( mf2.next(), logFile = info.logs )]</span>
                            <span class="n">widthList</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">table</span><span class="p">(</span> <span class="p">[</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fissionWidthA&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NE</span><span class="p">):</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span> <span class="p">[</span><span class="n">energyList</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">widthList</span><span class="p">[</span><span class="n">e</span><span class="p">]]</span> <span class="p">)</span>
                            <span class="c1">#eDepWidths.append({&#39;energy&#39;:energyList[e], &#39;fissionWidthA&#39;:widthList[e]})</span>
                        <span class="n">J_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">URR_Jsection</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">AJ</span><span class="p">),</span> <span class="n">table</span><span class="p">,</span>
                            <span class="n">constantWidths</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;levelSpacing&#39;</span> <span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="s1">&#39;neutronWidth&#39;</span> <span class="p">:</span> <span class="n">GNO</span><span class="p">,</span> <span class="s1">&#39;captureWidth&#39;</span> <span class="p">:</span> <span class="n">GG</span><span class="p">,</span> <span class="s1">&#39;competitiveWidth&#39;</span> <span class="p">:</span> <span class="n">GX</span> <span class="p">},</span>
                            <span class="n">neutronDOF</span> <span class="o">=</span> <span class="n">AMUN</span><span class="p">,</span> <span class="n">fissionDOF</span> <span class="o">=</span> <span class="n">MUF</span><span class="p">,</span> <span class="n">competitiveDOF</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">URR_Lsection</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">J_list</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">unresolvedTabulatedWidths</span><span class="p">(</span> <span class="n">L_list</span><span class="p">,</span>
                        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">linlinToken</span><span class="p">,</span> 
                        <span class="n">scatteringRadius</span><span class="o">=</span><span class="n">scatRadius</span><span class="p">,</span> <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">LRF_LFW</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>            <span class="c1"># &#39;Case C&#39;, most common in ENDF-VII.1</span>
                <span class="n">NLS</span> <span class="o">=</span> <span class="n">NE</span>
                <span class="n">interpolations</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">Lidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                    <span class="n">J_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">jidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">resList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">AJ</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">INT</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NE</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="n">interpolations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INT</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NE</span><span class="o">+</span><span class="mi">6</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span><span class="s2">&quot;bad unresolved flag, line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">dof</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUX&#39;</span><span class="p">],</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUN&#39;</span><span class="p">],</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUG&#39;</span><span class="p">],</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;AMUX&#39;</span><span class="p">,</span><span class="s1">&#39;AMUN&#39;</span><span class="p">,</span><span class="s1">&#39;AMUG&#39;</span><span class="p">,</span><span class="s1">&#39;AMUF&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dof</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NE</span><span class="p">):</span>
                            <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="n">tableModule</span><span class="o">.</span><span class="n">table</span><span class="p">(</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;levelSpacing&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;competitiveWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;neutronWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;captureWidth&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span>
                            <span class="n">tableModule</span><span class="o">.</span><span class="n">columnHeader</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fissionWidthA&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span> <span class="p">),</span> <span class="p">],</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">resList</span> <span class="p">)</span>
                        <span class="n">J_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">URR_Jsection</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">AJ</span><span class="p">),</span> <span class="n">table</span><span class="p">,</span>
                                <span class="n">constantWidths</span><span class="o">=</span><span class="p">{},</span> <span class="n">competitiveDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUX&#39;</span><span class="p">],</span> <span class="n">neutronDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUN&#39;</span><span class="p">],</span>
                                <span class="n">gammaDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUG&#39;</span><span class="p">],</span> <span class="n">fissionDOF</span><span class="o">=</span><span class="n">dof</span><span class="p">[</span><span class="s1">&#39;AMUF&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="c1"># sometimes energy-dependent flag is used, but widths are constant in energy:</span>
                        <span class="n">J_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eliminateRedundantInfo</span><span class="p">()</span>
                    <span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">URR_Lsection</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">J_list</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">interpolations</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;inconsistent interpolations in unresolved region will be ignored!&#39;</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">unresolvedTabulatedWidths</span><span class="p">(</span> <span class="n">L_list</span><span class="p">,</span>
                        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND1d</span><span class="p">(</span> <span class="n">interpolations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span>
                        <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">scatRadius</span><span class="p">,</span> <span class="n">ENDFconversionFlag</span> <span class="o">=</span> <span class="n">LRF_LFW</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Unexpected LRU=</span><span class="si">%d</span><span class="s2">, LRF=</span><span class="si">%d</span><span class="s2"> encountered</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span> <span class="p">)</span> <span class="p">)</span>

    <span class="c1"># end of helper functions.</span>
    <span class="c1"># now read MF2 data:</span>
    <span class="n">mf2</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">MF2</span><span class="p">)</span> <span class="c1"># mf2.next() to get each line</span>

    <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">resolvedList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unresolvedList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># read MF2 header:</span>
    <span class="n">ZAM</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NIS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZAM</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZAM</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ZAM</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZAM</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">NIS</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;careful, more than one isotope in MF2!&quot;</span> <span class="p">)</span>
    <span class="n">ZAI</span><span class="p">,</span> <span class="n">ABN</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">LFW</span><span class="p">,</span> <span class="n">NER</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">erange</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NER</span><span class="p">):</span>
        <span class="c1"># each energy range</span>
        <span class="n">EL</span><span class="p">,</span> <span class="n">EH</span><span class="p">,</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span><span class="p">,</span> <span class="n">NRO</span><span class="p">,</span> <span class="n">NAPS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">mf2</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">resonanceSection</span> <span class="o">=</span> <span class="n">readResonanceSection</span><span class="p">(</span> <span class="n">LRU</span><span class="p">,</span> <span class="n">LRF</span><span class="p">,</span> <span class="n">NRO</span><span class="p">,</span> <span class="n">NAPS</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">scatteringRadius</span> <span class="o">=</span> <span class="n">resonanceSection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resonanceMTs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">102</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">resolvedList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">resonanceSection</span><span class="p">,</span><span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">unresolvedList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">resonanceSection</span><span class="p">,</span><span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolvedList</span><span class="p">:</span> <span class="n">resolved</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolvedList</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resolved</span><span class="p">(</span> <span class="o">*</span><span class="n">resolvedList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domainUnit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;multiple resolved energy intervals are deprecated!&quot;</span> <span class="p">)</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resolved</span><span class="p">(</span> <span class="n">formalism</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domainMin</span><span class="o">=</span><span class="n">resolvedList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">domainMax</span><span class="o">=</span><span class="n">resolvedList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">domainUnit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="n">multipleRegions</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">resonanceSection</span><span class="p">,</span> <span class="n">EL</span><span class="p">,</span> <span class="n">EH</span> <span class="ow">in</span> <span class="n">resolvedList</span><span class="p">:</span>
            <span class="n">resolved</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">energyInterval</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">resonanceSection</span><span class="p">,</span><span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">,</span><span class="n">domainUnit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unresolvedList</span><span class="p">:</span> <span class="n">unresolved</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unresolvedList</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">unresolved</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">unresolved</span><span class="p">(</span> <span class="o">*</span><span class="n">unresolvedList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domainUnit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span>
            <span class="n">reconstructCrossSection</span><span class="o">=</span><span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">LSSF</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadResonances</span><span class="p">(</span> <span class="s2">&quot;multiple unresolved regions not supported&quot;</span> <span class="p">)</span>

<span class="c1">#    if mf2.index != mf2.length: raise BadResonances(&quot;Not all resonance data converted!&quot;)</span>
    <span class="k">if</span> <span class="n">mf2</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">mf2</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Not all resonance data converted!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">targetSpins</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;multiple values for nuclear spin encountered: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">targetSpins</span><span class="p">)</span>
    <span class="n">resonances</span> <span class="o">=</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">resonances</span><span class="p">(</span> <span class="n">scatteringRadius</span><span class="p">,</span> <span class="n">resolved</span><span class="p">,</span> <span class="n">unresolved</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">resonances</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resonanceMTs</span><span class="p">)</span></div>


<div class="viewcode-block" id="readMF3"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF3">[docs]</a><span class="k">def</span> <span class="nf">readMF3</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF3Data</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">crossSectionRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MF3Data</span><span class="p">,</span> <span class="n">allowInterpolation6</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
            <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">crossSectionAxes</span><span class="p">,</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">crossSectionModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span>
    <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">LR</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">],</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">breakupProducts</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span><span class="p">(</span>   <span class="n">LR</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : MF=3, LR=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">LR</span> <span class="p">)</span>
        <span class="n">breakupProducts</span><span class="p">,</span> <span class="n">productCounts</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span><span class="p">[</span><span class="n">LR</span><span class="p">]</span><span class="o">.</span><span class="n">productCounts</span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productCounts</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>
        <span class="n">breakupProducts</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">del</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="o">==</span> <span class="mi">31</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;Invalid LR = </span><span class="si">%s</span><span class="s1"> for MT = </span><span class="si">%s</span><span class="s1"> is being ignored&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : MF=3, LR=1&#39;</span> <span class="p">)</span>
        <span class="k">pass</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LR</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LR</span> <span class="o">==</span> <span class="mi">40</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;LR = </span><span class="si">%s</span><span class="s1"> for MT = </span><span class="si">%s</span><span class="s1"> is being ignored&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">!=</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Breakup LR = </span><span class="si">%s</span><span class="s2"> is not supported: MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Breakup LR = </span><span class="si">%s</span><span class="s2"> is not supported: MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Invalid breakup flag LR </span><span class="si">%s</span><span class="s2">: MT = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LR</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">crossSection</span> <span class="o">=</span> <span class="n">getCrossSectionForm</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">crossSectionRegions</span> <span class="p">)</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">breakupProducts</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF4"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF4">[docs]</a><span class="k">def</span> <span class="nf">readMF4</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">formClass</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MTWithOnlyNeutonProducts</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">MF4ForNonNeutrons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">MT</span> <span class="p">)</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LVT</span><span class="p">,</span> <span class="n">LTT</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF4Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LVT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LVT</span> <span class="p">)</span>                <span class="c1"># 1: transformation matrix given. Must be 0 for endf/b6 format but not older formats.</span>
    <span class="n">LTT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LTT</span> <span class="p">)</span>                <span class="c1"># 0: isotropic, 1: Legendre, 2: table, 3: Legendre for low E and table for high E.</span>

    <span class="n">dummy</span><span class="p">,</span> <span class="n">AWR_</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">NM</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF4Data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">AWR</span> <span class="o">!=</span> <span class="n">AWR_</span> <span class="p">)</span> <span class="p">:</span> <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LI</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LI</span> <span class="p">)</span>                  <span class="c1"># if 1, gammas isotropic</span>
    <span class="n">LCT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LCT</span> <span class="p">)</span>                <span class="c1"># 1 for lab frame, 2 for center of mass</span>
    <span class="n">NK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span>                  <span class="c1"># number of entries in transformation matrix</span>
    <span class="n">NM</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NM</span> <span class="p">)</span>                  <span class="c1"># maximum Legendre order</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">LCT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">formClass</span> <span class="o">==</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span> <span class="p">)</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Discrete two-body must be in the center-of-mass frame: LCT = </span><span class="si">%d</span><span class="s2"> MT = </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">firstDataLine</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LVT</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;MF = 4, MT = 2 contains obsolete matrix used to transform Legendre coefficients between frames.&#39;</span> <span class="p">)</span>
        <span class="n">firstDataLine</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">NK</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>

    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : MF=4, LTT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">LTT</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                <span class="c1"># Purely isotropic angular distribution.</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>              <span class="c1"># Legendre polynomial coefficient</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">firstDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;LTT = 1&#39;</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>              <span class="c1"># Tabulated probability distribution</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularTable</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">firstDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewiseFromTAB2_TAB1</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularTable</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span>              <span class="c1"># Mixed Legendre and Tabulated probability distribution</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">firstDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">angularTable</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">nextDataLine</span><span class="p">,</span> <span class="n">MF4Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">subformPointwise</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewiseFromTAB2_TAB1</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularTable</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">subform</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;LTT = 3&#39;</span><span class="p">,</span> <span class="n">subformPointwise</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Encountered unknown LTT=</span><span class="si">%d</span><span class="s2"> in MF4&quot;</span> <span class="o">%</span> <span class="n">LTT</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">formClass</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">formClass</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frames</span><span class="p">[</span><span class="n">LCT</span><span class="p">],</span> <span class="n">subform</span> <span class="p">)</span>
    <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF5"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF5">[docs]</a><span class="k">def</span> <span class="nf">readMF5</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">delayNeutrons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">product</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF5Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">NK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span>                 <span class="c1"># number of partial energy distributions.</span>
    <span class="n">dataLine</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">energySubforms</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">productData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">oldInterpolations</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">oldInterpolations</span> <span class="o">==</span> <span class="p">[</span> <span class="p">[</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>       <span class="c1"># This is a kludge for about 5 data sets, but does a good job.</span>
                <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span> <span class="o">*</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="mi">2</span> <span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation flag is supported&quot;</span> <span class="p">)</span>
        <span class="n">LF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>           <span class="c1"># breakup flag</span>
        <span class="n">xPrior</span><span class="p">,</span> <span class="n">addWarning</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">del</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">delayNeutrons</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation flag is supported for weight for MF=5, MT=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">discontinuities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span> <span class="p">:</span>                <span class="c1"># Check if data can be treated as flat interpolation.</span>
                    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">xy</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">x1</span> <span class="o">!=</span> <span class="n">x2</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">y1</span> <span class="o">!=</span> <span class="n">y2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;Weight data must be convertible to flat interpolation&#39;</span> <span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">discontinuities</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i1</span> <span class="p">)</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
                <span class="k">for</span> <span class="n">discontinuity</span> <span class="ow">in</span> <span class="n">discontinuities</span> <span class="p">:</span> <span class="k">del</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">discontinuity</span><span class="p">]</span>
            <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND1d</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>    <span class="c1"># Flat interpolation.</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">labelsUnits</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;energy_in&#39;</span> <span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">),</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;weight&#39;</span> <span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">xPrior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;xy[0] = </span><span class="si">%s</span><span class="s1"> &lt; xPrior = </span><span class="si">%s</span><span class="s1"> for MT=</span><span class="si">%d</span><span class="s1">, MF=5&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xPrior</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xPrior</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">FUDGE_EPS</span> <span class="p">)</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">addWarning</span> <span class="p">)</span> <span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;weights have same energies, second one being incremented for MT=</span><span class="si">%d</span><span class="s1">, MF=5&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                        <span class="n">addWarning</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xPrior</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND1d</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span> <span class="p">)</span> <span class="p">)</span>   <span class="c1"># weights is only used for delayed nu_bar data</span>

        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : MF=5, LF=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">LF</span> <span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">physicalQuantityModule</span><span class="o">.</span><span class="n">U</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span> <span class="c1"># Upper energy limit.</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">toPointwiseOrPiecewiseEnergy</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">gs</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xLabel</span> <span class="o">=</span> <span class="s1">&#39;energy_out / theta( energy_in )&#39;</span><span class="p">,</span> <span class="n">xUnit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">generalEvaporationSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">gs</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">7</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">simpleMaxwellianFissionSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">evaporationSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">thetas</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;1/eV&#39;</span> <span class="p">)</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">WattSpectrum</span><span class="p">(</span> <span class="n">U</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">Ts</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">toEnergyFunctionalData</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF5Data</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;T_M&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">EFL</span> <span class="o">=</span> <span class="n">physicalQuantityModule</span><span class="o">.</span><span class="n">EFL</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">EFH</span> <span class="o">=</span> <span class="n">physicalQuantityModule</span><span class="o">.</span><span class="n">EFH</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">MadlandNix</span><span class="p">(</span> <span class="n">EFL</span><span class="p">,</span> <span class="n">EFH</span><span class="p">,</span> <span class="n">Ts</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Unsupported LF = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">LF</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">delayNeutrons</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">subform</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>

        <span class="n">energySubforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">delayNeutrons</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; -- using energy.weightedFunctionals subform --&#39;</span> <span class="p">)</span>
            <span class="n">weightedSubform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">weightedFunctionals</span><span class="p">(</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">functional</span> <span class="ow">in</span> <span class="n">energySubforms</span> <span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span> <span class="n">functional</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">functional</span> <span class="p">)</span>
                <span class="n">weightedSubform</span><span class="o">.</span><span class="n">addWeight</span><span class="p">(</span> <span class="n">weight</span> <span class="p">)</span>
                <span class="k">del</span> <span class="n">functional</span><span class="o">.</span><span class="n">weight</span>
            <span class="n">energySubforms</span> <span class="o">=</span> <span class="n">weightedSubform</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">energySubforms</span> <span class="o">=</span> <span class="n">energySubforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">energySubforms</span><span class="p">,</span> <span class="n">weights</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF6"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF6">[docs]</a><span class="k">def</span> <span class="nf">readMF6</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span><span class="p">,</span> <span class="n">isTwoBody</span><span class="p">,</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">LCT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LCT</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>        <span class="c1"># Happens for electro-atomic data.</span>
        <span class="n">LCT</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">526</span> <span class="p">)</span> <span class="p">:</span> <span class="n">LCT</span> <span class="o">=</span> <span class="mi">2</span>       <span class="c1"># Not sure this is right. Maybe it should be 1.</span>
    <span class="n">LCTLight</span><span class="p">,</span> <span class="n">LCTWeight</span> <span class="o">=</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">LCT</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">LCTLight</span><span class="p">,</span> <span class="n">LCTWeight</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">NK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span>                  <span class="c1"># number of outgoing particle data sets</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">discretePrimaryGammas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[]</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : MF=6&#39;</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">outGoing</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">isLegendreConvertedToEnergy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">productData</span><span class="p">,</span> <span class="n">multiplicityRegions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span> <span class="p">)</span>
            <span class="c1"># ZAP is ZA for outgoing particle; AWP is its atomic mass, LIP: 0 for residual in ground state, 1 for first excited state, etc</span>
        <span class="n">ZAP</span><span class="p">,</span> <span class="n">AWP</span><span class="p">,</span> <span class="n">LIP</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">NP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">],</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">&lt;</span> <span class="mi">2005</span> <span class="p">)</span> <span class="p">:</span> <span class="n">LIP</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># LIP has multiple meanings. For light products, signifies different products with the same ZAP.</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">:</span>          <span class="c1"># 11 is the ZAP for and electron, however, ENDF/B-VII.1 mislabels the photo as 11 also.</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">526</span><span class="p">,</span> <span class="mi">528</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">&gt;=</span> <span class="mi">534</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZAP</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;photon most likely labelled as an electron (ZAP = 11), converting to ZAP = 0&#39;</span> <span class="p">)</span>
        <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">AWP</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">AWP</span><span class="p">,</span> <span class="n">asTarget</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
        <span class="n">LCTp</span> <span class="o">=</span> <span class="n">LCTLight</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">:</span> <span class="n">LCTp</span> <span class="o">=</span> <span class="n">LCTWeight</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span><span class="o">==</span><span class="mi">4</span> <span class="ow">and</span> <span class="n">outGoing</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">):</span> <span class="n">LCTp</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># lab frame for break-up products.</span>
        <span class="c1"># FIXME previous line assumes that intermediate product (before break-up) was not included in MF6 product list</span>
        <span class="n">LAW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LAW</span> <span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">LCTp</span><span class="p">]</span>

        <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : ZAP=</span><span class="si">%s</span><span class="s1">, LAW=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">LAW</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">energyDeposition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">unknownModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>              <span class="c1"># Continuum Energy-Angle distributions</span>
            <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">LEP</span><span class="p">,</span> <span class="n">NR</span><span class="p">,</span> <span class="n">NE</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">LANG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LANG</span> <span class="p">)</span>          <span class="c1"># identifies the type of data</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;, LANG=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">LANG</span> <span class="p">)</span>
            <span class="n">LEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">LEP</span> <span class="p">)</span>            <span class="c1"># interpolation type for outgoing energy</span>
            <span class="n">interpolationLEP</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND1d</span><span class="p">(</span> <span class="n">LEP</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>               <span class="c1"># Legendre expansion</span>
                <span class="n">NR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NR</span> <span class="p">)</span>              <span class="c1"># number of interpolation regions for incident energy</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">NR</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation region is supported for MF = 6, LAW = 1, LANG = 2; MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">NE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NE</span> <span class="p">)</span>              <span class="c1"># number of incident energies</span>

                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">EinInterpolationTypes</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">nStringsToInts</span><span class="p">(</span> <span class="n">NR</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">EinInterpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">EinInterpolationTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="n">NR</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>    <span class="c1"># the next data is energy-angle distributions</span>

                <span class="n">massRatio</span> <span class="o">=</span> <span class="n">AWR</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">AWR</span> <span class="p">)</span>
                <span class="n">maxLegendre</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">EEpClsData</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">EinCount</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NE</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">dummy</span><span class="p">,</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">ND</span><span class="p">,</span> <span class="n">NA</span><span class="p">,</span> <span class="n">NW</span><span class="p">,</span> <span class="n">NEP</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span><span class="n">dataLine</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">ND</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ND</span> <span class="p">)</span>          <span class="c1"># number of discrete gammas (nonzero only for gammas)</span>
                    <span class="n">NA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NA</span> <span class="p">)</span>          <span class="c1"># number of angular parameters (i.e., lMax).</span>
                    <span class="n">NW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NW</span> <span class="p">)</span>          <span class="c1"># number of data values for this incident energy</span>
                    <span class="n">NEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEP</span> <span class="p">)</span>        <span class="c1"># number of outgoing energy values</span>
                    <span class="n">maxLegendre</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="n">maxLegendre</span><span class="p">,</span> <span class="n">NA</span> <span class="p">)</span>
                    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span><span class="p">(</span> <span class="n">ND</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">NA</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Logic here currently only supports isotropic scattering.&quot;</span> <span class="p">)</span>
                        <span class="n">discreteGammasAtE</span><span class="p">,</span> <span class="n">EoutData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">readDiscreteAndLegendre</span><span class="p">(</span> <span class="n">ND</span><span class="p">,</span> <span class="n">NEP</span> <span class="o">-</span> <span class="n">ND</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span>
                                <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">NA</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="n">discretePrimaryGammasAtE</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">EgPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">for</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">discreteGammasAtE</span> <span class="p">:</span>                    <span class="c1"># Divide gammas into primary and discrete.</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">Eg</span> <span class="o">==</span> <span class="n">EgPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="n">Eg</span> <span class="o">-=</span> <span class="nb">float</span><span class="p">(</span> <span class="s2">&quot;%0.e&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">Eg</span> <span class="p">)</span> <span class="p">)</span>
                            <span class="n">EgPrior</span> <span class="o">=</span> <span class="n">Eg</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">Eg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                                  <span class="c1"># Primary gamma.</span>
                                <span class="n">Epg</span> <span class="o">=</span> <span class="o">-</span><span class="n">Eg</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">Ein</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="n">Epg</span> <span class="o">-=</span> <span class="n">massRatio</span> <span class="o">*</span> <span class="n">Ein</span>   <span class="c1"># Only include projectile correction for Ein &gt; 1e-2 as typically Eg ~ 1e6.</span>
                                <span class="n">discretePrimaryGammasAtE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">Epg</span><span class="p">,</span> <span class="p">[</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">P</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                            <span class="k">else</span> <span class="p">:</span>                                          <span class="c1"># Discrete gamma.</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">Eg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="p">:</span> <span class="n">discreteGammas</span><span class="p">[</span><span class="n">Eg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">discreteGammas</span><span class="p">[</span><span class="n">Eg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">P</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammasAtE</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="n">discretePrimaryGammas</span> <span class="o">=</span> <span class="n">discretePrimaryGammasAtE</span>
                            <span class="k">else</span> <span class="p">:</span>      <span class="c1"># Now we need to match level energies (aka binding energies) from prior with Ein&#39;s with current Ein.</span>
                                        <span class="c1"># This is needed since for different Ein&#39;s, the calculation of Epg will vary slightly (hopefully less than 1e-4).</span>
                                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammasAtE</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;number of primary gammas at Ein = </span><span class="si">%s</span><span class="s1"> is different then first incident energy&#39;</span> <span class="o">%</span> <span class="n">Ein</span> <span class="p">)</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">Eg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">if</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">Eg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">discretePrimaryGammasAtE</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">Eg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;primary energy of </span><span class="si">%s</span><span class="s1"> is not close to primary energy </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">Eg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">discretePrimaryGammasAtE</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                                    <span class="n">Eg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">discretePrimaryGammasAtE</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">EoutData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">nFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">NEP</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">NA</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">EoutData</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="c1"># Test for some common problems.</span>
                        <span class="c1"># 1: all outgoing energies == 0 for continuum gammas.</span>
                        <span class="c1"># This usually only affects one incident energy, so just replace that energy with empty outgoing distribution:</span>
                        <span class="n">energy_out_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">EoutData</span> <span class="p">]</span>
                        <span class="k">if</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">energy_out_list</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;At Ein=</span><span class="si">%s</span><span class="s2"> eV, continuum gamma outgoing energies are all 0.0 (MT=</span><span class="si">%d</span><span class="s2">, ZAP=</span><span class="si">%d</span><span class="s2">)!&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span> <span class="p">)</span>
                            <span class="n">EoutData</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">],</span> <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span> <span class="p">]</span>
                        <span class="c1"># 2: trouble with duplicate outgoing energies:</span>
                        <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span> <span class="n">a</span> <span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">energy_out_list</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span> <span class="mf">0.0</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Too many duplicate outgoing energies for Ein=</span><span class="si">%s</span><span class="s2"> eV (MT=</span><span class="si">%d</span><span class="s2">, ZAP=</span><span class="si">%d</span><span class="s2">)!&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span> <span class="p">)</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span> <span class="mf">0.0</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="n">finalZeroIndex</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span> <span class="mf">0.0</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="n">energy_out_list</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="p">[</span><span class="n">finalZeroIndex</span><span class="p">:]</span>
                                <span class="n">EoutData</span> <span class="o">=</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">finalZeroIndex</span><span class="p">:]</span>
                            <span class="k">while</span><span class="p">(</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span> <span class="n">energy_out_list</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="n">eout</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                                <span class="n">eoutCount</span> <span class="o">=</span> <span class="n">energy_out_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span> <span class="n">eout</span> <span class="p">)</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">eoutCount</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="n">eoutCount</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                                    <span class="n">i1</span> <span class="o">+=</span> <span class="n">eoutCount</span>
                                <span class="k">else</span> <span class="p">:</span>
                                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EoutData</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="p">)</span>
                                    <span class="n">i1</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">EoutData</span> <span class="o">=</span> <span class="n">tmp</span>                          <span class="c1"># End of TENDL-specific tests.</span>
                        <span class="n">EpClsDatas</span><span class="p">,</span> <span class="n">EpPrior</span><span class="p">,</span> <span class="n">ClsPrior</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[]</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">LEP</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>                            <span class="c1"># Remove some data that are not needed and complicates things.</span>
                            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">EoutData</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">if</span><span class="p">(</span> <span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                                        <span class="n">EoutData</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                                    <span class="k">elif</span> <span class="p">(</span><span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>   <span class="c1"># Discontinuity used to make final point == 0. Bump previous energy back slightly</span>
                                         <span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nudgeValue</span><span class="p">(</span> <span class="n">EoutData</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
                        <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">EpCs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">EoutData</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">e_out</span><span class="p">,</span> <span class="n">Cls</span> <span class="o">=</span> <span class="n">EpCs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EpCs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">e_out</span> <span class="o">==</span> <span class="n">EpPrior</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">Cls</span> <span class="o">==</span> <span class="n">ClsPrior</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">if</span><span class="p">(</span> <span class="n">skippedLast</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - need to fix&#39;</span>
                                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;skipping duplicate e_out = </span><span class="si">%s</span><span class="s1">, i1 = </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">e_out</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">EinCount</span><span class="p">,</span> <span class="n">Ein</span> <span class="p">)</span> <span class="p">)</span>
                                    <span class="n">skippedLast</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">continue</span>
                                <span class="k">else</span><span class="p">:</span>   <span class="c1"># create new region:</span>
                                    <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EpClsDatas</span> <span class="p">)</span>
                                    <span class="n">EpClsDatas</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">skippedLast</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">EpClsData</span> <span class="o">=</span> <span class="p">[</span> <span class="n">e_out</span><span class="p">,</span> <span class="n">Cls</span> <span class="p">]</span>
                            <span class="n">EpClsDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EpClsData</span> <span class="p">)</span>
                            <span class="n">EpPrior</span><span class="p">,</span> <span class="n">ClsPrior</span> <span class="o">=</span> <span class="n">e_out</span><span class="p">,</span> <span class="n">Cls</span>
                        <span class="k">if</span> <span class="n">regions</span><span class="p">:</span>
                            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EpClsDatas</span> <span class="p">)</span>
                            <span class="n">EEpClsData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="kc">True</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">EEpClsData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">EpClsDatas</span><span class="p">,</span> <span class="kc">False</span> <span class="p">]</span> <span class="p">)</span>
                    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="n">NW</span> <span class="o">-</span>  <span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>    <span class="c1"># Offset for the next incident energy</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">maxLegendre</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>    <span class="c1"># Only have l=0 for each outgoing energy. Convert this to</span>
                                            <span class="c1"># uncorrelated with P(E_out|E_in) and isotropic angular distribution.</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">EEpClsData</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>  <span class="c1"># length == 0 happens when there are only discrete gammas and no continuum gamma data.</span>
                        <span class="n">isLegendreConvertedToEnergy</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>

                        <span class="n">EPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">energySubform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
                        <span class="n">energySubformRegion</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">EinInterpolation</span><span class="p">,</span>
                                <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">EpCls</span><span class="p">,</span> <span class="n">multiRegion</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">EEpClsData</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="k">if</span> <span class="n">multiRegion</span><span class="p">:</span>
                                <span class="n">xData</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">regions1d</span><span class="p">(</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
                                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">EpCls</span><span class="p">:</span>
                                    <span class="n">EpP</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">region</span> <span class="p">]</span>
                                    <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">EpP</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span> <span class="p">)</span> <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">EpP</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">EpCls</span> <span class="p">]</span>
                                <span class="n">xData</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">EpP</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span><span class="p">,</span> 
                                        <span class="n">value</span> <span class="o">=</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">Ein</span> <span class="o">==</span> <span class="n">EPrior</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="n">energySubform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energySubformRegion</span> <span class="p">)</span>
                                <span class="n">energySubformRegion</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">EinInterpolation</span><span class="p">,</span>
                                <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
                            <span class="n">energySubformRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xData</span> <span class="p">)</span>
                            <span class="n">EPrior</span> <span class="o">=</span> <span class="n">Ein</span>
                        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">energySubform</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">energySubformRegion</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="n">energySubform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energySubformRegion</span> <span class="p">)</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="n">energySubform</span> <span class="o">=</span> <span class="n">energySubformRegion</span>

                        <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">EPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">energyAngularSubform</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">regions3d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAngularAxes</span> <span class="p">)</span>
                    <span class="n">energyAngularSubformRegion</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">XYs3d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAngularAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">EinInterpolation</span><span class="p">,</span>
                            <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="p">(</span> <span class="n">e_in</span><span class="p">,</span> <span class="n">EpCls</span><span class="p">,</span> <span class="n">multiRegion</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">EEpClsData</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">multiRegion</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="bp">NotImplemented</span>
                        <span class="n">multiD_2d</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e_in</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAngularAxes</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="p">(</span> <span class="n">e_out</span><span class="p">,</span> <span class="n">Cls</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">EpCls</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">multiD_2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">Cls</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e_out</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAngularAxes</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">e_in</span> <span class="o">==</span> <span class="n">EPrior</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">energyAngularSubform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energyAngularSubformRegion</span> <span class="p">)</span>
                            <span class="n">energyAngularSubformRegion</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">XYs3d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAngularAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">EinInterpolation</span><span class="p">,</span>
                            <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
                        <span class="n">energyAngularSubformRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">multiD_2d</span> <span class="p">)</span>
                        <span class="n">EPrior</span> <span class="o">=</span> <span class="n">e_in</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">energyAngularSubform</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">energyAngularSubform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energyAngularSubformRegion</span> <span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">energyAngularSubform</span> <span class="o">=</span> <span class="n">energyAngularSubformRegion</span>
                    <span class="n">form</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">energyAngularSubformRegion</span> <span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>             <span class="c1"># Kalbach-Mann data</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LCTp</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;LCT = </span><span class="si">%s</span><span class="s1"> != 2 as required for Kalbach-Mann data for MF=6, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LCTp</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">dataLine</span><span class="p">,</span> <span class="n">KalbachMannData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 1, LANG = 2; MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">NA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">dataPerPoint</span> <span class="o">=</span> <span class="n">NA</span> <span class="o">+</span> <span class="mi">2</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">interpolationQualifier</span> <span class="o">==</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">noneQualifierToken</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">unitBaseToken</span>
                <span class="n">fData</span> <span class="o">=</span> <span class="n">multiD_XYsModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">KalbachMann_f_Axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> 
                        <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">interpolationQualifier</span> <span class="o">==</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">unitBaseToken</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">unitBaseUnscaledToken</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">correspondingPointsUnscaledToken</span>
                <span class="n">rData</span> <span class="o">=</span> <span class="n">multiD_XYsModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">KalbachMann_r_Axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> 
                        <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>

                <span class="n">aData</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">NA</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">aData</span> <span class="o">=</span> <span class="n">multiD_XYsModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">KalbachMann_a_Axes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> 
                            <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>

                <span class="n">priorE</span><span class="p">,</span> <span class="n">priorEp_f_r_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">KalbachMannData</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span>
                    <span class="n">Ep_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][::</span><span class="n">dataPerPoint</span><span class="p">]</span>
                    <span class="n">f_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="n">dataPerPoint</span><span class="p">]</span>
                    <span class="n">r_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">::</span><span class="n">dataPerPoint</span><span class="p">]</span>
                    <span class="n">priorEp_f_r__</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Ep_</span><span class="p">,</span> <span class="n">f_</span><span class="p">,</span> <span class="n">r_</span> <span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">value</span> <span class="o">==</span> <span class="n">priorE</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">fData</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
                            <span class="n">rData</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">aData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">aData</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">priorEp_f_r_</span> <span class="o">==</span> <span class="n">priorEp_f_r__</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>        <span class="c1"># For TENDL files with duplicate data.</span>
                            <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MT=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span>
                            <span class="nb">print</span> <span class="n">value</span><span class="p">,</span> <span class="n">priorEp_f_r_</span>
                            <span class="nb">print</span> <span class="n">priorE</span><span class="p">,</span> <span class="n">priorEp_f_r__</span>
                            <span class="k">raise</span> <span class="s1">&#39;hell - need to support regions&#39;</span>
                    <span class="n">priorE</span><span class="p">,</span> <span class="n">priorEp_f_r_</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="n">priorEp_f_r__</span>
                    <span class="n">fData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span> <span class="n">Ep_</span><span class="p">,</span> <span class="n">f_</span> <span class="p">),</span> <span class="n">dataForm</span> <span class="o">=</span> <span class="s1">&#39;xsandys&#39;</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">KalbachMann_f_Axes</span><span class="p">,</span>
                                                 <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">rData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span> <span class="n">Ep_</span><span class="p">,</span> <span class="n">r_</span> <span class="p">),</span> <span class="n">dataForm</span> <span class="o">=</span> <span class="s1">&#39;xsandys&#39;</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">KalbachMann_r_Axes</span><span class="p">,</span>
                                                 <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">aData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">a_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">::</span><span class="n">dataPerPoint</span><span class="p">]</span>
                        <span class="n">aData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span> <span class="n">Ep_</span><span class="p">,</span> <span class="n">a_</span> <span class="p">),</span> <span class="n">dataForm</span> <span class="o">=</span> <span class="s1">&#39;xsandys&#39;</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">KalbachMann_a_Axes</span><span class="p">,</span>
                                                     <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span> <span class="p">)</span> <span class="p">)</span>

                <span class="n">fSubform</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">fSubform</span><span class="p">(</span> <span class="n">fData</span> <span class="p">)</span>
                <span class="n">rSubform</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">rSubform</span><span class="p">(</span> <span class="n">rData</span> <span class="p">)</span>
                <span class="n">aSubform</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">aSubform</span><span class="p">(</span> <span class="n">aData</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">KalbachMannModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">fSubform</span><span class="p">,</span> <span class="n">rSubform</span><span class="p">,</span> <span class="n">aSubform</span> <span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span> <span class="n">LANG</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>    <span class="c1"># P(E&#39;,mu|E)</span>
                <span class="n">NR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NR</span> <span class="p">)</span>                      <span class="c1"># number of interpolation regions for incident energy</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">NR</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation region is supported for MF = 6, LAW = 1, LANG = 2; MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">NE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NE</span> <span class="p">)</span>                      <span class="c1"># number of incident energies</span>

                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">EinInterpolationTypes</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">nStringsToInts</span><span class="p">(</span> <span class="n">NR</span><span class="p">,</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">EinInterpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">EinInterpolationTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="n">NR</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>      <span class="c1"># the next data is energy-angle distributions</span>

                <span class="n">EPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">energyAngularSubformRegion</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">XYs3d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAngularAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">EinInterpolation</span><span class="p">,</span>
                            <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>

                <span class="n">muInterpolationQualifier</span><span class="p">,</span> <span class="n">muInterpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">-</span> <span class="mi">10</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">EinCount</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NE</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">dummy</span><span class="p">,</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">ND</span><span class="p">,</span> <span class="n">NA</span><span class="p">,</span> <span class="n">NW</span><span class="p">,</span> <span class="n">NEP</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span><span class="n">dataLine</span><span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">ND</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ND</span> <span class="p">)</span>          <span class="c1"># number of discrete gammas (nonzero only for gammas)</span>
                    <span class="n">NA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NA</span> <span class="p">)</span>          <span class="c1"># number of angular parameters (i.e., the number of mu values).</span>
                    <span class="n">NW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NW</span> <span class="p">)</span>          <span class="c1"># number of data values for this incident energy</span>
                    <span class="n">NEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEP</span> <span class="p">)</span>        <span class="c1"># number of outgoing energy values</span>
                    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span><span class="p">(</span> <span class="n">ND</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Discrete gammas not support for MF=6, LAW=</span><span class="si">%d</span><span class="s1">, LANG=</span><span class="si">%d</span><span class="s1">; MT=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

                    <span class="k">if</span><span class="p">(</span> <span class="n">Ein</span> <span class="o">==</span> <span class="n">EPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;regions not implemented for MF=6, LAW=</span><span class="si">%d</span><span class="s1">, LANG=</span><span class="si">%d</span><span class="s1">; MT=</span><span class="si">%d</span><span class="s1">; Ein = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">Ein</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">EPrior</span> <span class="o">=</span> <span class="n">Ein</span>

                    <span class="n">EpF0_fOfMu</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">nFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">NW</span> <span class="o">/</span> <span class="p">(</span> <span class="n">NA</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">),</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> 
                            <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="n">NA</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">)</span>
                    <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="n">NW</span> <span class="o">-</span>  <span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>    <span class="c1"># Offset for the next incident energy</span>

                    <span class="n">fOfMu_givenEp</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolationLEP</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">EpF0_fOfMu</span> <span class="p">:</span>
                        <span class="n">Ep</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="n">f0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="n">fOfMu</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataForm</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span> <span class="p">)</span>
                        <span class="n">fOfMu</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">fOfMu</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">muInterpolation</span> <span class="p">)</span>
                        <span class="n">fOfMu_givenEp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fOfMu</span> <span class="p">)</span>

                    <span class="n">energyAngularSubformRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fOfMu_givenEp</span> <span class="p">)</span>

                <span class="n">form</span> <span class="o">=</span> <span class="n">energyAngularModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">energyAngularSubformRegion</span> <span class="p">)</span>

            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Unsupported LANG = </span><span class="si">%d</span><span class="s2"> for continuum energy-angle distribution MF = 6: ZAP = </span><span class="si">%d</span><span class="s2">, LAW = </span><span class="si">%d</span><span class="s2">: MT = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LCT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Discrete two-body must be in the center-of-mass frame: LCT = </span><span class="si">%d</span><span class="s2"> MT = </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">isTwoBody</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">LANG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;L1&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;, LANG=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">LANG</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 2, LANG = </span><span class="si">%s</span><span class="s2">; MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationE_in</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">LANG</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;LAW = 2, LANG = 0&#39;</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LANG</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewiseFromTAB2_List</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;LANG = </span><span class="si">%d</span><span class="s2"> for LAW = </span><span class="si">%d</span><span class="s2"> not supported: MT = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LANG</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">AWP</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">subform</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">recoil</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">subform</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>  <span class="c1"># charged-particle elastic scattering</span>
            <span class="k">assert</span> <span class="n">LCT</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Charged-particle elastic must be in the center-of-mass frame: LCT = </span><span class="si">%d</span><span class="s2"> MT = </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">SPI</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">]</span>
            <span class="n">LIDP</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">]</span>    <span class="c1"># identical particles?</span>
            <span class="n">info</span><span class="o">.</span><span class="n">particleSpins</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">resonancesModule</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span> <span class="n">SPI</span> <span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>                         <span class="c1"># no parity information</span>
            <span class="n">LTP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;Lists&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;L1&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;, LTP=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">LTP</span> <span class="p">)</span>
            <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolationE_in</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

            <span class="c1"># LTP flag changes interpretation of the data:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LTP</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                <span class="p">(</span><span class="n">nuclear</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">imaginary</span><span class="p">)</span> <span class="o">=</span> <span class="n">convertNuclearPlusInterferenceDataToPiecewise</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;LAW = 5, LTP = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">LTP</span><span class="p">,</span> <span class="n">LIDP</span> <span class="p">)</span>
                <span class="n">dSigma_subform</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">CoulombExpansion</span><span class="p">(</span>
                        <span class="n">nuclearTerm</span><span class="o">=</span><span class="n">nuclear</span><span class="p">,</span> <span class="n">realInterference</span><span class="o">=</span><span class="n">real</span><span class="p">,</span> <span class="n">imaginaryInterference</span><span class="o">=</span><span class="n">imaginary</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LTP</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span> <span class="s2">&quot;MF=6 LAW=5 LTP=2 not yet implemented (MT</span><span class="si">%d</span><span class="s2">)!&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LTP</span> <span class="ow">in</span> <span class="p">(</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">subform</span> <span class="o">=</span> <span class="n">convertAngularToPointwiseOrPiecewiseFromTAB2_List</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LTP</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">domainMax</span> <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">subform</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;mu cutoff should not depend on energy!&quot;</span>

                <span class="n">muCutoff</span> <span class="o">=</span> <span class="n">subform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domainMax</span>
                <span class="n">dSigma_subform</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">NuclearPlusCoulombInterference</span><span class="p">(</span>
                    <span class="n">muCutoff</span> <span class="o">=</span> <span class="n">muCutoff</span><span class="p">,</span>
                    <span class="n">effectiveCrossSection</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">effectiveCrossSection</span><span class="p">(</span> <span class="n">crossSection</span> <span class="p">),</span>
                    <span class="n">effectiveDistribution</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">effectiveDistribution</span><span class="p">(</span> <span class="n">subform</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;unknown LTP encountered for MF=6, LAW=5, MT=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>

            <span class="n">dSigma_form</span> <span class="o">=</span> <span class="n">CoulombElasticModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">dSigma_subform</span><span class="p">,</span> <span class="n">identicalParticles</span> <span class="o">=</span> <span class="p">(</span> <span class="n">LIDP</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">dSigma_form</span> <span class="o">=</span> <span class="n">dSigma_form</span>
            <span class="c1"># also make a link from &#39;normal&#39; distribution to differential part:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">referenceModule</span><span class="o">.</span><span class="n">CoulombElasticReferenceForm</span><span class="p">(</span> <span class="n">link</span><span class="o">=</span><span class="n">dSigma_form</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">APSX</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NPSX</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToFloats</span><span class="p">(</span> <span class="n">MF6Data</span><span class="p">[</span> <span class="n">dataLine</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">APSX</span> <span class="o">*=</span> <span class="n">info</span><span class="o">.</span><span class="n">massTracker</span><span class="o">.</span><span class="n">neutronMass</span>
            <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">physicalQuantityModule</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">APSX</span> <span class="p">),</span> <span class="s1">&#39;amu&#39;</span> <span class="p">)</span>
            <span class="n">energySubform</span> <span class="o">=</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">NBodyPhaseSpace</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NPSX</span> <span class="p">),</span> <span class="n">mass</span> <span class="p">)</span>
            <span class="c1"># Some data has the wrong frame, should always be com hence frames[2].</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>

        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">7</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">NEData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2Header</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">NR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="p">)</span>                    <span class="c1"># number of interpolation regions for this incident energy</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">NR</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Currently only one interpolation flag is supported for MF = 6, LAW = 7; MT = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">NEData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">angularEnergySubform</span> <span class="o">=</span> <span class="n">angularEnergyModule</span><span class="o">.</span><span class="n">XYs3d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularEnergyAxes</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span>
                    <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">NEData</span><span class="p">[</span><span class="s1">&#39;NZ&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>   <span class="c1"># Loop over incident energies</span>
                <span class="n">dataLine</span><span class="p">,</span> <span class="n">muEpPTable</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularEnergyAxes</span> <span class="p">)</span>
                <span class="n">muEpP</span> <span class="o">=</span> <span class="n">muEpPTable</span><span class="p">[</span><span class="s1">&#39;TAB2s&#39;</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">muEpP</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - need to fix&#39;</span>
                <span class="n">interpolation</span><span class="p">,</span> <span class="n">muEpP</span> <span class="o">=</span> <span class="n">muEpP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">ENDFInterpolationToGND2plusd</span><span class="p">(</span> <span class="n">muEpPTable</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">muEpP_multiD</span> <span class="o">=</span> <span class="n">angularEnergyModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">value</span> <span class="o">=</span> <span class="n">muEpPTable</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">],</span> 
                        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">,</span> <span class="n">interpolationQualifier</span> <span class="o">=</span> <span class="n">interpolationQualifier</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularEnergyAxes</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">EpP</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">muEpP</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">EpP</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - need to fix&#39;</span>
                    <span class="n">muEpP_multiD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularEnergyModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="o">.</span><span class="n">returnAsClass</span><span class="p">(</span> <span class="n">EpP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EpP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">angularEnergySubform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">muEpP_multiD</span> <span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">angularEnergyModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularEnergySubform</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">LAW</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">energyLoss</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF6Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">energyLoss</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="s1">&#39;hell - fix me&#39;</span>
            <span class="n">energyLoss</span> <span class="o">=</span> <span class="n">energyLoss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">domainMin</span> <span class="p">],</span> <span class="p">[</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">domainMax</span><span class="p">,</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">energyLoss</span> <span class="o">=</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">axes</span> <span class="p">)</span> <span class="o">-</span> <span class="n">energyLoss</span>
            <span class="n">energyDeposition</span> <span class="o">=</span> <span class="n">energyDepositionModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyDepositionAxes</span><span class="p">,</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">energyLoss</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">energyLoss</span><span class="o">.</span><span class="n">interpolation</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;LAW = </span><span class="si">%d</span><span class="s2"> not implemented: MT = </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span>  <span class="p">(</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">multiplicityData</span> <span class="o">=</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">rangeMin</span><span class="p">,</span> <span class="n">integerMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityData</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">rangeMin</span> <span class="p">)</span> <span class="o">==</span> <span class="n">rangeMin</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">integerMultiplicity</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">multiplicityData</span> <span class="p">:</span> <span class="n">integerMultiplicity</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="n">rangeMin</span> <span class="o">==</span> <span class="n">y</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">integerMultiplicity</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">rangeMin</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">multiplicityRegions</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">rangeMin</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Negative multiplicity encountered for MF6, MT</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">AWP</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="c1"># Gammas. Appear to always be stored using LAW = 1 and LANG = 1.</span>

            <span class="k">def</span> <span class="nf">addGammaProduct</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="p">)</span> <span class="p">:</span>

                <span class="n">_crossSection</span> <span class="o">=</span> <span class="n">crossSection</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">regions1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">_crossSection</span> <span class="o">=</span> <span class="n">multiplicity</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">multiplicity</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">label</span>
                        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">multiplicity</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">multiplicity</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="kc">None</span> <span class="p">)</span>
                    <span class="n">_crossSection</span> <span class="o">=</span> <span class="n">multiplicity</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> 
                        <span class="n">crossSection</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
                <span class="k">return</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>       <span class="c1"># May be required for LAW = 4 logic.</span>

            <span class="k">def</span> <span class="nf">addGammaAdjustWeight</span><span class="p">(</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span> <span class="p">)</span> <span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Have Legendre section with total multiplicity and only l=0 for discrete gammas.</span>
<span class="sd">                Convert to isotropic angular distributions, plus adjust weights.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">def</span> <span class="nf">getPointwiseMultiplicity</span><span class="p">(</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">axes</span> <span class="p">)</span> <span class="p">:</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">energy_in</span> <span class="ow">in</span> <span class="n">angularSubform</span> <span class="p">:</span>
                        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicity</span><span class="p">(</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">energy_in</span><span class="o">.</span><span class="n">value</span> <span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">energy_in</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">energy_in</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplicity</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="n">EPrior</span> <span class="o">=</span> <span class="n">energy_in</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
                    <span class="k">return</span><span class="p">(</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="p">)</span>

                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">angularSubform</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="kc">None</span> <span class="p">)</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">EPrior</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getPointwiseMultiplicity</span><span class="p">(</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">angularSubform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">axes</span> <span class="p">)</span>
                    <span class="n">multiplicity</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span>
                <span class="k">elif</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">regions1d</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span> <span class="p">)</span>
                    <span class="n">EPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">angularSubform</span> <span class="p">:</span>
                        <span class="n">EPrior</span><span class="p">,</span> <span class="n">multiplicityRegion</span> <span class="o">=</span> <span class="n">getPointwiseMultiplicity</span><span class="p">(</span> <span class="n">region</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">axes</span> <span class="p">)</span>
                        <span class="n">multiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">multiplicityRegion</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Unsupport angular subform = &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">angularSubform</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>

                <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> 
                        <span class="n">multiplicity</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>

                <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>
                <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
                <span class="k">return</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>       <span class="c1"># May be required for LAW = 4 logic.</span>

            <span class="k">def</span> <span class="nf">addPrimaryOrDiscreteGamma</span><span class="p">(</span> <span class="n">distinctType</span><span class="p">,</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">ELegenres</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span> <span class="p">:</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">distinctType</span> <span class="o">==</span> <span class="s1">&#39;discrete&#39;</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">energySubform</span> <span class="o">=</span> <span class="n">discreteOrPrimaryGamma</span><span class="p">(</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">discreteGamma</span><span class="p">,</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">energySubform</span> <span class="o">=</span> <span class="n">discreteOrPrimaryGamma</span><span class="p">(</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">primaryGamma</span><span class="p">,</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span>

                <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
                <span class="n">EPrior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">maxLegendre</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">angularRegion</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">regions2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="p">(</span> <span class="n">energy</span><span class="p">,</span> <span class="n">coefficients</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">ELegenres</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">maxLegendre</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="n">maxLegendre</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">coefficients</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">energy</span> <span class="o">==</span> <span class="n">EPrior</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">angularRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularSubform</span> <span class="p">)</span>
                        <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">XYs2d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span>
                    <span class="n">angularSubform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span> <span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">angularAxes</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">EPrior</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">angularRegion</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">angularRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">angularSubform</span> <span class="p">)</span>
                    <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularRegion</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">maxLegendre</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>    <span class="c1"># Only have l=0 for each incident energy. Distribution needs to be normalized.</span>
                    <span class="k">return</span><span class="p">(</span> <span class="n">addGammaAdjustWeight</span><span class="p">(</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span> <span class="p">)</span> <span class="p">)</span>

                <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>

                <span class="k">return</span><span class="p">(</span> <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span> <span class="p">)</span> <span class="p">)</span>

            <span class="n">totalGammaMultiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span>               <span class="c1"># Makes the name more explicit.</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">totalMF6_12_13Gammas</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">6</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="p">]</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>                       <span class="c1"># Continuum gamma present</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">discreteGammas</span> <span class="ow">or</span> <span class="n">discretePrimaryGammas</span> <span class="p">)</span> <span class="p">:</span>

                    <span class="k">def</span> <span class="nf">fixContinuumGammaSpectrum</span><span class="p">(</span> <span class="n">energyDist</span> <span class="p">)</span> <span class="p">:</span>

                        <span class="n">EpPrior</span> <span class="o">=</span> <span class="mi">2</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
                        <span class="n">energyDist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span> <span class="p">)</span>            <span class="c1"># Make distribution with small probability near 0.</span>
                        <span class="n">energyDist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">EpPrior</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">energyDist</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">Ep</span><span class="p">,</span> <span class="n">P1</span> <span class="o">=</span> <span class="n">energyDist</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">Ep</span> <span class="o">&lt;</span> <span class="n">EpPrior</span> <span class="p">)</span> <span class="p">:</span> <span class="n">Ep</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">EpPrior</span>
                            <span class="n">EpPrior</span> <span class="o">=</span> <span class="n">Ep</span>
                            <span class="n">energyDist</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">Ep</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>

                    <span class="k">if</span><span class="p">(</span>   <span class="nb">isinstance</span><span class="p">(</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">newMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">totalGammaMultiplicity</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                                <span class="n">interpolation</span> <span class="o">=</span> <span class="n">totalGammaMultiplicity</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                    <span class="k">elif</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">regionsModule</span><span class="o">.</span><span class="n">regions</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">newMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">regions1d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">totalGammaMultiplicity</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Unsupported multiplicity form &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">totalGammaMultiplicity</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">energySubform</span><span class="p">,</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">XYs2d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">energySubform</span> <span class="o">=</span> <span class="p">[</span> <span class="n">energySubform</span> <span class="p">]</span>
                    <span class="n">EPrior</span> <span class="o">=</span> <span class="n">energySubform</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">energySubform</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">energyDist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">region</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="n">Ein</span> <span class="o">=</span> <span class="n">energyDist</span><span class="o">.</span><span class="n">value</span>
                            <span class="n">integral</span> <span class="o">=</span> <span class="n">energyDist</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span> <span class="p">)</span>
                            <span class="k">if</span><span class="p">(</span> <span class="n">integral</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">continuumSpectraFix</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Zero norm continuum gamma spectrum energies = </span><span class="si">%s</span><span class="s2"> (MT=</span><span class="si">%d</span><span class="s2">). Try option &#39;continuumSpectraFix&#39;&quot;</span> <span class="o">%</span>
                                            <span class="p">(</span> <span class="n">energyDist</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                                <span class="n">fixContinuumGammaSpectrum</span><span class="p">(</span> <span class="n">energyDist</span> <span class="p">)</span>
                                <span class="n">integral</span> <span class="o">=</span> <span class="n">energyDist</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span> <span class="p">)</span>
                            <span class="k">if</span><span class="p">(</span>   <span class="nb">isinstance</span><span class="p">(</span> <span class="n">newMultiplicity</span><span class="p">,</span> <span class="n">XYsModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="n">newMultiplicity</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">getMultiplicity</span><span class="p">(</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">Ein</span> <span class="p">)</span> <span class="o">*</span> <span class="n">integral</span> <span class="p">)</span>
                            <span class="k">elif</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">newMultiplicity</span><span class="p">,</span> <span class="n">regionsModule</span><span class="o">.</span><span class="n">regions</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">Ein</span> <span class="o">==</span> <span class="n">EPrior</span> <span class="p">)</span> <span class="p">:</span>
                                    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">i1</span> <span class="o">+</span> <span class="n">i2</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">newMultiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">newRegionMultiplicity</span> <span class="p">)</span>
                                    <span class="n">newRegionMultiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">XYs1d</span><span class="p">(</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">totalGammaMultiplicity</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">)</span>
                                <span class="n">newRegionMultiplicity</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">getMultiplicity</span><span class="p">(</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">EPrior</span><span class="p">,</span> <span class="n">Ein</span> <span class="p">)</span> <span class="o">*</span> <span class="n">integral</span> <span class="p">)</span>
                            <span class="n">region</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span> <span class="p">)</span>
                            <span class="n">EPrior</span> <span class="o">=</span> <span class="n">Ein</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">energySubform</span><span class="p">,</span> <span class="nb">list</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">energySubform</span> <span class="o">=</span> <span class="n">energySubform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">productFrame</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">angularSubform</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">newMultiplicity</span><span class="p">,</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">regions1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">newMultiplicity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">newRegionMultiplicity</span> <span class="p">)</span>
                    <span class="n">product</span> <span class="o">=</span> <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">newMultiplicity</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">product</span> <span class="o">=</span> <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">form</span><span class="p">,</span> <span class="n">totalGammaMultiplicity</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">Eg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">addPrimaryOrDiscreteGamma</span><span class="p">(</span> <span class="s1">&#39;discrete&#39;</span><span class="p">,</span> <span class="n">Eg</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">[</span><span class="n">Eg</span><span class="p">],</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">EgEinPs</span> <span class="ow">in</span> <span class="n">discretePrimaryGammas</span> <span class="p">:</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">addPrimaryOrDiscreteGamma</span><span class="p">(</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="n">EgEinPs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EgEinPs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">totalGammaMultiplicity</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>                          <span class="c1"># Non gamma particle.</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">90</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="n">info</span><span class="o">.</span><span class="n">targetZA</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="c1"># for isomeric targets, need to adjust the product level: MT51 goes to ground state, etc.</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">50</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="p">)</span> <span class="p">:</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s1">&#39;levelIndex&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">thisParticle</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LIP</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">thisParticleBaseName</span> <span class="o">=</span> <span class="n">thisParticle</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">thisParticle</span><span class="p">,</span> <span class="n">nuclearLevelPoPsModule</span><span class="o">.</span><span class="n">particle</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">thisParticleBaseName</span> <span class="o">=</span> <span class="n">thisParticle</span><span class="o">.</span><span class="n">getAncestor</span><span class="p">(</span> <span class="p">)</span><span class="o">.</span><span class="n">id</span>
                <span class="n">metaStableName</span> <span class="o">=</span> <span class="n">aliasModule</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">nuclearMetaStableName</span><span class="p">(</span> <span class="n">thisParticleBaseName</span><span class="p">,</span> <span class="n">LIP</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">metaStableName</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">PoPs</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">levelName</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">PoPs</span><span class="p">[</span> <span class="n">metaStableName</span> <span class="p">]</span><span class="o">.</span><span class="n">pid</span>
                    <span class="n">thisParticle</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">PoPs</span><span class="p">[</span><span class="n">levelName</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">try</span> <span class="p">:</span>
                        <span class="n">levelIndex</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">metaStableData</span><span class="p">[</span><span class="n">metaStableName</span><span class="p">]</span>
                        <span class="n">thisParticle</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">levelIndex</span> <span class="p">)</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">PoPs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">PoPsAliasModule</span><span class="o">.</span><span class="n">metaStable</span><span class="p">(</span> <span class="n">metaStableName</span><span class="p">,</span> <span class="n">thisParticle</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">LIP</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">except</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span> <span class="s1">&#39;Meta stable data not available for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metaStableName</span> <span class="p">)</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">thisParticle</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">energyDeposition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">energyDeposition</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">energyDeposition</span> <span class="p">)</span>

            <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">isLegendreConvertedToEnergy</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;MF6&#39;</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">discreteGammas</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;interpolation </span><span class="si">%s</span><span class="s1"> is not linear for gamma multiplicity&#39;</span> <span class="o">%</span> <span class="n">productData</span><span class="p">[</span><span class="s1">&#39;interpolationInfo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productList</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;MF6&#39;</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">projectile</span> <span class="ow">in</span> <span class="p">(</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;MF6&#39;</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF8_454_459"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF8_454_459">[docs]</a><span class="k">def</span> <span class="nf">readMF8_454_459</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="s2">&quot;Parse fission yield data.&quot;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">454</span><span class="p">,</span> <span class="mi">459</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;MT most be 454 or 459, not </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
    <span class="n">MF8Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LE1</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF8Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">iLine</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">allData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">iLE</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">LE1</span> <span class="p">):</span>
        <span class="n">iLine</span><span class="p">,</span> <span class="n">thisData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="n">iLine</span><span class="p">,</span> <span class="n">MF8Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">NFP</span> <span class="o">=</span> <span class="n">thisData</span><span class="p">[</span> <span class="s1">&#39;N2&#39;</span> <span class="p">]</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">thisData</span><span class="p">[</span> <span class="s1">&#39;C1&#39;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">iFP</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">NFP</span> <span class="p">):</span>
            <span class="n">ZAFP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">thisData</span><span class="p">[</span> <span class="s1">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">FPS</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span> <span class="n">thisData</span><span class="p">[</span> <span class="s1">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span>    <span class="n">thisData</span><span class="p">[</span> <span class="s1">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">]</span>
            <span class="n">DY</span> <span class="o">=</span>   <span class="n">thisData</span><span class="p">[</span> <span class="s1">&#39;data&#39;</span> <span class="p">][</span> <span class="n">iFP</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ZAFP</span><span class="p">,</span> <span class="n">FPS</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allData</span> <span class="p">)</span> <span class="p">:</span> <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">allData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">E</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">DY</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">allData</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF8"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF8">[docs]</a><span class="k">def</span> <span class="nf">readMF8</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="s2">&quot;Regular decay data.&quot;</span>

    <span class="n">firstLMF</span><span class="p">,</span> <span class="n">radioactiveDatas</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">8</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF8Data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">LISO</span><span class="p">,</span> <span class="n">NS</span><span class="p">,</span> <span class="n">NO</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF8Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
        <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
        <span class="n">MF9Data</span> <span class="o">=</span> <span class="n">readMF9or10</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">MF10Data</span> <span class="o">=</span> <span class="n">readMF9or10</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">metastables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NS</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">ZAP</span><span class="p">,</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">LFS</span><span class="p">,</span> <span class="n">ND6</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF8Data</span><span class="p">[</span><span class="n">dataLine</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">ZAP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metastables</span> <span class="p">)</span> <span class="p">:</span> <span class="n">metastables</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LFS</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ELFS</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">MT</span><span class="o">==</span><span class="mi">18</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Encountered MT=18 MF=8/10 data (not yet accepted in ENDF format). See option --ignoreMF10Fission&quot;</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">ignoreMF10Fission</span><span class="p">:</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,[])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;MF8 claims non-zero ELFS = </span><span class="si">%s</span><span class="s2"> for the ground state, MT = </span><span class="si">%s</span><span class="s2">. Converting ELFS to 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ELFS</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">ELFS</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ELFS</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">metastables</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">firstLMF</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">firstLMF</span> <span class="o">=</span> <span class="n">LMF</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">!=</span> <span class="n">firstLMF</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;LMF changing from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> is not allowed&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">firstLMF</span><span class="p">,</span> <span class="n">LMF</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">dataLine</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">crossSection</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span>
            <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">:</span>  <span class="c1"># multiplicity in MF6, which hasn&#39;t been read. Set multiplicity to &#39;unknown&#39;, to be overridden later.</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">unknown</span><span class="p">(</span> <span class="s1">&#39;eval&#39;</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LMF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">MF9Data</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">MF10Data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>    <span class="c1"># BRB ????? Why are we checking for bad data.</span>
                    <span class="n">LMF1</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">10</span> <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="k">else</span> <span class="mi">9</span> <span class="p">)</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;LMF = </span><span class="si">%d</span><span class="s1">, but no MF</span><span class="si">%d</span><span class="s1"> found for MT</span><span class="si">%d</span><span class="s1">. Trying LMF=</span><span class="si">%d</span><span class="s1"> instead&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">LMF1</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span> <span class="n">LMF1</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">MF9Data</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">LMF1</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">MF10Data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="c1"># neither MF9 or MF10 exist.</span>
                        <span class="k">continue</span>
                    <span class="n">LMF</span> <span class="o">=</span> <span class="n">LMF1</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LMF</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">TAB1</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">MF9Data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">TAB1</span><span class="p">,</span> <span class="n">crossSection</span> <span class="o">=</span> <span class="n">MF10Data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">IZAP</span><span class="p">,</span> <span class="n">LFS9or10</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">],</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">ELFS9or10</span> <span class="o">=</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ELFS</span> <span class="o">-</span> <span class="n">ELFS9or10</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ELFS</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;MF8 residual level energy = </span><span class="si">%s</span><span class="s2"> for level </span><span class="si">%s</span><span class="s2"> of ZA = </span><span class="si">%d</span><span class="s2"> not close to MF</span><span class="si">%s</span><span class="s2">&#39;s value = </span><span class="si">%s</span><span class="s2"> for MT = </span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">LMF</span><span class="p">,</span> <span class="n">ELFS9or10</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LFS</span> <span class="o">!=</span> <span class="n">LFS9or10</span> <span class="p">):</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MF8 claims level index = </span><span class="si">%d</span><span class="s2"> but MF9/10 claim level index = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LFS</span><span class="p">,</span> <span class="n">LFS9or10</span><span class="p">))</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

            <span class="n">radioactiveDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">LFS</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">LFS</span><span class="p">,</span> <span class="n">QI</span> <span class="p">]</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">metastables</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">ZAP</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">ELFS</span><span class="p">,</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">LFS</span> <span class="p">)</span>
                <span class="n">residualName</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">getAncestor</span><span class="p">(</span> <span class="p">)</span><span class="o">.</span><span class="n">id</span>
                <span class="n">aliasName</span> <span class="o">=</span> <span class="n">aliasModule</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">nuclearMetaStableName</span><span class="p">(</span> <span class="n">residualName</span><span class="p">,</span> <span class="n">metastables</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="p">)</span> <span class="c1"># FIXME use PoPs method instead</span>
                <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">aliasName</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">PoPs</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">PoPs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">PoPsAliasModule</span><span class="o">.</span><span class="n">metaStable</span><span class="p">(</span> <span class="n">aliasName</span><span class="p">,</span> <span class="n">residual</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">metastables</span><span class="p">[</span><span class="n">ZAP</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">NO</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">dataLine</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">ND6</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">firstLMF</span><span class="p">,</span> <span class="n">radioactiveDatas</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF9or10"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF9or10">[docs]</a><span class="k">def</span> <span class="nf">readMF9or10</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">targetLIS</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MTData</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="kc">None</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">MFData</span><span class="p">,</span> <span class="n">MF9or10</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="n">MF</span><span class="p">],</span> <span class="p">[]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NS</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MFData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LIS</span> <span class="o">!=</span> <span class="n">targetLIS</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;residual&#39;s LIS = </span><span class="si">%s</span><span class="s2"> does not match target&#39;s LIS = </span><span class="si">%s</span><span class="s2">: MT=</span><span class="si">%d</span><span class="s2">, MF=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">targetLIS</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">crossSectionAxes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">labelsUnits</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;energy_in&#39;</span> <span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">),</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;weight&#39;</span> <span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NS</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MFData</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">crossSectionModule</span><span class="o">.</span><span class="n">XYs1d</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">XSec</span> <span class="o">=</span> <span class="n">getCrossSectionForm</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">XSec</span> <span class="o">=</span> <span class="n">regions</span>
        <span class="n">MF9or10</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">XSec</span> <span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">MF9or10</span>  <span class="p">)</span></div>

<div class="viewcode-block" id="readMF12_13"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF12_13">[docs]</a><span class="k">def</span> <span class="nf">readMF12_13</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">_dummyCrossSection</span><span class="p">,</span> <span class="n">gammaBRTolerance</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">def</span> <span class="nf">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">gList</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;EGk is the gamma&#39;s energy and ESk is the gamma&#39;s origination level energy.&quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">EGk</span> <span class="ow">in</span> <span class="n">gList</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;Gammas with the same energy (</span><span class="si">%s</span><span class="s1">) are not supported: MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">gList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;EGk&#39;</span> <span class="p">:</span> <span class="n">EGk</span><span class="p">,</span> <span class="s1">&#39;ESk&#39;</span> <span class="p">:</span> <span class="n">ESk</span><span class="p">,</span> <span class="s1">&#39;LP&#39;</span> <span class="p">:</span> <span class="n">LP</span><span class="p">,</span> <span class="s1">&#39;LF&#39;</span> <span class="p">:</span> <span class="n">LF</span><span class="p">,</span> <span class="s1">&#39;yield&#39;</span> <span class="p">:</span> <span class="n">regions</span><span class="p">,</span> <span class="s1">&#39;angularSubform&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;energySubform&#39;</span> <span class="p">:</span> <span class="kc">None</span> <span class="p">}</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;angularSubform&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">angularSubform</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;angularSubform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angularSubform</span>

    <span class="k">def</span> <span class="nf">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">ESk</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">yields</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">yields</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">13</span> <span class="p">)</span> <span class="p">:</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">_temp_divideByCrossSection</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;ESk&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;originationLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">PQU</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">ESk</span> <span class="p">),</span> <span class="s2">&quot;eV&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span> <span class="n">keepPeriod</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="n">multiplicity</span><span class="p">,</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="p">)</span>

        <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;angularSubform&#39;</span><span class="p">]</span>
        <span class="n">energySubform</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;energySubform&#39;</span><span class="p">]</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">13</span> <span class="p">)</span> <span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;ENDFconversionFlag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MF13&#39;</span>
        <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="mi">12</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="mi">13</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;MF = 12 and 13 present for MT=</span><span class="si">%s</span><span class="s1">, this is not supported&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="n">MF</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">13</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">MF</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="mi">14</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">15</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MF 14 and/or 15 data and no MF 12 or 13 data: MT=</span><span class="si">%s</span><span class="s1"> MFs=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">return</span>

    <span class="n">MF12_13Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="n">MF</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LO</span><span class="p">,</span> <span class="n">LG</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF12_13Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39; : MF=</span><span class="si">%s</span><span class="s1"> LO=</span><span class="si">%s</span><span class="s1"> : ZAP=0 &#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">LO</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">branchingGammas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LO</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">13</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LO</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">multiplicityAxes</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">crossSectionAxes</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NK</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF12_13Data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">totalMF6_12_13Gammas</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">MF</span><span class="p">,</span> <span class="n">getMultiplicityPointwiseOrPieceWise</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NK</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">TAB1</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1Regions</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF12_13Data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span> <span class="o">=</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">],</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="nb">int</span><span class="p">(</span> <span class="n">TAB1</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">EGk</span> <span class="o">==</span> <span class="mf">0.</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">LP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;LP = </span><span class="si">%s</span><span class="s1"> != 0 for continuous gamma for MT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LP</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;continuous gamma information for MF=</span><span class="si">%s</span><span class="s1">, MT = </span><span class="si">%s</span><span class="s1"> already exist&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="n">LP</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">addMF12_13GammaToList</span><span class="p">(</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">regions</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">MF</span> <span class="o">==</span> <span class="mi">12</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LO</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">dataLine</span><span class="p">,</span> <span class="n">LO2</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF12_13Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
        <span class="n">LP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">LP</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Incorrect &#39;primary gamma&#39; flag for MF12 MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span><span class="p">)</span>
        <span class="n">NT</span><span class="p">,</span> <span class="n">LGp</span> <span class="o">=</span> <span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;N2&#39;</span><span class="p">],</span> <span class="n">LG</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">NK</span> <span class="o">=</span> <span class="n">NT</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NT</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">parentEnergy</span><span class="p">,</span> <span class="n">finalEnergy</span> <span class="o">=</span> <span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">],</span> <span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="n">LGp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parentEnergy</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Gamma decay from ground state in MF12 MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MT</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">parentEnergy</span><span class="o">-</span><span class="n">finalEnergy</span><span class="p">)</span><span class="o">/</span><span class="n">parentEnergy</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0001</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Zero-energy gamma from </span><span class="si">%f</span><span class="s2"> eV to </span><span class="si">%f</span><span class="s2"> eV in MF12 MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parentEnergy</span><span class="p">,</span><span class="n">finalEnergy</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
            <span class="n">branchingGammas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;ES&#39;</span> <span class="p">:</span> <span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">],</span> <span class="s1">&#39;EGk&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ESk&#39;</span> <span class="p">:</span> <span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="n">LGp</span><span class="p">],</span> <span class="s1">&#39;angularSubform&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="s1">&#39;branching&#39;</span> <span class="p">:</span> <span class="n">LO2</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">*</span><span class="n">LGp</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span><span class="o">*</span><span class="n">LGp</span><span class="o">+</span><span class="n">LGp</span><span class="p">]}</span> <span class="p">)</span>
        <span class="n">gammaBRList</span> <span class="o">=</span> <span class="p">[</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;branching&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">branchingGammas</span> <span class="p">]</span>
        <span class="n">sumGammaBRList</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">gammaBRList</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">sumGammaBRList</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">gammaBRTolerance</span><span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;sum of gamma BR&#39;s for MT=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">MT</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; MF=12 is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sumGammaBRList</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; != 1.0&#39;</span> <span class="p">)</span>
            <span class="c1"># leave re-normalization for checker/fixer codes</span>
            <span class="c1">#for i in xrange( len( branchingGammas ) ): branchingGammas[ i ][ &#39;branching&#39; ][ 0 ] /= sumGammaBRList</span>
        <span class="n">info</span><span class="o">.</span><span class="n">MF12_LO2</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="n">branchingGammas</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;LO=</span><span class="si">%s</span><span class="s1"> is not valid for MF=</span><span class="si">%s</span><span class="s1">, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LO</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">readMF14</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">branchingGammas</span> <span class="p">)</span>
    <span class="n">readMF15</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">branchingGammas</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;angularSubform&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;NON-isotropic gamma&#39;</span> <span class="p">)</span>
            <span class="k">break</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">14</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;: MF=14 &#39;</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">15</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;: MF=15 &#39;</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">continuousGamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">crossSection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">crossSection</span> <span class="o">=</span> <span class="n">dummyCrossSection</span><span class="p">(</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">regions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">domainMax</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span>
        <span class="n">_dummyCrossSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">crossSection</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">discreteGammas</span> <span class="p">:</span>
        <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;energySubform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discreteOrPrimaryGamma</span><span class="p">(</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">discreteGamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;EGk&#39;</span><span class="p">],</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span>
        <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">primaryGammas</span> <span class="p">:</span>
        <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;energySubform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discreteOrPrimaryGamma</span><span class="p">(</span> <span class="n">energyModule</span><span class="o">.</span><span class="n">primaryGamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;EGk&#39;</span><span class="p">],</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMax</span> <span class="p">)</span>
        <span class="n">addGammaProduct</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">branchingGammas</span> <span class="p">:</span> <span class="n">checkAngularData</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF14"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF14">[docs]</a><span class="k">def</span> <span class="nf">readMF14</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">discreteGammas</span><span class="p">,</span> <span class="n">primaryGammas</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">branchingGammas</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">allGammas</span> <span class="o">=</span> <span class="n">discreteGammas</span> <span class="o">+</span> <span class="n">primaryGammas</span> <span class="o">+</span> <span class="n">continuousGamma</span> <span class="o">+</span> <span class="n">branchingGammas</span>

    <span class="k">def</span> <span class="nf">addAngularData</span><span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">subform</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">possibleGammas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">allGammas</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">EGk</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;EGk&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ESk</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">possibleGammas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">gamma</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">possibleGammas</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;MF = 14 gamma data: EGk = </span><span class="si">%s</span><span class="s2">, ESk = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;MF = </span><span class="si">%s</span><span class="s1"> gamma list is,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MF</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">allGammas</span> <span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;    EGk = </span><span class="si">%s</span><span class="s2">, ESk = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;EGk&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;ESk&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;No matching gamma from MF = </span><span class="si">%s</span><span class="s1"> found for MF = 14 gamma: MT=</span><span class="si">%s</span><span class="s1">: see above&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">possibleGammas</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Multiple possible gammas found for MF=14 data: EGk=</span><span class="si">%s</span><span class="s1">, ESk=</span><span class="si">%s</span><span class="s1">, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">possibleGammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;angularSubform&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">gamma</span><span class="p">[</span><span class="s1">&#39;angularSubform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subform</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Gamma already has MF=14 angular data: EGk=</span><span class="si">%s</span><span class="s1">, ESk=</span><span class="si">%s</span><span class="s1">, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="mi">14</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span>
    <span class="n">MF14Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LTT</span><span class="p">,</span> <span class="n">NK14</span><span class="p">,</span> <span class="n">NI</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF14Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">NK14</span> <span class="o">!=</span> <span class="n">NK</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">info</span><span class="o">.</span><span class="n">printBadNK14</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;MF14 NK = </span><span class="si">%s</span><span class="s1"> != MF12/13 NK = </span><span class="si">%s</span><span class="s1"> for MT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">NK14</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">NI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">labToken</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                                     <span class="c1"># All distributions are isotropic</span>
        <span class="k">pass</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">LTT</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span> <span class="n">NK14</span> <span class="o">-</span> <span class="n">NI</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">dataLine</span><span class="p">,</span> <span class="n">angularData</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_Lists</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF14Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;Currently only one interpolation flag is supported: NR=</span><span class="si">%s</span><span class="s1">, MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">],</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span> <span class="o">=</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;C1&#39;</span><span class="p">],</span> <span class="n">angularData</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span>
            <span class="n">subform</span> <span class="o">=</span> <span class="n">angularLegendreToPointwiseOrPiecewiseLegendre</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">angularData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;LTT = 1&#39;</span> <span class="p">)</span>
            <span class="n">addAngularData</span><span class="p">(</span> <span class="n">EGk</span><span class="p">,</span> <span class="n">ESk</span><span class="p">,</span> <span class="n">subform</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;MF=14, LI=</span><span class="si">%s</span><span class="s1"> not implemented&#39;</span> <span class="o">%</span> <span class="n">LI</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF15"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF15">[docs]</a><span class="k">def</span> <span class="nf">readMF15</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">continuousGamma</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span><span class="p">(</span> <span class="mi">15</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MTData</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;Continous gamma with no MF=15 data: MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">continuousGamma</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;MF=15 data and no continous gamma MF=12,13 data: MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">MF15Data</span> <span class="o">=</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">NC</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">sixFunkyFloatStringsToIntsAndFloats</span><span class="p">(</span> <span class="n">MF15Data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="n">printAWR_mode</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">NC</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;NC = </span><span class="si">%s</span><span class="s1"> &gt; 1 is not supported: MT=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">NC</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">dataLine</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB1</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MF15Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">Ein</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">weight</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;For MF15 data weight other than 1 is not currently supportd: MT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>

    <span class="n">LF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">LF</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;For MF=15 data, only LF=1 is currently supported, not LF=</span><span class="si">%s</span><span class="s1"> : MT</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">dataLine</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">getTAB2_TAB1s</span><span class="p">(</span> <span class="n">dataLine</span><span class="p">,</span> <span class="n">MF15Data</span><span class="p">,</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">energyAxes</span> <span class="p">)</span>
    <span class="n">continuousGamma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;energySubform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">toPointwiseOrPiecewiseEnergy</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">EEpETable</span> <span class="p">)</span></div>

<div class="viewcode-block" id="genID"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.genID">[docs]</a><span class="k">def</span> <span class="nf">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">MF2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">MAT2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">QI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">QI2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linkType</span><span class="o">=</span><span class="s1">&#39;rowColumn&#39;</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For covariances we need a unique id for each section, and also need link info.</span>
<span class="sd">    This is messy: lots of special cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">evalStyle</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">]</span>
    <span class="n">MTdict</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTdict&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">getReaction</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">QI</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="c1"># find the &lt;reaction&gt; corresponding to this covariance info, if any</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">452</span><span class="p">,</span><span class="mi">455</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">multiplicitySum</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;multiplicitySums&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">multiplicitySum</span><span class="o">.</span><span class="n">ENDF_MT</span> <span class="o">==</span> <span class="n">MT</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">multiplicitySum</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">456</span><span class="p">:</span>
            <span class="n">MT</span> <span class="o">=</span> <span class="mi">18</span> <span class="c1"># redirect prompt nubar to fission</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">MTdict</span><span class="p">:</span>
            <span class="n">chThisMT</span> <span class="o">=</span> <span class="n">MTdict</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chThisMT</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chThisMT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">40</span><span class="p">:</span>   <span class="c1"># MF40 section may contain covariances for multiple excited states of residual</span>
                <span class="n">thisChannel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chThisMT</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">productionModule</span><span class="o">.</span><span class="n">production</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ch</span><span class="o">.</span><span class="n">getQ</span><span class="p">(</span><span class="s1">&#39;eV&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">QI</span> <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thisChannel</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">thisChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">:</span>
                    <span class="c1"># Q-values disagree between MF10/MF40. Assume 1st covariance is for lowest-energy residual, etc</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>
                    <span class="n">cov_info</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cov_info</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">thisChannel</span><span class="p">[</span> <span class="n">index</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">33</span><span class="p">:</span>
                <span class="c1"># residual must be in ground state unless MT in 51-90, etc</span>
                <span class="n">thisChannel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chThisMT</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">reactionModule</span><span class="o">.</span><span class="n">reaction</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">getLevelAsFloat</span><span class="p">(</span><span class="s1">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ch</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">]</span> <span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">sumsModule</span><span class="o">.</span><span class="n">crossSectionSum</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thisChannel</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;MF33 MT</span><span class="si">%d</span><span class="s2"> covariance doesn&#39;t correspond to any channel!&quot;</span>
                        <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">thisChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Can&#39;t determine which reaction this covariance (MF</span><span class="si">%d</span><span class="s2"> MT</span><span class="si">%d</span><span class="s2">) corresponds to!&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MF</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">rowReaction</span> <span class="o">=</span> <span class="n">getReaction</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">QI</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">makeID</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="n">reaction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Id = str( reaction.outputChannel )</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">reaction</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">452</span><span class="p">,</span><span class="mi">455</span><span class="p">,</span><span class="mi">456</span><span class="p">):</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">452</span> <span class="p">:</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">455</span> <span class="p">:</span> <span class="n">tokensModule</span><span class="o">.</span><span class="n">delayedToken</span><span class="p">,</span> <span class="mi">456</span> <span class="p">:</span> <span class="n">tokensModule</span><span class="o">.</span><span class="n">promptToken</span> <span class="p">}[</span><span class="n">MT</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">107</span><span class="p">):</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="s1">&#39;sum(z,n)&#39;</span><span class="p">,</span> <span class="mi">103</span><span class="p">:</span><span class="s1">&#39;sum(z,p)&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">:</span><span class="s1">&#39;sum(z,d)&#39;</span><span class="p">,</span>
                    <span class="mi">105</span><span class="p">:</span><span class="s1">&#39;sum(z,t)&#39;</span><span class="p">,</span> <span class="mi">106</span><span class="p">:</span><span class="s1">&#39;sum(z,He3)&#39;</span><span class="p">,</span> <span class="mi">107</span><span class="p">:</span><span class="s1">&#39;sum(z,a)&#39;</span><span class="p">}[</span><span class="n">MT</span><span class="p">]</span>
        <span class="k">elif</span> <span class="mi">850</span> <span class="o">&lt;</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">871</span><span class="p">:</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="s2">&quot;lump</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MT</span><span class="o">-</span><span class="mi">851</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">Id</span> <span class="o">=</span> <span class="s2">&quot;MF</span><span class="si">%d</span><span class="s2">_MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Id</span>

    <span class="n">rowId</span> <span class="o">=</span> <span class="n">makeID</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">rowReaction</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">MAT2</span><span class="p">:</span>
        <span class="c1"># cross-material covariance</span>
        <span class="n">colReaction</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># must create an &#39;externalReaction&#39; and link to it below</span>
        <span class="n">versus</span> <span class="o">=</span> <span class="s1">&#39; vs. &#39;</span>
        <span class="n">colId</span> <span class="o">=</span> <span class="s2">&quot;MAT</span><span class="si">%d</span><span class="s2">_MF</span><span class="si">%d</span><span class="s2">_MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MAT2</span><span class="p">,</span><span class="n">MF2</span><span class="p">,</span><span class="n">MT2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">MT2</span> <span class="ow">and</span> <span class="n">MT2</span><span class="o">!=</span><span class="n">MT</span><span class="p">):</span>
        <span class="n">MF2</span> <span class="o">=</span> <span class="n">MF2</span> <span class="ow">or</span> <span class="n">MF</span>
        <span class="n">colReaction</span> <span class="o">=</span> <span class="n">getReaction</span><span class="p">(</span> <span class="n">MT2</span><span class="p">,</span> <span class="n">MF2</span><span class="p">,</span> <span class="n">QI2</span> <span class="p">)</span>
        <span class="n">versus</span> <span class="o">=</span> <span class="s1">&#39; vs. &#39;</span>
        <span class="n">colId</span> <span class="o">=</span> <span class="n">makeID</span><span class="p">(</span> <span class="n">MT2</span><span class="p">,</span> <span class="n">colReaction</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colId</span> <span class="o">=</span> <span class="n">versus</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">qualifier</span> <span class="o">=</span> <span class="p">{</span><span class="mi">31</span><span class="p">:</span><span class="s1">&#39; [nubar]&#39;</span><span class="p">,</span> <span class="mi">33</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">34</span><span class="p">:</span><span class="s1">&#39; [angular distribution]&#39;</span><span class="p">,</span> <span class="mi">35</span><span class="p">:</span><span class="s1">&#39; [spectrum]&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}[</span><span class="n">MF</span><span class="p">]</span>
    <span class="n">ID</span> <span class="o">=</span> <span class="n">rowId</span> <span class="o">+</span> <span class="n">versus</span> <span class="o">+</span> <span class="n">colId</span> <span class="o">+</span> <span class="n">qualifier</span>

    <span class="sd">&quot;&quot;&quot; also, create links from covariances to data. If we&#39;re trying to point to nonexistant data</span>
<span class="sd">    (ie for lumped channels), make a &#39;fake channel&#39; &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>   <span class="c1"># should hold file for covariances</span>
    <span class="k">def</span> <span class="nf">makeLink</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">MAT2</span><span class="p">,</span> <span class="n">linkClass</span> <span class="p">):</span>
        <span class="n">link_</span> <span class="o">=</span> <span class="n">linkClass</span><span class="p">(</span><span class="n">ENDF_MFMT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">33</span><span class="p">,</span><span class="mi">40</span><span class="p">):</span>
                <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">crossSection</span><span class="p">[</span><span class="n">evalStyle</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link_</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">crossSectionModule</span><span class="o">.</span><span class="n">resonancesWithBackground</span><span class="p">):</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">link_</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">tabulatedData</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">31</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reaction</span><span class="p">,</span> <span class="n">sumsModule</span><span class="o">.</span><span class="n">multiplicitySum</span><span class="p">):</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">[</span><span class="n">evalStyle</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">[</span><span class="n">evalStyle</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">34</span><span class="p">:</span>
                <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span><span class="n">evalStyle</span><span class="p">]</span><span class="o">.</span><span class="n">subforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">MF</span><span class="o">==</span><span class="mi">35</span><span class="p">:</span>
                <span class="n">distribution</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span><span class="n">evalStyle</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">uncorrelatedModule</span><span class="o">.</span><span class="n">form</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">energySubform</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">distribution</span>
        <span class="k">elif</span> <span class="n">MAT2</span><span class="p">:</span>
            <span class="c1"># cross-material covariance: get other isotope from the MAT number</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">otherTarget</span> <span class="o">=</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">getParticleNameFromMAT</span><span class="p">(</span> <span class="n">MAT2</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Encountered illegal MAT number </span><span class="si">%d</span><span class="s2"> in covariances!&quot;</span> <span class="o">%</span> <span class="n">MAT2</span> <span class="p">)</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">externalReaction</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">projectile</span><span class="o">=</span><span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;projectile&#39;</span><span class="p">],</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">otherTarget</span><span class="p">,</span> <span class="n">ENDF_MFMT</span><span class="o">=</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
            <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;externalReactions&#39;</span><span class="p">][(</span><span class="n">MAT2</span><span class="p">,</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="n">quant</span>
            <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">850</span> <span class="o">&lt;</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">871</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">92</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">41</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">103</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span><span class="mi">650</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">104</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">651</span><span class="p">,</span><span class="mi">700</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">105</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">701</span><span class="p">,</span><span class="mi">750</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">106</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">751</span><span class="p">,</span><span class="mi">800</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">107</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">801</span><span class="p">,</span><span class="mi">850</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">MT</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1000</span><span class="p">),[</span><span class="mi">33</span><span class="p">]</span><span class="o">*</span><span class="mi">998</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;lumpedChannels&#39;</span><span class="p">]:</span>
                <span class="n">quant</span> <span class="o">=</span> <span class="n">sumsModule</span><span class="o">.</span><span class="n">crossSectionSum</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span><span class="n">ENDF_MT</span><span class="o">=</span><span class="n">MT</span><span class="p">)</span>
                <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;lumpedChannels&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span> <span class="o">=</span> <span class="n">quant</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;lumpedChannels&#39;</span><span class="p">][(</span><span class="n">MT</span><span class="p">,</span><span class="n">MF</span><span class="p">)]</span>

            <span class="n">link_</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">quant</span><span class="o">.</span><span class="n">crossSection</span>

        <span class="k">return</span> <span class="n">link_</span>

    <span class="n">linkClass</span> <span class="o">=</span> <span class="n">covarianceSummedModule</span><span class="o">.</span><span class="n">summand</span>
    <span class="k">if</span> <span class="n">linkType</span> <span class="o">==</span> <span class="s1">&#39;rowColumn&#39;</span><span class="p">:</span>
        <span class="n">linkClass</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">rowData</span>
    <span class="n">rowData</span> <span class="o">=</span> <span class="n">makeLink</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">rowReaction</span><span class="p">,</span> <span class="n">rowId</span><span class="p">,</span> <span class="n">MAT2</span><span class="p">,</span> <span class="n">linkClass</span> <span class="p">)</span>
    <span class="n">colData</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MT2</span> <span class="ow">and</span> <span class="n">MT2</span><span class="o">!=</span><span class="n">MT</span><span class="p">)</span> <span class="ow">or</span> <span class="n">MAT2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">linkType</span> <span class="o">==</span> <span class="s1">&#39;rowColumn&#39;</span><span class="p">:</span>
            <span class="n">linkClass</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">columnData</span>
        <span class="n">colData</span> <span class="o">=</span> <span class="n">makeLink</span><span class="p">(</span> <span class="n">MT2</span><span class="p">,</span> <span class="n">colReaction</span><span class="p">,</span> <span class="n">colId</span><span class="p">,</span> <span class="n">MAT2</span><span class="p">,</span> <span class="n">linkClass</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">ID</span><span class="p">,</span> <span class="p">[</span><span class="n">rowData</span><span class="p">,</span> <span class="n">colData</span><span class="p">]</span></div>

<div class="viewcode-block" id="readMatrix"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMatrix">[docs]</a><span class="k">def</span> <span class="nf">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span> <span class="n">NT</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span> <span class="n">dat</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; matrix format is very similar for MF31, MF33 and MF35, so we can</span>
<span class="sd">    generalize parsing the matrix &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">NP</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>   <span class="c1"># matrix has at most one energy boundary, no data</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">nlines</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">subsec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remainder</span><span class="p">:</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)[:</span><span class="n">remainder</span><span class="p">]</span>
    <span class="c1"># LB flag tells how to interpret this data:</span>
    <span class="k">if</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span> <span class="c1"># diagonal</span>
        <span class="n">subsec</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[:</span><span class="n">NT</span><span class="p">]</span>
        <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">data</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">LB</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">LS</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#symmetric upper-diagonal</span>
            <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NP</span><span class="p">],]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">linearAlgebraModule</span><span class="o">.</span><span class="n">switchSymmetry</span><span class="p">(</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NP</span><span class="p">:</span><span class="n">NT</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="n">arrayModule</span><span class="o">.</span><span class="n">symmetryLowerToken</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># asymmetric, but same energy grids for both axes:</span>
            <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NP</span><span class="p">]]</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NP</span><span class="p">:]</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NP</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">matrix</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">LB</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span> <span class="c1"># asymmetric</span>
        <span class="n">NER</span> <span class="o">=</span> <span class="n">NP</span>
        <span class="n">NEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">NER</span>
        <span class="n">energyBounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NER</span><span class="p">],</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NER</span><span class="p">:</span><span class="n">NER</span><span class="o">+</span><span class="n">NEC</span><span class="p">]]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">subsec</span><span class="p">[</span><span class="n">NER</span><span class="o">+</span><span class="n">NEC</span><span class="p">:</span><span class="n">NT</span><span class="p">]</span>
        <span class="n">NEC</span><span class="o">-=</span><span class="mi">1</span><span class="p">;</span> <span class="n">NER</span><span class="o">-=</span><span class="mi">1</span>  <span class="c1"># matrix dimensions</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="n">NER</span><span class="p">,</span><span class="n">NEC</span><span class="p">),</span> <span class="n">matrix</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># FIXME: covariances need &#39;flat&#39; interpolation along both independent axes, but gridded doesn&#39;t support that yet</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span> <span class="n">labelsUnits</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;matrix_elements&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">),</span> 
                                            <span class="mi">1</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;column_energy_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">),</span>
                                            <span class="mi">2</span> <span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;row_energy_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span> <span class="p">)</span> <span class="p">}</span> <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> 
                <span class="n">style</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">boundariesGridToken</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">valuesModule</span><span class="o">.</span><span class="n">values</span><span class="p">(</span> <span class="n">energyBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">energyBounds</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> 
                <span class="n">style</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">boundariesGridToken</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">valuesModule</span><span class="o">.</span><span class="n">values</span><span class="p">(</span> <span class="n">energyBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> 
                <span class="n">style</span> <span class="o">=</span> <span class="n">axesModule</span><span class="o">.</span><span class="n">linkGridToken</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">linkModule</span><span class="o">.</span><span class="n">link</span><span class="p">(</span> <span class="n">link</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">relative</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span> <span class="p">)</span>
<span class="c1"># BRB FIX ME</span>
    <span class="k">return</span> <span class="n">griddedModule</span><span class="o">.</span><span class="n">gridded2d</span><span class="p">(</span> <span class="n">axes</span><span class="p">,</span> <span class="n">matrix</span> <span class="p">)</span></div>

<div class="viewcode-block" id="readMF31_33"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF31_33">[docs]</a><span class="k">def</span> <span class="nf">readMF31_33</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; nubar and cross section covariances have basically the same form</span>
<span class="sd">    in ENDF, so we can treat them the same way: &quot;&quot;&quot;</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="c1"># dat contains one MFMT section, but in gnd each cross-correlation gets its own section:</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">MTL</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NL</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">MTL</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1"># MTL!=0 implies section is a placeholder pointing to a lumped channel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">MTL</span><span class="p">,</span><span class="n">mf</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL&#39;</span><span class="p">]:</span>
            <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL&#39;</span><span class="p">][(</span><span class="n">MTL</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL&#39;</span><span class="p">][(</span><span class="n">MTL</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NL</span><span class="p">):</span>
        <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span><span class="p">,</span><span class="n">MAT1</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">NI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MAT1</span> <span class="o">==</span> <span class="n">info</span><span class="o">.</span><span class="n">MAT</span><span class="p">:</span>
            <span class="c1"># Some files explicitly give MAT1==MAT for internal covariance.</span>
            <span class="c1"># for simplicity, just set MAT1=0 unless it is actually a different material</span>
            <span class="n">MAT1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">XMF1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">XLFS1</span><span class="p">)</span>

        <span class="n">covarsThisSection</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">XMF1</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">XLFS1</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1">#info.logs.write( &quot;non-zero XMF1/XLFS1!!!&quot; ) # may not be properly dealt with</span>
            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;non-zero XMF1/XLFS1 in covariances not currently handled!&quot;</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">NCdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NC</span><span class="p">):</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LTY</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">LTY</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NCI2</span><span class="p">,</span><span class="n">NCI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="n">subsec</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NCI2</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="c1">#coefs = subsec[:NCI2][::2]</span>
                <span class="n">pointerList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">coef</span><span class="p">,</span><span class="n">mtnum</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">Id</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtnum</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="n">linkType</span><span class="o">=</span><span class="s1">&#39;summand&#39;</span> <span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">pointers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span>
                    <span class="n">pointerList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">link</span> <span class="p">)</span>
                <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covarianceSummedModule</span><span class="o">.</span><span class="n">summedCovariance</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span>
                    <span class="n">domainMin</span><span class="o">=</span><span class="n">E1</span><span class="p">,</span> <span class="n">domainMax</span><span class="o">=</span><span class="n">E2</span><span class="p">,</span> <span class="n">domainUnit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="n">pointerList</span><span class="o">=</span><span class="n">pointerList</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;NC_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">covarsThisSection</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;non-zero LTY in MF33&#39;</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">NIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">LB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;skipping LB</span><span class="si">%d</span><span class="s1"> section for MF</span><span class="si">%d</span><span class="s1"> MT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LB</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;skipping empty matrix for MF</span><span class="si">%d</span><span class="s1"> MT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">Type</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span>
            <span class="k">if</span> <span class="n">LB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">Type</span><span class="o">=</span><span class="s1">&#39;absolute&#39;</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;b**2&#39;</span>

            <span class="n">ENDFconversionFlag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">LB</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,):</span> <span class="n">ENDFconversionFlag</span> <span class="o">=</span> <span class="s2">&quot;LB=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">LB</span>

            <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">covarianceBaseModule</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
                <span class="n">ENDFconversionFlag</span><span class="o">=</span><span class="n">ENDFconversionFlag</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># create unique id for each section:</span>
        <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">MT2</span><span class="o">=</span><span class="n">MT1</span><span class="p">,</span> <span class="n">MF2</span><span class="o">=</span><span class="p">(</span><span class="n">XMF1</span> <span class="ow">or</span> <span class="n">mf</span><span class="p">),</span> <span class="n">MAT2</span><span class="o">=</span><span class="n">MAT1</span> <span class="p">)</span>
        <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="n">label</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">covarianceMixedModule</span><span class="o">.</span><span class="n">mixedForm</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">covarsThisSection</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">form</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">covarsThisSection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#raise Exception(&quot;Encountered empty covariance section!!!&quot;)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Missing covariance data from section!&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">section</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

        <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
        <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">XMF1</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># end loop over NL subsections</span>

    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Not all covariance data converted, MF</span><span class="si">%d</span><span class="s2"> MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span></div>

<div class="viewcode-block" id="readMF32"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF32">[docs]</a><span class="k">def</span> <span class="nf">readMF32</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span> <span class="p">:</span>
    <span class="c1"># MF=32 resonance parameter covariances. Must be synchronized with MF=2 resonance parameters</span>

    <span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Skipping MF32 since NumPy is unavailable&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],[]</span>
    <span class="n">resonances</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;resonances&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">swaprows</span><span class="p">(</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">nrows</span> <span class="p">):</span>
        <span class="c1"># matrix rows may be out-of-order and need resorting</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matrix</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">];</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:,</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matrix</span><span class="p">[:,</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:,</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">];</span> <span class="n">matrix</span><span class="p">[:,</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">nrows</span><span class="p">]</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="k">def</span> <span class="nf">read_LCOMP1</span><span class="p">(</span> <span class="n">dim</span><span class="p">,</span> <span class="n">matrixSize</span><span class="p">,</span> <span class="n">dat</span> <span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nLines</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">matrixSize</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLines</span><span class="p">):</span> <span class="n">data</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rem</span><span class="p">:</span> <span class="n">data</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)[:</span><span class="n">rem</span><span class="p">]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
            <span class="c1"># data stores upper-diagonal matrix. Symmetrize:</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">length</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">matrix</span>

    <span class="k">def</span> <span class="nf">read_LCOMP2_correlation</span><span class="p">(</span> <span class="n">NNN</span><span class="p">,</span> <span class="n">NM</span><span class="p">,</span> <span class="n">NDIGIT</span><span class="p">,</span> <span class="n">dat</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param NNN: matrix dimension</span>
<span class="sd">        :param NM: number of lines to read from dat</span>
<span class="sd">        :param NDIGIT: Number of significant digits stored</span>
<span class="sd">        :param dat: open ENDF MF=32 section</span>
<span class="sd">        :return: numpy.array with shape (NNN,NNN) storing correlations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">NNN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">NDIGIT</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NM</span><span class="p">):</span>
            <span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">vals</span> <span class="o">=</span> <span class="n">endfFileToGNDMiscModule</span><span class="o">.</span><span class="n">readEndfINTG</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">NDIGIT</span> <span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:</span><span class="n">row</span><span class="o">-</span><span class="n">col</span><span class="p">]</span>
            <span class="c1"># go to 0-based index:</span>
            <span class="n">row</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">&gt;=</span><span class="n">NNN</span> <span class="ow">or</span> <span class="n">col</span><span class="o">&gt;=</span><span class="n">row</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Matrix indices out of range for MF32 LCOMP=2 matrix&quot;</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">:</span><span class="n">col</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NNN</span><span class="p">):</span>    <span class="c1"># symmetrize</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">:,</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">matrix</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">NDIGIT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NIS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NIS</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Can&#39;t handle multi-isotope file 32!&quot;</span> <span class="p">)</span>
    <span class="n">ZAI</span><span class="p">,</span><span class="n">ABN</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LFW</span><span class="p">,</span><span class="n">NER</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>

    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NER</span><span class="p">):</span>
        <span class="n">EL</span><span class="p">,</span><span class="n">EH</span><span class="p">,</span><span class="n">LRU</span><span class="p">,</span><span class="n">LRF</span><span class="p">,</span><span class="n">NRO</span><span class="p">,</span><span class="n">NAPS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NRO</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Can&#39;t handle non-zero NRO in MF32!&quot;</span> <span class="p">)</span>
        <span class="c1"># format is determined mainly by combination of LCOMP and LRU/LRF</span>
        <span class="k">if</span> <span class="n">LRU</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># resolved resonance covariance section</span>
            <span class="n">ENDFconversionFlags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># Breit-Wigner and simplified Reich-Moore formats are similar</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="p">,</span><span class="s1">&#39;evaluated&#39;</span><span class="p">):</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Resonance covariance data for non-existant resonance region&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">mf2_elist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">),</span>
                        <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;neutronWidth&#39;</span><span class="p">),</span>
                        <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;captureWidth&#39;</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LRF3&#39;</span><span class="p">)</span>
                    <span class="n">mf2_elist</span> <span class="o">=</span> <span class="p">[[],[],[]]</span>
                    <span class="k">for</span> <span class="n">spinGroup</span> <span class="ow">in</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">spinGroups</span><span class="p">:</span>
                        <span class="n">mf2_elist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">mf2_elist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;elastic width&#39;</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">mf2_elist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">getColumn</span><span class="p">(</span><span class="s1">&#39;capture width&#39;</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">mf2_elist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">mf2_elist</span> <span class="p">)</span>
                <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LCOMP</span><span class="p">,</span><span class="n">NLS</span><span class="p">,</span><span class="n">ISR</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="n">DAP</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ISR</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1"># scattering radius uncertainty</span>
                    <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dap</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                        <span class="n">DAP</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">*</span><span class="n">dap</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># LRF==3</span>
                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MLS</span><span class="p">,</span><span class="n">one</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">MLS</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span> <span class="p">)</span> <span class="p">):</span>
                            <span class="n">DAP</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">DAP</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">*</span><span class="n">dap</span> <span class="k">for</span> <span class="n">dap</span> <span class="ow">in</span> <span class="n">DAP</span><span class="p">[:</span><span class="n">MLS</span><span class="p">]]</span> <span class="c1"># convert from 10*fm to fm</span>
                <span class="k">if</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>        <span class="c1"># internal correlations given for each resonance, no cross-resonance terms</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;LCOMP=0&#39;</span> <span class="p">)</span>
                    <span class="n">mf32_resonances</span><span class="p">,</span> <span class="n">mf32_covars</span> <span class="o">=</span> <span class="p">[],[]</span>
                    <span class="n">NRS</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">Lval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                        <span class="n">AWRI</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">nrs_</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                        <span class="n">NRS</span> <span class="o">+=</span> <span class="n">nrs_</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrs_</span><span class="p">):</span>
                            <span class="n">mf32_resonances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="p">)</span>
                            <span class="n">mf32_covars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="o">+</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="p">)</span>

                    <span class="n">dEsq</span><span class="p">,</span> <span class="n">dNsq</span><span class="p">,</span> <span class="n">dNdG</span><span class="p">,</span> <span class="n">dGsq</span><span class="p">,</span> <span class="n">dNdF</span><span class="p">,</span> <span class="n">dGdF</span><span class="p">,</span> <span class="n">dFsq</span><span class="p">,</span> <span class="n">dJdN</span><span class="p">,</span> <span class="n">dJdG</span><span class="p">,</span> <span class="n">dJdF</span><span class="p">,</span> <span class="n">dJsq</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">mf32_covars</span><span class="p">)</span>
                    <span class="n">MPAR</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dFsq</span><span class="p">):</span> <span class="n">MPAR</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dJsq</span><span class="p">):</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Encountered uncertainty on J in MF32!&quot;</span><span class="p">)</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MPAR</span><span class="o">*</span><span class="n">NRS</span><span class="p">,</span><span class="n">MPAR</span><span class="o">*</span><span class="n">NRS</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">ridx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRS</span><span class="p">):</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="p">,</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="p">]</span> <span class="o">=</span> <span class="n">dEsq</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNsq</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dNdG</span><span class="p">[</span><span class="n">ridx</span><span class="p">],</span> <span class="n">dGsq</span><span class="p">[</span><span class="n">ridx</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
                            <span class="n">matrix</span><span class="p">[</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ridx</span><span class="o">*</span><span class="n">MPAR</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dNdF</span><span class="p">[</span><span class="n">ridx</span><span class="p">],</span> <span class="n">dGdF</span><span class="p">[</span><span class="n">ridx</span><span class="p">],</span> <span class="n">dFsq</span><span class="p">[</span><span class="n">ridx</span><span class="p">]]</span>
                    <span class="c1"># symmetrize:</span>
                    <span class="k">for</span> <span class="n">ridx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">MPAR</span><span class="o">*</span><span class="n">NRS</span> <span class="p">):</span>
                        <span class="n">matrix</span><span class="p">[</span><span class="n">ridx</span><span class="p">,</span><span class="n">ridx</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">ridx</span><span class="p">:,</span><span class="n">ridx</span><span class="p">]</span>

                    <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">]</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span>
                    <span class="n">matrixClass</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">flattened</span>

                <span class="k">elif</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NSRS</span><span class="p">,</span><span class="n">NLRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MPAR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NRB</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">NRB</span> <span class="o">*</span> <span class="n">MPAR</span>  <span class="c1"># num. of resonances * num. parameters per resonance</span>
                    <span class="n">matrixSize</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">*</span> <span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">matrixSize</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="n">NRB</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Incorrect dimension for the matrix!&quot;</span><span class="p">)</span>

                    <span class="c1"># resonanances are listed again (redundant!):</span>
                    <span class="n">mf32_resonances</span> <span class="o">=</span> <span class="p">[</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRB</span><span class="p">)</span> <span class="p">]</span>
                    <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">]</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">read_LCOMP1</span><span class="p">(</span> <span class="n">dim</span><span class="p">,</span> <span class="n">matrixSize</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span>
                    <span class="n">matrixClass</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">full</span>

                <span class="k">elif</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;LCOMP=2&#39;</span> <span class="p">)</span>
                    <span class="n">AWRI</span><span class="p">,</span> <span class="n">QX</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">LRX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">NRSA</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="c1"># resonance parameters + uncertainties:</span>
                    <span class="n">mf32_resonances</span> <span class="o">=</span> <span class="p">[</span><span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRSA</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mf32_elist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">lis</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">lis</span> <span class="ow">in</span> <span class="n">mf32_resonances</span><span class="p">[::</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="c1"># for LCOMP==2, off-diagonal terms are given as correlation matrix:</span>
                    <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NDIGIT</span><span class="p">,</span><span class="n">NNN</span><span class="p">,</span><span class="n">NM</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">MPAR</span> <span class="o">=</span> <span class="n">NNN</span><span class="o">/</span><span class="n">NRSA</span>
                    <span class="n">diagonal</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRSA</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">dE</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">,</span><span class="n">dGammaF</span> <span class="o">=</span> <span class="n">mf32_resonances</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dE</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">]</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dGammaF</span> <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                            <span class="n">dE</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">,</span><span class="n">dGammaF1</span><span class="p">,</span><span class="n">dGammaF2</span> <span class="o">=</span> <span class="n">mf32_resonances</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dE</span><span class="p">,</span><span class="n">dGammaN</span><span class="p">,</span><span class="n">dGammaG</span><span class="p">]</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dGammaF1</span><span class="p">]</span> <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">[</span><span class="n">dGammaF1</span><span class="p">,</span><span class="n">dGammaF2</span><span class="p">]</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span><span class="o">!=</span><span class="n">NNN</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Incorrect dimensions for LCOMP=2 matrix!&quot;</span> <span class="p">)</span>

                    <span class="c1"># off-diagonal parts of matrix are stored as sparse correlation matrix:</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;NDIGIT=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">NDIGIT</span> <span class="p">)</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">read_LCOMP2_correlation</span><span class="p">(</span> <span class="n">NNN</span><span class="p">,</span> <span class="n">NM</span><span class="p">,</span> <span class="n">NDIGIT</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>

                    <span class="c1"># convert correlation -&gt; relative covariance matrix</span>
                    <span class="n">rsd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">diagonal</span> <span class="p">)</span> <span class="p">)</span>     <span class="c1"># FIXME don&#39;t think we need sqrt here!</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">rsd</span><span class="p">,</span><span class="n">rsd</span><span class="p">)</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span>
                    <span class="n">matrixClass</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">flattened</span>

                <span class="c1"># mf32 may cover only the low-energy portion of the resonance region:</span>
                <span class="n">mf2_elist_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf32_elist</span><span class="p">):</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">)</span> <span class="o">*</span> <span class="n">MPAR</span>
                    <span class="n">matrix2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>
                    <span class="n">matrix2</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">),:</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">)]</span> <span class="o">=</span> <span class="n">matrix</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix2</span>
                    <span class="n">mf2_elist_sorted</span> <span class="o">=</span> <span class="n">mf2_elist_sorted</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">mf32_elist</span><span class="p">)]</span>

                <span class="n">mf32_elist_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mf32_elist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">mf32_elist</span> <span class="o">!=</span> <span class="n">mf32_elist_sorted</span> <span class="ow">or</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;sortByL&#39;</span> <span class="p">)</span>

                <span class="k">if</span> <span class="n">mf32_elist_sorted</span><span class="o">!=</span><span class="n">mf2_elist_sorted</span><span class="p">:</span>
                    <span class="n">ndiffs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">tmpa</span> <span class="o">!=</span> <span class="n">tmpb</span> <span class="k">for</span> <span class="p">(</span><span class="n">tmpa</span><span class="p">,</span><span class="n">tmpb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mf2_elist_sorted</span><span class="p">,</span> <span class="n">mf32_elist_sorted</span><span class="p">)]</span> <span class="p">)</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;MF2/MF32 resonance parameters differ for </span><span class="si">%d</span><span class="s2"> resonances. For example:&quot;</span> <span class="o">%</span> <span class="n">ndiffs</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">mf2res</span><span class="p">,</span><span class="n">mf32res</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mf2_elist_sorted</span><span class="p">,</span> <span class="n">mf32_elist_sorted</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">mf2res</span> <span class="o">!=</span> <span class="n">mf32res</span><span class="p">:</span>
                            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;    resonance #</span><span class="si">%d</span><span class="s2">: MF2 = </span><span class="si">%s</span><span class="s2">, MF32 = </span><span class="si">%s</span><span class="s2">&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">mf2res</span><span class="p">,</span> <span class="n">mf32res</span><span class="p">)</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">verboseWarnings</span><span class="p">:</span> <span class="k">break</span>

                    <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;MF32 resonance parameters don&#39;t match MF2 parameters!&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">mf32_elist</span> <span class="o">!=</span> <span class="n">mf2_elist</span> <span class="ow">or</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># rearrange order of MF32 resonances to match GND storage order</span>

                    <span class="n">mf32_elist_extended</span> <span class="o">=</span> <span class="n">mf32_elist</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mf2_elist</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mf32_elist</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">)):</span>
                        <span class="n">i2</span> <span class="o">=</span> <span class="n">mf32_elist_extended</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">i2</span> <span class="o">!=</span> <span class="n">i1</span><span class="p">:</span>
                            <span class="n">swaprows</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">MPAR</span> <span class="o">*</span> <span class="n">i1</span><span class="p">,</span> <span class="n">MPAR</span> <span class="o">*</span> <span class="n">i2</span><span class="p">,</span> <span class="n">MPAR</span><span class="p">)</span>
                            <span class="c1"># also need to swap values in elist2:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">mf32_elist_extended</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                            <span class="n">mf32_elist_extended</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf32_elist_extended</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
                            <span class="n">mf32_elist_extended</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                <span class="k">if</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>  <span class="c1"># also swap elastic and capture widths to follow LRF=7 convention</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf2_elist</span><span class="p">)):</span>
                        <span class="n">swaprows</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">MPAR</span> <span class="o">*</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPAR</span> <span class="o">*</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">DAP</span><span class="p">:</span> <span class="c1"># scattering radius uncertainty was specified. Expand matrix to include it:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Energy-dependent scat. radius uncertainty not yet handled!&quot;</span><span class="p">)</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">)</span>
                    <span class="n">new_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">)):</span> <span class="n">new_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">new_matrix</span><span class="p">[</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">):,</span> <span class="nb">len</span><span class="p">(</span><span class="n">DAP</span><span class="p">):</span> <span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">new_matrix</span>

                <span class="c1"># switch to diagonal matrix if possible (much more compact):</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">matrix</span><span class="o">==</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span> <span class="o">*</span> <span class="n">matrix</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="p">)</span> <span class="p">):</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span> <span class="n">shape</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">matrixClass</span> <span class="ow">is</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">flattened</span><span class="p">:</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">flattened</span><span class="o">.</span><span class="n">fromNumpyArray</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="n">arrayModule</span><span class="o">.</span><span class="n">symmetryLowerToken</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="n">shape</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">matrix</span><span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span> <span class="p">],</span>
                        <span class="n">symmetry</span><span class="o">=</span><span class="n">arrayModule</span><span class="o">.</span><span class="n">symmetryLowerToken</span><span class="p">)</span>

                <span class="c1"># store into GND:</span>
                <span class="k">if</span> <span class="n">LRF</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">resData</span> <span class="o">=</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span>
                    <span class="n">nResonances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">mf32_elist</span> <span class="p">)</span>
                    <span class="n">parametersPerResonance</span> <span class="o">=</span> <span class="s2">&quot;energy,neutronWidth,captureWidth&quot;</span>
                    <span class="k">if</span> <span class="n">MPAR</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">:</span> <span class="n">parametersPerResonance</span> <span class="o">=</span> <span class="n">parametersPerResonance</span> <span class="o">+</span> <span class="s1">&#39;,fissionWidthA&#39;</span>
                    <span class="k">if</span> <span class="n">MPAR</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> <span class="n">parametersPerResonance</span> <span class="o">=</span> <span class="n">parametersPerResonance</span> <span class="o">+</span> <span class="s1">&#39;,fissionWidthB&#39;</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">DAP</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameterLink</span><span class="p">(</span><span class="s2">&quot;scatteringRadius&quot;</span><span class="p">,</span>
                            <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">scatteringRadius</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">loopOverResonanceParameters</span><span class="p">(</span> <span class="n">link</span><span class="o">=</span><span class="n">resData</span><span class="p">,</span>
                                <span class="n">nResonances</span><span class="o">=</span><span class="n">nResonances</span><span class="p">,</span> <span class="n">parametersPerResonance</span><span class="o">=</span><span class="n">parametersPerResonance</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">resonanceParameterCovariance</span><span class="p">(</span><span class="s2">&quot;resolved resonances&quot;</span><span class="p">,</span> <span class="n">GNDmatrix</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">ENDFconversionFlags</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ENDFconversionFlags</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># store into GND (need links to each spinGroup)</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
                    <span class="n">startIndex</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">spinGroup</span> <span class="ow">in</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="p">:</span>
                        <span class="n">nParams</span> <span class="o">=</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">nColumns</span> <span class="o">*</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">nRows</span>
                        <span class="k">if</span> <span class="n">nParams</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">parameters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameterLink</span><span class="p">(</span>
                            <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">spinGroup</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
                            <span class="n">matrixStartIndex</span><span class="o">=</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">nParameters</span><span class="o">=</span><span class="n">nParams</span>
                        <span class="p">))</span>
                        <span class="n">startIndex</span> <span class="o">+=</span> <span class="n">nParams</span>

                    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameterCovariance</span><span class="p">(</span><span class="s2">&quot;resolved resonances&quot;</span><span class="p">,</span> <span class="n">GNDmatrix</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
                            <span class="n">ENDFconversionFlags</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ENDFconversionFlags</span><span class="p">)))</span>

            <span class="k">elif</span> <span class="n">LRF</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">IFG</span><span class="p">,</span><span class="n">LCOMP</span><span class="p">,</span><span class="n">NJS</span><span class="p">,</span><span class="n">ISR</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ISR</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;scattering radius uncertainty in MF32 LRF7&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">AWRI</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NSRS</span><span class="p">,</span> <span class="n">NLRS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NJSX</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NJSX</span><span class="p">):</span>
                        <span class="n">spinGroup</span> <span class="o">=</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span>
                        <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NCH</span><span class="p">,</span> <span class="n">NRB</span><span class="p">,</span> <span class="n">sixNX</span><span class="p">,</span> <span class="n">NX</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">sixNX</span> <span class="o">==</span> <span class="mi">6</span><span class="o">*</span><span class="n">NX</span>
                        <span class="n">resonanceParams</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">NCH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">))</span>  <span class="c1"># Extra &quot;1&quot; is for the Eres column</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRB</span><span class="p">):</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                                <span class="n">vals</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                            <span class="n">resonanceParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[:</span><span class="n">NCH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

                        <span class="c1"># test for consistency with MF2</span>
                        <span class="k">if</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">resonanceParams</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;MF32 resonance parameters don&#39;t match MF2 parameters for spin group </span><span class="si">%d</span><span class="s2">!&quot;</span>
                                    <span class="o">%</span> <span class="n">jdx</span> <span class="p">)</span>

                    <span class="c1"># rest of matrix:</span>
                    <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">NPARB</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="p">(</span><span class="n">NPARB</span><span class="o">*</span><span class="p">(</span><span class="n">NPARB</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">read_LCOMP1</span><span class="p">(</span> <span class="n">NPARB</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;absoluteCovariance&quot;</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;LCOMP=1&quot;</span> <span class="p">)</span>

                <span class="k">elif</span> <span class="n">LCOMP</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NPP</span><span class="p">,</span><span class="n">NJSX</span><span class="p">,</span><span class="n">twelveNPP</span><span class="p">,</span><span class="n">twoNPP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">twoNPP</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">NPP</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">twelveNPP</span> <span class="o">==</span> <span class="mi">12</span><span class="o">*</span><span class="n">NPP</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NPP</span><span class="p">):</span>
                        <span class="c1"># FIXME should check these against MF2 values:</span>
                        <span class="n">MA</span><span class="p">,</span> <span class="n">MB</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">ZB</span><span class="p">,</span> <span class="n">IA</span><span class="p">,</span> <span class="n">IB</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="n">Q</span><span class="p">,</span> <span class="n">PNT</span><span class="p">,</span> <span class="n">SHF</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">PB</span> <span class="o">=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

                    <span class="k">if</span> <span class="n">NJSX</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NJS</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;WARNING in MF=32: NJSX not consistent with NJS: </span><span class="si">%d</span><span class="s2"> vs </span><span class="si">%d</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NJSX</span><span class="p">,</span> <span class="n">NJS</span><span class="p">)</span> <span class="p">)</span>

                    <span class="n">allUncerts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                        <span class="n">spinGroup</span> <span class="o">=</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span>
                        <span class="n">AJ</span><span class="p">,</span> <span class="n">PJ</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">sixNCH</span><span class="p">,</span> <span class="n">NCH</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">cidx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
                            <span class="c1"># FIXME should also check these against MF2:</span>
                            <span class="n">PPI</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">SCH</span><span class="p">,</span> <span class="n">BND</span><span class="p">,</span> <span class="n">APE</span><span class="p">,</span> <span class="n">APT</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>

                        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NRSA</span><span class="p">,</span><span class="n">twelveNX</span><span class="p">,</span><span class="n">NX</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">twelveNX</span><span class="o">!=</span><span class="mi">12</span><span class="o">*</span><span class="n">NX</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: incorrect LRF7 header, line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">NRSA</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>   <span class="c1"># skip empty line</span>
                        <span class="n">resonanceParams</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">resonanceUncerts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="p">(</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">6.0</span> <span class="p">))</span>  <span class="c1"># Extra &quot;1&quot; is for the Eres column</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NRSA</span><span class="p">):</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">uncerts</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                                <span class="n">vals</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                                <span class="n">uncerts</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                            <span class="n">resonanceParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">vals</span><span class="p">[:</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                            <span class="n">resonanceUncerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">uncerts</span><span class="p">[:</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                            <span class="n">allUncerts</span> <span class="o">+=</span> <span class="n">uncerts</span><span class="p">[:</span><span class="n">NCH</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># now test for consistency with MF2</span>
                        <span class="k">if</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">resonanceParams</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;MF32 resonance parameters don&#39;t match MF2 parameters for spin group </span><span class="si">%d</span><span class="s2">!&quot;</span>
                                    <span class="o">%</span> <span class="n">jdx</span> <span class="p">)</span>
                        <span class="n">J</span><span class="p">,</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">translateENDFJpi</span><span class="p">(</span><span class="n">AJ</span><span class="p">,</span><span class="n">PJ</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">J</span> <span class="o">==</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">spin</span> <span class="ow">and</span> <span class="n">pi</span> <span class="o">==</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">parity</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Inconsistent J/pi for MF2 / MF32 spin group </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jdx</span><span class="p">)</span>

                    <span class="c1"># correlations:</span>
                    <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span> <span class="n">NDIGIT</span><span class="p">,</span> <span class="n">NNN</span><span class="p">,</span> <span class="n">NM</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">read_LCOMP2_correlation</span><span class="p">(</span><span class="n">NNN</span><span class="p">,</span><span class="n">NM</span><span class="p">,</span><span class="n">NDIGIT</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>

                    <span class="c1"># now we can either add uncertainty columns to the parameter tables (and store correlation matrix),</span>
                    <span class="c1"># or convert to covariance matrix. For now do the latter</span>
                    <span class="n">rsd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">allUncerts</span> <span class="p">)</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">rsd</span><span class="p">,</span><span class="n">rsd</span><span class="p">)</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;absoluteCovariance&quot;</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;LCOMP=2&quot;</span> <span class="p">)</span>
                    <span class="n">ENDFconversionFlags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;NDIGIT=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">NDIGIT</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;MF32 LRF=7 LCOMP=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">LCOMP</span><span class="p">)</span>

                <span class="c1"># switch to diagonal matrix if possible (much more compact):</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">matrix</span><span class="o">==</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span> <span class="o">*</span> <span class="n">matrix</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="p">)</span> <span class="p">):</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">GNDmatrix</span> <span class="o">=</span> <span class="n">arrayModule</span><span class="o">.</span><span class="n">flattened</span><span class="o">.</span><span class="n">fromNumpyArray</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="n">arrayModule</span><span class="o">.</span><span class="n">symmetryLowerToken</span><span class="p">)</span>

                <span class="c1"># store into GND (need links to each spinGroup)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
                <span class="n">startIndex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">spinGroup</span> <span class="ow">in</span> <span class="n">resonances</span><span class="o">.</span><span class="n">resolved</span><span class="o">.</span><span class="n">evaluated</span><span class="p">:</span>
                    <span class="n">nParams</span> <span class="o">=</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">nColumns</span> <span class="o">*</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">nRows</span>
                    <span class="k">if</span> <span class="n">nParams</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameterLink</span><span class="p">(</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spinGroup</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">link</span> <span class="o">=</span> <span class="n">spinGroup</span><span class="o">.</span><span class="n">resonanceParameters</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
                        <span class="n">matrixStartIndex</span><span class="o">=</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">nParameters</span><span class="o">=</span><span class="n">nParams</span>
                    <span class="p">))</span>
                    <span class="n">startIndex</span> <span class="o">+=</span> <span class="n">nParams</span>

                <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">covarianceModelParametersModule</span><span class="o">.</span><span class="n">parameterCovariance</span><span class="p">(</span><span class="s2">&quot;resolved resonances&quot;</span><span class="p">,</span> <span class="n">GNDmatrix</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
                        <span class="n">ENDFconversionFlags</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ENDFconversionFlags</span><span class="p">)))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Unknown LRF </span><span class="si">%d</span><span class="s2"> encountered in MF32&quot;</span> <span class="o">%</span> <span class="n">LRF</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># unresolved resonance parameters</span>
            <span class="n">SPI</span><span class="p">,</span><span class="n">AP</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NLS</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">lval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLS</span><span class="p">):</span>
                <span class="n">AWRI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NJS</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="o">!=</span><span class="mi">6</span><span class="o">*</span><span class="n">NJS</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Incorrect header in MF32 unresolved section!&quot;</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">jval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJS</span><span class="p">):</span>
                    <span class="n">D</span><span class="p">,</span><span class="n">AJ</span><span class="p">,</span><span class="n">GNO</span><span class="p">,</span><span class="n">GG</span><span class="p">,</span><span class="n">GF</span><span class="p">,</span><span class="n">GX</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>

            <span class="c1"># matrix:</span>
            <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MPAR</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">NPAR</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span> <span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="p">(</span><span class="n">NPAR</span><span class="o">*</span><span class="p">(</span><span class="n">NPAR</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Incorrect header in MF32 unresolved section!&quot;</span> <span class="p">)</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tmp</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">data</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NPAR</span><span class="p">,</span><span class="n">NPAR</span><span class="p">))</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NPAR</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPAR</span><span class="p">):</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i1</span><span class="p">:,</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">]</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">;</span> <span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">matrix</span><span class="o">==</span><span class="mi">0</span> <span class="p">):</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ignoring empty unresolved covariance matrix!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;covariances for unresolved resonance region not yet supported!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sections</span><span class="p">,</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="readMF34"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF34">[docs]</a><span class="k">def</span> <span class="nf">readMF34</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; angular distribution covariances: &quot;&quot;&quot;</span>

    <span class="c1"># dat contains one MFMT section</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">LTT</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NMT</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">covarianceDistributionsModule</span><span class="o">.</span><span class="n">LegendreOrderCovarianceForm</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
    <span class="n">groupIndex</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMT</span><span class="p">):</span>
        <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">MAT1</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">NL</span><span class="p">,</span><span class="n">NL1</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MT1</span> <span class="o">==</span> <span class="n">mt</span><span class="p">:</span>
            <span class="n">NSS</span> <span class="o">=</span> <span class="n">NL</span><span class="o">*</span><span class="p">(</span><span class="n">NL</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NSS</span><span class="o">=</span><span class="n">NL</span><span class="o">*</span><span class="n">NL1</span>
        <span class="k">if</span> <span class="n">MAT1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Cross material angular distribution covariance is not allowed in ENDF format.  Found MAT1 =&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">MAT1</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">MT1</span> <span class="o">!=</span> <span class="n">mt</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Cross reaction covariances in angular distribution covariance data not supported&quot;</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">iNSS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NSS</span><span class="p">):</span>
            <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">LCT</span><span class="p">,</span> <span class="n">NI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;frameOfMF4&quot;</span><span class="p">,</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">labToken</span><span class="p">,</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">centerOfMassToken</span><span class="p">][</span><span class="n">LCT</span><span class="p">]</span>

            <span class="n">Lsection</span> <span class="o">=</span> <span class="n">covarianceDistributionsModule</span><span class="o">.</span><span class="n">LegendreLValue</span><span class="p">(</span> <span class="n">L</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">frame</span> <span class="p">)</span>
            <span class="n">covarsThisL</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">NIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NE</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">LS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">LB</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Unexpected LS</span><span class="si">%d</span><span class="s2"> LB</span><span class="si">%d</span><span class="s2"> in MF34&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LS</span><span class="p">,</span> <span class="n">LB</span><span class="p">)</span> <span class="p">)</span>
                <span class="c1"># pretend it&#39;s MF33 file:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NE</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">LB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;LB=0 in Legendre covariances&quot;</span><span class="p">)</span>
                <span class="n">covarsThisL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">covarianceBaseModule</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisL</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sectionForm</span> <span class="o">=</span> <span class="n">covarianceMixedModule</span><span class="o">.</span><span class="n">mixedForm</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">covarsThisL</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sectionForm</span><span class="p">)):</span> <span class="n">sectionForm</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisL</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sectionForm</span> <span class="o">=</span> <span class="n">covarsThisL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">Lsection</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">sectionForm</span> <span class="p">)</span>

            <span class="c1"># end loop over subsubsections</span>
            <span class="n">form</span><span class="o">.</span><span class="n">lvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Lsection</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;frameOfMF4&#39;</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">endfConversionFlag</span> <span class="o">=</span> <span class="s2">&quot;LCT=0&quot;</span>
                <span class="n">cov_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span> <span class="s1">&#39;MF34_missingFrames&#39;</span><span class="p">,</span> <span class="p">{}</span> <span class="p">)</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span> <span class="n">mt</span><span class="p">,</span> <span class="p">[]</span> <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Lsection</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Not all covariance data converted, MF</span><span class="si">%d</span><span class="s2"> MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>

        <span class="c1"># add unique id to the section:</span>
        <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span> <span class="p">)</span>
        <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="n">label</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span><span class="p">)</span>
        <span class="n">section</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

        <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
        <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span></div>

<div class="viewcode-block" id="readMF35"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF35">[docs]</a><span class="k">def</span> <span class="nf">readMF35</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; spectra covariances are fairly simple: &quot;&quot;&quot;</span>

    <span class="c1"># dat contains one MFMT section</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NK</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NK</span><span class="p">):</span>
        <span class="c1"># each subsection contains matrix for a different incident energy interval.</span>
        <span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NE</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LS</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">LB</span><span class="o">==</span><span class="mi">7</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;Unexpected LS</span><span class="si">%d</span><span class="s2"> LB</span><span class="si">%d</span><span class="s2"> in MF35&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LS</span><span class="p">,</span> <span class="n">LB</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># pretend it&#39;s MF33 file:</span>
        <span class="n">LS</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">LB</span><span class="o">=</span><span class="mi">5</span>
        <span class="n">E1</span><span class="p">,</span><span class="n">E2</span> <span class="o">=</span> <span class="p">[</span><span class="n">PQUModule</span><span class="o">.</span><span class="n">PQU</span><span class="p">(</span> <span class="n">PQUModule</span><span class="o">.</span><span class="n">pqu_float</span><span class="o">.</span><span class="n">surmiseSignificantDigits</span><span class="p">(</span> <span class="n">a</span> <span class="p">),</span><span class="s1">&#39;eV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">)]</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">NT</span><span class="p">,</span> <span class="n">NE</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">covarianceBaseModule</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span> <span class="p">)</span>

        <span class="c1"># add unique id to the section:</span>
        <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span> <span class="p">)</span>
        <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
        <span class="n">rowdat</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;incidentEnergyLowerBound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E1</span>
        <span class="n">rowdat</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;incidentEnergyUpperBound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E2</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="n">label</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span><span class="p">)</span>
        <span class="n">section</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

        <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
        <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># end loop over NK subsections</span>

    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span><span class="s2">&quot;Not all covariance data converted, MF</span><span class="si">%d</span><span class="s2"> MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span></div>

<div class="viewcode-block" id="readMF40"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.readMF40">[docs]</a><span class="k">def</span> <span class="nf">readMF40</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">cov_info</span><span class="p">,</span><span class="n">warningList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; production of radioactive isotopes. Also very similar to MF33 &quot;&quot;&quot;</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">myIter</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span> <span class="o">=</span> <span class="p">[],[]</span>
    <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span><span class="p">,</span> <span class="n">LIS</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">NS</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
    <span class="n">ZA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">ZA</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">addMassAWR</span><span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">AWR</span> <span class="p">)</span>

    <span class="c1"># each subsection represents different excited state of residual</span>
    <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NS</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">QM</span><span class="p">,</span><span class="n">QI</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LFS</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NL</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MF40 MT</span><span class="si">%d</span><span class="s1"> lists incorrect number of subsections!&#39;</span> <span class="o">%</span> <span class="n">mt</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">subsubsection</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NL</span><span class="p">):</span>
            <span class="c1"># each subsubsection is a single matrix</span>
            <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span><span class="p">,</span><span class="n">MAT1</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">NI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
            <span class="n">XMF1</span><span class="p">,</span><span class="n">XLFS1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">XMF1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">XLFS1</span><span class="p">)</span> <span class="c1"># XLFS1: level index</span>

            <span class="n">covarsThisSection</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">XMF1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BadCovariance</span><span class="p">(</span> <span class="s2">&quot;non-zero XMF1/XLFS1 in covariances not currently handled!&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">MAT1</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;cross-material covariance with MAT=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MAT1</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">NCdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NC</span><span class="p">):</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LTY</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LTY</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">E1</span><span class="p">,</span><span class="n">E2</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">NCI2</span><span class="p">,</span><span class="n">NCI</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="n">subsec</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NCI2</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span> <span class="n">subsec</span> <span class="o">+=</span> <span class="n">funkyF</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                    <span class="c1">#coefs = subsec[:NCI2][::2]</span>
                    <span class="n">pointerList</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">linkModule</span><span class="o">.</span><span class="n">link</span><span class="p">(</span> <span class="s1">&#39;summand&#39;</span><span class="p">,</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtnum</span><span class="p">),</span> <span class="n">mf</span> <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ENDF_MFMT&#39;</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mtnum</span><span class="p">),</span> <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span><span class="n">coef</span><span class="p">})</span>
                            <span class="k">for</span> <span class="n">coef</span><span class="p">,</span><span class="n">mtnum</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span><span class="n">subsec</span><span class="p">[:</span><span class="n">NCI2</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
                            <span class="p">]</span>
                    <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covarianceSummedModule</span><span class="o">.</span><span class="n">summedCovariance</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span>
                        <span class="n">domainMin</span><span class="o">=</span><span class="n">E1</span><span class="p">,</span> <span class="n">domainMax</span><span class="o">=</span><span class="n">E2</span><span class="p">,</span> <span class="n">domainUnit</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="n">pointerList</span><span class="o">=</span><span class="n">pointerList</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;non-zero LTY in MF40&#39;</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">NIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
                <span class="n">dum</span><span class="p">,</span><span class="n">dum</span><span class="p">,</span><span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span> <span class="o">=</span> <span class="n">funkyFI</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">logFile</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">readMatrix</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span><span class="n">LB</span><span class="p">,</span><span class="n">NT</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">LB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;skipping LB</span><span class="si">%d</span><span class="s1"> section for MF</span><span class="si">%d</span><span class="s1"> MT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">LB</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">Type</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span>
                <span class="k">if</span> <span class="n">LB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s1">&#39;absolute&#39;</span>
                    <span class="n">matrix</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;b**2&#39;</span>

                <span class="n">covarsThisSection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">covarianceBaseModule</span><span class="o">.</span><span class="n">covarianceMatrix</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">MAT1</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
               <span class="k">continue</span>

            <span class="c1"># create unique id for each section:</span>
            <span class="n">idNow</span><span class="p">,</span> <span class="n">pointers</span> <span class="o">=</span> <span class="n">genID</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">MT2</span><span class="o">=</span><span class="n">MT1</span><span class="p">,</span> <span class="n">MF2</span><span class="o">=</span><span class="p">(</span><span class="n">XMF1</span> <span class="ow">or</span> <span class="n">mf</span><span class="p">),</span> <span class="n">MAT2</span><span class="o">=</span><span class="n">MAT1</span><span class="p">,</span> <span class="n">QI</span><span class="o">=</span><span class="n">QI</span> <span class="p">)</span>
            <span class="n">rowdat</span><span class="p">,</span> <span class="n">coldat</span> <span class="o">=</span> <span class="n">pointers</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">covarianceSectionModule</span><span class="o">.</span><span class="n">section</span><span class="p">(</span> <span class="n">label</span><span class="o">=</span><span class="n">idNow</span><span class="p">,</span> <span class="n">rowData</span><span class="o">=</span><span class="n">rowdat</span><span class="p">,</span> <span class="n">columnData</span><span class="o">=</span><span class="n">coldat</span> <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">covarianceMixedModule</span><span class="o">.</span><span class="n">mixedForm</span><span class="p">(</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">covarsThisSection</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">)):</span> <span class="n">form</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covarsThisSection</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">covarsThisSection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#raise Exception(&quot;Encountered empty covariance section!!!&quot;)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Missing covariance data from section!&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">section</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

            <span class="n">sectionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">section</span> <span class="p">)</span>
            <span class="n">linkData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">MT1</span><span class="p">,</span><span class="n">XMF1</span><span class="p">,</span> <span class="n">idNow</span><span class="p">)</span> <span class="p">)</span>
            <span class="c1"># end loop over NL subsections</span>

    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">dat</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
        <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Not all covariance data converted for MF</span><span class="si">%d</span><span class="s2"> MT</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">sectionList</span><span class="p">,</span> <span class="n">linkData</span></div>

<div class="viewcode-block" id="fillRemainingProductsResidualForBreakup"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.fillRemainingProductsResidualForBreakup">[docs]</a><span class="k">def</span> <span class="nf">fillRemainingProductsResidualForBreakup</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">lightIsotopeNames</span><span class="p">,</span> <span class="n">breakupProducts</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">:</span>

    <span class="n">residualZA2</span> <span class="o">=</span> <span class="n">residualZA</span>
    <span class="k">for</span> <span class="n">productName</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">productName</span> <span class="ow">in</span> <span class="n">breakupProducts</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">breakupProducts</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span> <span class="p">),</span> 
                    <span class="n">crossSection</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
            <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">residualZA</span> <span class="o">%</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">residualZA2</span> <span class="o">-=</span> <span class="n">multiplicity</span> <span class="o">*</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">residualZA2</span> <span class="o">-=</span> <span class="n">multiplicity</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">residualZA2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> 
            <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA2</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="parseReaction"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.parseReaction">[docs]</a><span class="k">def</span> <span class="nf">parseReaction</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">targetZA</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">parseCrossSectionOnly</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate all available data for the reaction with this MT.</span>
<span class="sd">    :return: tuple(crossSection, outputChannel, MFKeys)  where MFKeys contains MF numbers that remain untranslated (should be empty)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">productList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">MFKeys</span> <span class="o">=</span> <span class="n">MTData</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span> <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;    </span><span class="si">%3d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span> <span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span> <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">MF</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="mi">3</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>   <span class="c1"># Kludge, for ENDF files that for MT 3 have MF 12 and 13 but not MF 3 data.</span>
        <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">breakupProducts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">breakupProducts</span> <span class="o">=</span> <span class="n">readMF3</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">3</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">parseCrossSectionOnly</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span><span class="p">,</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span><span class="p">(</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">MFKeys</span> <span class="p">)</span>

    <span class="n">fissionGenre</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">18</span> <span class="p">:</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">fissionGenreTotal</span><span class="p">,</span>
                     <span class="mi">19</span> <span class="p">:</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">fissionGenreFirstChance</span><span class="p">,</span>
                     <span class="mi">20</span> <span class="p">:</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">fissionGenreSecondChance</span><span class="p">,</span>
                     <span class="mi">21</span> <span class="p">:</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">fissionGenreThirdChance</span><span class="p">,</span>
                     <span class="mi">38</span> <span class="p">:</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">fissionGenreFourthChance</span> <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">neutronMFs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span> <span class="n">neutronMFs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">MF</span> <span class="p">)</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">!=</span> <span class="p">[]</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="mi">6</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;MF 6 present and MF 4 and/or 5 present: not allowed&quot;</span> <span class="p">)</span> <span class="c1"># This should never happen!</span>

    <span class="n">endfMTProductList</span> <span class="o">=</span> <span class="n">endf_endlModule</span><span class="o">.</span><span class="n">endfMTtoC_ProductLists</span><span class="p">[</span><span class="n">MT</span><span class="p">]</span>
    <span class="n">compoundZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">targetZA</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span>
    <span class="n">lightIsotopeZAs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">[</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">lightIsotopeZAsMultiplicity</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]]</span> <span class="o">=</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="mi">4</span> <span class="ow">in</span> <span class="n">neutronMFs</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">18</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="c1"># MT == 18 and neutronMFs == [ 5 ] is a special case for bad data (g + Am241).</span>
        <span class="n">ZAP</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span> <span class="p">]</span> <span class="p">)</span>  <span class="p">:</span>                <span class="c1"># Not elastic, fission or sumOfRemainingReactions.</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>

    <span class="n">levelIndex</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">twoBodyResidualZA</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span><span class="p">(</span>    <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">91</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">50</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">600</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">649</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">600</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">650</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">699</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">650</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">700</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">749</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">700</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">750</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">799</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">750</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">800</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">849</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">800</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">875</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">891</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">MT</span> <span class="o">-</span> <span class="mi">875</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span><span class="p">,</span> <span class="mi">891</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span>                                                 <span class="c1"># If level &gt; 0., residual is in an excited state.</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">breakupProducts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">91</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="n">QI</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">91</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="nb">print</span> <span class="n">breakupProducts</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s1">&#39;breakup for MT </span><span class="si">%s</span><span class="s1"> is not supported&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
    <span class="n">isUndefinedTwoBody</span> <span class="o">=</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">91</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">102</span> <span class="o">&lt;</span> <span class="n">MT</span> <span class="o">&lt;=</span> <span class="mi">107</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">isTwoBody</span> <span class="o">=</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">91</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">600</span> <span class="o">&lt;=</span> <span class="n">MT</span> <span class="o">&lt;</span> <span class="mi">849</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">isUndefinedTwoBody</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="ow">or</span> <span class="n">isUndefinedTwoBody</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="n">projectileZA</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">productName</span> <span class="ow">in</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productName</span> <span class="o">==</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">ZAP</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">ZAP</span> <span class="o">=</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">productName</span><span class="p">]</span>
        <span class="n">twoBodyResidualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span>
    <span class="n">undefinedLevelInfo</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;ZA&#39;</span> <span class="p">:</span> <span class="n">twoBodyResidualZA</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span> <span class="p">:</span> <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;levelIndex&#39;</span> <span class="p">:</span> <span class="n">levelIndex</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">4</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>                     <span class="c1"># This is a two-body reaction with only angular data.</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;With only MF = 4 data present, reaction is assumed to be two-body and it is not for MT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">readMF4</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">4</span> <span class="p">)</span>
        <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">ZAP</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="c1"># Don&#39;t check ZAP if MT=5. Currently this combination, MT=5, MF=4/5 appears only for incident gammas</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">ZAP</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;ZAP = </span><span class="si">%d</span><span class="s1"> != 1 for MFs = [ 4, 5 ] for MT = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span> <span class="p">]</span> <span class="p">)</span>  <span class="p">:</span>                <span class="c1"># Not elastic or fission.</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">lightIsotopeNames</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
            <span class="n">ZAP</span> <span class="o">=</span> <span class="n">productNameToZA</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">productCounts</span><span class="p">[</span><span class="n">product</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>            <span class="c1"># MT 5 is special case where (g,n&#39;) put into MT 5 instead of one of 50-91.</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> 
                <span class="n">crossSection</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MF=5 found with no accompanying MF=4, assuming angular distribution for MT=</span><span class="si">%i</span><span class="s2"> is isotropic&quot;</span><span class="o">%</span><span class="n">MT</span><span class="p">)</span>
            <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">isotropic</span><span class="p">(</span> <span class="p">)</span>             <span class="c1"># MF = 5 data is always in lab frame.</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">readMF4</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">4</span> <span class="p">)</span>

        <span class="n">energySubform</span> <span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">readMF5</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">product</span> <span class="o">=</span> <span class="n">product</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">5</span> <span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">uncorrelated</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angularSubform</span><span class="p">,</span> <span class="n">energySubform</span> <span class="p">)</span>  <span class="c1"># BRB: is frame right.</span>
        <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="mi">6</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">isTwoBody</span> <span class="o">=</span> <span class="n">readMF6</span><span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTData</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span><span class="p">,</span> <span class="n">isTwoBody</span><span class="p">,</span> <span class="n">crossSection</span> <span class="p">)</span>
        <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="mi">6</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="ow">and</span> <span class="kc">False</span> <span class="p">)</span> <span class="p">:</span>                 <span class="c1"># ????????? Why False</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;How did we get here.&#39;</span> <span class="p">)</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span>
            <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="n">ZAP</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">levelIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">levelIndex</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">targetZA</span> <span class="o">==</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">QI</span> <span class="o">!=</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">:</span>     <span class="c1"># Residual is in an excited state.</span>
                <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
                <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> 
                        <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="p">),</span>
                    <span class="n">crossSection</span><span class="p">,</span> <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">decayChannel</span> <span class="p">)</span>
            <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span>
            <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">residual</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">_dummyCrossSection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">readMF12_13</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MT</span><span class="p">,</span> <span class="n">MTData</span><span class="p">,</span> <span class="n">productList</span><span class="p">,</span> <span class="n">warningList</span><span class="p">,</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">_dummyCrossSection</span> <span class="p">)</span>
    <span class="n">_crossSection</span> <span class="o">=</span> <span class="n">crossSection</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">_crossSection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="n">_crossSection</span> <span class="o">=</span> <span class="n">_dummyCrossSection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Should only happen for MT=3 with no MF=3.</span>

    <span class="k">for</span> <span class="n">MF</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MF</span> <span class="ow">in</span> <span class="n">MFKeys</span> <span class="p">)</span> <span class="p">:</span> <span class="n">MFKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">MF</span> <span class="p">)</span>

    <span class="sd">&quot;&quot;&quot; # FIXME: doesn&#39;t appear to be used anymore</span>
<span class="sd">    specialBe9n2nExcited, specialBe9n2nExcitedLevel = False, 0</span>
<span class="sd">    if( 875 &lt;= MT &lt; 892 ) :                                         # Special case for (z,2n[?])</span>
<span class="sd">        if( targetZA == 4009 ) :                                    # Special case for Be9(n,2n[?]He4)He4</span>
<span class="sd">            specialBe9n2nExcited = True</span>
<span class="sd">            specialBe9n2nExcitedLevel = ( QM - QI ) / 1e6</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">QM</span> <span class="o">!=</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;    --QM </span><span class="si">%s</span><span class="s1"> != QI = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">QM</span><span class="p">,</span> <span class="n">QI</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">sumOfRemainingOutputChannels</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span> <span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">102</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">residualIndex</span><span class="p">,</span> <span class="n">gammaMissing</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">:</span> <span class="n">residualIndex</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">gammaMissing</span> <span class="o">=</span> <span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="ow">or</span> <span class="n">gammaMissing</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">residualIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">productList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                    <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">residualIndex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">productList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">productList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="n">residualIndex</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="ow">not</span><span class="p">(</span> <span class="n">gammaMissing</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>  <span class="c1"># Q????? What about QI?</span>
    <span class="k">elif</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">QI</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">QM</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;QI = 0, QM = </span><span class="si">%f</span><span class="s2"> for MT=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">QM</span><span class="p">,</span><span class="n">MT</span><span class="p">))</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">twoBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAs</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span>
                            <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;product data for reaction MT = </span><span class="si">%s</span><span class="s2"> needs to be implemented&quot;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                        <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">projectileZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">decayProductList</span> <span class="o">=</span> <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">productList</span> <span class="o">=</span> <span class="n">productList</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>                               <span class="c1"># Assume first product is &quot;b&quot; in &quot;a + A -&gt; b + B&quot; where B is the larger product.</span>
        <span class="n">ZA</span> <span class="o">=</span> <span class="n">particleZA</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">productList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span>
        <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="n">ZA</span> <span class="p">)</span>
        <span class="n">levelIndex</span> <span class="o">=</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s1">&#39;levelIndex&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">levelIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">levelIndex</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">targetLevel</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">targetZA</span> <span class="o">==</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span> <span class="n">levelIndex</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s1">&#39;levelIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">levelIndex</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">decayProductList</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">ZA</span> <span class="o">=</span> <span class="n">particleZA</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">residualZA</span> <span class="o">==</span> <span class="n">ZA</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">decayProductList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="n">index</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="o">==</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s1">&#39;ZA&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="n">undefinedLevelInfo</span><span class="p">[</span><span class="s1">&#39;ZA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                        <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;ENDFconversionFlag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;implicitProduct&#39;</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="ow">in</span> <span class="n">productList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">recoilForm</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">twoBodyForm</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">centerOfMassToken</span><span class="p">,</span>
                        <span class="n">angularSubform</span> <span class="o">=</span> <span class="n">angularModule</span><span class="o">.</span><span class="n">recoil</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">recoilForm</span> <span class="p">)</span>

        <span class="n">decayZAs</span><span class="p">,</span> <span class="n">decayGammaList</span><span class="p">,</span> <span class="n">decayNonGammaList</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">decayProduct</span> <span class="ow">in</span> <span class="n">decayProductList</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">decayProduct</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">decayGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">decayProduct</span> <span class="p">)</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">decayNonGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">decayProduct</span> <span class="p">)</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="n">decayProduct</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">getConstant</span><span class="p">()</span>
            <span class="n">decayZAs</span> <span class="o">+=</span> <span class="n">particleZA</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">decayProduct</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">*</span> <span class="n">mult</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">LR</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">decayZAs</span> <span class="o">!=</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;decayZAs = </span><span class="si">%d</span><span class="s2"> != residualZA = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">decayZAs</span><span class="p">,</span> <span class="n">residualZA</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="n">decayZAs</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayGammaList</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayNonGammaList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">decayNonGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                            <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayNonGammaList</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayGammaList</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">decayGammaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                        <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">decayProductList</span> <span class="o">=</span> <span class="n">decayNonGammaList</span> <span class="o">+</span> <span class="n">decayGammaList</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;decayZAs = </span><span class="si">%d</span><span class="s2"> != 0&quot;</span> <span class="o">%</span> <span class="n">decayZAs</span> <span class="p">)</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">breakupProducts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;breakupProducts and decayChannel both not None&#39;</span> <span class="p">)</span>
            <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">decayChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">fillRemainingProductsResidualForBreakup</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">lightIsotopeNames</span><span class="p">,</span> <span class="n">breakupProducts</span><span class="p">,</span>
                <span class="n">particleZA</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span>
            <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addOutputChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">decayProductList</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>                         <span class="c1"># At this point, both two bodies are in productList and second one is redisual.</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">QI</span> <span class="o">&gt;</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Negative decay Q-value for MT</span><span class="si">%d</span><span class="s2">, QI = </span><span class="si">%s</span><span class="s2">, QM = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">QM</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
            <span class="n">decayChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>  <span class="c1"># Q????? Not right?</span>
            <span class="k">for</span> <span class="n">decayProduct</span> <span class="ow">in</span> <span class="n">decayProductList</span> <span class="p">:</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">decayProduct</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addOutputChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>

    <span class="k">elif</span><span class="p">(</span> <span class="n">endfMTProductList</span><span class="o">.</span><span class="n">isFission</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">fissionChannel</span><span class="p">(</span> <span class="n">fissionGenre</span> <span class="o">=</span> <span class="n">fissionGenre</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s1">&#39;fissionEnergyReleaseData&#39;</span> <span class="p">):</span>
            <span class="n">FER</span> <span class="o">=</span> <span class="n">getFissionEnergies</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">crossSection</span><span class="o">.</span><span class="n">domainMax</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>

            <span class="c1"># also check for consistency between polynomial expansion and approximate constant Q:</span>
            <span class="n">useThisQM</span> <span class="o">=</span> <span class="n">FER</span><span class="o">.</span><span class="n">nonNeutrinoEnergy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">useThisQM</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">QM</span><span class="p">):</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Fission QM inconsistent with energy release data for MT = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">FER</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">useThisQM</span> <span class="o">=</span> <span class="n">QM</span>
            <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">useThisQM</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">18</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">productList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">outputChannel</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">unknown</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameGamma</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">crossSection</span><span class="p">,</span> 
                        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span>
                <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">outputChannel</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="p">)</span> <span class="p">:</span> <span class="k">break</span>
                <span class="n">info</span><span class="o">.</span><span class="n">firstFissionNeutron</span> <span class="o">=</span> <span class="n">product</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">tokensModule</span><span class="o">.</span><span class="n">promptToken</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span><span class="p">[</span><span class="n">tokensModule</span><span class="o">.</span><span class="n">promptToken</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="s1">&#39;constant&#39;</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;emissionMode&#39;</span><span class="p">,</span> <span class="n">tokensModule</span><span class="o">.</span><span class="n">promptToken</span> <span class="p">)</span>
<span class="c1"># BRB uncomment                   if( &#39;total&#39; in info.totalOrPromptFissionNeutrons ) :</span>
<span class="c1">#   ditto                     warningList.append( &#39;have prompt fission nu_bar so not including total&#39; )</span>
                <span class="k">elif</span><span class="p">(</span> <span class="s1">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">totalOrPromptFissionNeutrons</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="s1">&#39;constant&#39;</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;emissionMode&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s1">&#39;delayedFissionDecayChannel&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">for</span> <span class="n">delayedNeutron</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">delayedFissionDecayChannel</span> <span class="p">:</span>
                        <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">delayedNeutron</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">pass</span>    <span class="c1"># we used to add a reference to total fission nubar and PFNS, but that&#39;s not physically correct</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                if( hasattr( info, &#39;firstFissionNeutron&#39; ) ) :</span>
<span class="sd">                    multiplicity = multiplicityModule.reference( link=info.firstFissionNeutron.multiplicity, label = info.style )</span>
<span class="sd">                else :                                              # When singleMTOnly is fission MT != 18.</span>
<span class="sd">                    multiplicity = multiplicityModule.unknown( label = info.style )</span>
<span class="sd">                product = toGNDMiscModule.newGNDParticle( info, toGNDMiscModule.getTypeNameGamma( info, 1 ), </span>
<span class="sd">                        crossSection, multiplicity = multiplicity )</span>
<span class="sd">                if( hasattr( info, &#39;firstFissionNeutron&#39; ) ) :</span>
<span class="sd">                    form = referenceModule.form( link = info.firstFissionNeutron.distribution, label = info.style )</span>
<span class="sd">                    product.distribution.add( form )</span>
<span class="sd">                outputChannel.products.add( outputChannel.products.uniqueLabel( product ) )</span>
<span class="sd">                &quot;&quot;&quot;</span>

        <span class="c1"># July 2011: some files have distributions for 1stChanceFission etc, but should still link to total nubar:</span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productList</span><span class="p">:</span>
            <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">constant1d</span> <span class="p">)</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">]</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="s1">&#39;firstFissionNeutron&#39;</span> <span class="p">):</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">firstFissionNeutron</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span>
                    <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">multiplicity</span> <span class="p">)</span>

        <span class="k">while</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">productList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">outputChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QI</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>      <span class="c1"># Q?????</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">residualZA</span><span class="p">,</span> <span class="n">ZAsMultiplicities</span><span class="p">,</span> <span class="n">productAsResidual</span><span class="p">,</span> <span class="n">biggestProduct</span> <span class="o">=</span> <span class="n">compoundZA</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>
                <span class="n">ZA</span> <span class="o">=</span> <span class="n">particleZA</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span>
                <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">multiplicityModule</span><span class="o">.</span><span class="n">constant1d</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">constant</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Incorrect multiplicity in ENDF file! MT = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;Multiplicity should be constant but is &quot;</span><span class="si">%s</span><span class="s1">&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">multiplicity</span><span class="o">.</span><span class="n">moniker</span> <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;Multiplicity should be a constant and it is not.&#39;</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAs</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
                        <span class="c1"># If we have different distributions for both neutrons in (n,2n), n shows up twice in the productList.</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">ZAsMultiplicities</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mult</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">=</span> <span class="n">mult</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">productAsResidual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;multiple residuals for MT = %, </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">MT</span><span class="p">,</span> <span class="n">productAsResidual</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">productAsResidual</span> <span class="o">=</span> <span class="n">product</span>

            <span class="n">_residualZA</span> <span class="o">=</span> <span class="n">compoundZA</span>
            <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAsMultiplicity</span> <span class="p">:</span> <span class="n">_residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">_residualZA</span><span class="p">,</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">*</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">residualZA</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">ZA</span> <span class="ow">in</span> <span class="n">lightIsotopeZAs</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZA</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ZAsMultiplicities</span> <span class="p">)</span> <span class="p">:</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">==</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span> <span class="k">continue</span>       <span class="c1"># All this ZA accounted for.</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;negative multiplicity for ZA = </span><span class="si">%s</span><span class="s1"> for MT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">MT</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">lightIsotopeZAsMultiplicity</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZAsMultiplicities</span><span class="p">[</span><span class="n">ZA</span><span class="p">]</span>
                    <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">ZA</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> 
                            <span class="n">crossSection</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">residualZA</span> <span class="o">=</span> <span class="n">calculateZA</span><span class="p">(</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">multiplicity</span> <span class="o">*</span> <span class="n">ZA</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">productAsResidual</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">residualZA</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span> <span class="n">productList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> 
                            <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="n">undefinedLevelInfo</span> <span class="p">),</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">649</span><span class="p">,</span> <span class="mi">699</span><span class="p">,</span> <span class="mi">749</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">849</span><span class="p">,</span> <span class="mi">891</span> <span class="p">]</span> <span class="p">)</span> <span class="p">:</span>
                <span class="n">gammaIndices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">productList</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">IDsPoPsModule</span><span class="o">.</span><span class="n">photon</span> <span class="p">)</span> <span class="p">:</span> <span class="n">gammaIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">index</span> <span class="p">)</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">gammaIndices</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
                    <span class="n">decayChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">finalResidual</span> <span class="o">=</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">newGNDParticle</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">getTypeNameENDF</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">residualZA</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span>
                            <span class="n">crossSection</span> <span class="p">)</span>
                    <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">finalResidual</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span> <span class="s1">&#39;ENDFconversionFlag&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">finalResidual</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span> <span class="s1">&#39;ENDFconversionFlag&#39;</span><span class="p">,</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span> <span class="s1">&#39;ENDFconversionFlag&#39;</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">gammaIndices</span> <span class="p">:</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">decayChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">gammaIndices</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span> <span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">gammaIndices</span> <span class="p">:</span> <span class="k">del</span> <span class="n">productList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addOutputChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">hasData</span><span class="p">(</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>  <span class="c1"># BRB One must be careful here as this assumes that distributions</span>
                        <span class="n">forms1</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span> <span class="p">:</span> 
                            <span class="n">forms1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                            <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">label</span> <span class="p">)</span>

                        <span class="n">forms2</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">finalResidual</span><span class="o">.</span><span class="n">distribution</span> <span class="p">:</span> 
                            <span class="n">forms2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                            <span class="n">finalResidual</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">form</span><span class="o">.</span><span class="n">label</span> <span class="p">)</span>

                        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">forms1</span> <span class="p">:</span> <span class="n">finalResidual</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
                        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">forms2</span> <span class="p">:</span> <span class="n">productList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>

            <span class="k">if</span><span class="p">(</span> <span class="n">breakupProducts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">MT</span> <span class="o">==</span> <span class="mi">91</span> <span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;breakupProducts and decayChannel both not None&#39;</span> <span class="p">)</span>
                    <span class="n">decayChannel</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">NBodyOutputChannel</span><span class="p">(</span> <span class="p">)</span>
                    <span class="n">decayChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">toGNDMiscModule</span><span class="o">.</span><span class="n">returnConstantQ</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">QM</span> <span class="o">-</span> <span class="n">QI</span><span class="p">,</span> <span class="n">_crossSection</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">fillRemainingProductsResidualForBreakup</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">decayChannel</span><span class="p">,</span> <span class="n">lightIsotopeNames</span><span class="p">,</span> <span class="n">breakupProducts</span><span class="p">,</span>
                        <span class="n">particleZA</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="p">),</span> <span class="n">crossSection</span> <span class="p">)</span>
                    <span class="n">productList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addOutputChannel</span><span class="p">(</span> <span class="n">decayChannel</span> <span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;breakup not supported for MT </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MT</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">productList</span> <span class="p">:</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">product</span><span class="o">.</span><span class="n">distribution</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">labToken</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">isTwoBody</span> <span class="p">)</span> <span class="p">:</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">standardsModule</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">centerOfMassToken</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">unspecifiedModule</span><span class="o">.</span><span class="n">form</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">productFrame</span> <span class="o">=</span> <span class="n">frame</span> <span class="p">)</span>
            <span class="n">product</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">form</span> <span class="p">)</span>
        <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">outputChannel</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">uniqueLabel</span><span class="p">(</span> <span class="n">product</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">neutronMFs</span> <span class="o">==</span> <span class="p">[</span> <span class="mi">4</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">outputChannel</span><span class="p">,</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">twoBodyOutputChannel</span> <span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">productID</span> <span class="o">=</span> <span class="n">outputChannel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">productID</span> <span class="o">!=</span> <span class="n">info</span><span class="o">.</span><span class="n">projectile</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">productID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">missingTwoBodyMasses</span> <span class="p">)</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">missingTwoBodyMasses</span><span class="p">[</span><span class="n">productID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">info</span><span class="o">.</span><span class="n">missingTwoBodyMasses</span><span class="p">[</span><span class="n">productID</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">outputChannel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">QM</span> <span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">crossSection</span><span class="p">,</span> <span class="n">outputChannel</span><span class="p">,</span> <span class="n">MFKeys</span> <span class="p">)</span></div>

<div class="viewcode-block" id="parseCovariances"><a class="viewcode-back" href="../../../../../fudge/fudge.legacy.converting.ENDFToGND.html#fudge.legacy.converting.ENDFToGND.ENDF_ITYPE_0_Misc.parseCovariances">[docs]</a><span class="k">def</span> <span class="nf">parseCovariances</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">,</span> <span class="n">MTdict</span><span class="p">,</span> <span class="n">singleMTOnly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resonances</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>

    <span class="n">evaluation</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">NVER</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">LREL</span><span class="p">)</span>
    <span class="n">covarianceSuite</span> <span class="o">=</span> <span class="n">covarianceSuiteModule</span><span class="o">.</span><span class="n">covarianceSuite</span><span class="p">(</span> <span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">evaluation</span> <span class="p">)</span>
    <span class="n">linkData</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># which mf/mts need to be linked for each covariance?</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">singleMTOnly</span> <span class="p">)</span> <span class="p">:</span> <span class="k">return</span><span class="p">(</span> <span class="n">covarianceSuite</span><span class="p">,</span> <span class="n">linkData</span> <span class="p">)</span>

    <span class="c1"># make list of available covariance information:</span>
    <span class="n">warningList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cov_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MTL&#39;</span><span class="p">:{},</span> <span class="s1">&#39;MTL_2&#39;</span><span class="p">:{},</span> <span class="s1">&#39;lumpedChannels&#39;</span><span class="p">:{},</span> <span class="s1">&#39;externalReactions&#39;</span><span class="p">:{},</span> <span class="s1">&#39;mfmts&#39;</span><span class="p">:[],</span> <span class="s1">&#39;MTdict&#39;</span><span class="p">:</span><span class="n">MTdict</span><span class="p">,</span>
            <span class="s1">&#39;resonances&#39;</span><span class="p">:</span><span class="n">resonances</span><span class="p">,</span> <span class="s1">&#39;NC_data&#39;</span><span class="p">:[],</span> <span class="s1">&#39;style&#39;</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="s1">&#39;projectile&#39;</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">projectile</span><span class="p">,</span>
            <span class="s1">&#39;multiplicitySums&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">sums</span><span class="o">.</span><span class="n">multiplicities</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">MTDatas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">singleMTOnly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mt</span><span class="o">!=</span><span class="n">singleMTOnly</span><span class="p">):</span> <span class="k">continue</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mf</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>    <span class="c1"># all covariance-type data</span>
                <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;mfmts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">))</span>
    <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;mfmts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># sorting first by MF, then by MT</span>

    <span class="k">for</span> <span class="n">mf</span><span class="p">,</span><span class="n">mt</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;mfmts&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mf</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="mi">33</span><span class="p">):</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF31_33</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF32</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="mi">151</span><span class="p">][</span><span class="mi">32</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">34</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF34</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">35</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF35</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">covars</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readMF40</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">MTDatas</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">mf</span><span class="p">],</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cov_info</span><span class="p">,</span> <span class="n">warningList</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;MF</span><span class="si">%d</span><span class="s1"> not yet supported&#39;</span> <span class="o">%</span> <span class="n">mf</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span> <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addModelParameterCovariance</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">columnData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">centralValue</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">rowData</span><span class="o">.</span><span class="n">link</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">mf</span> <span class="o">==</span> <span class="mi">35</span> <span class="p">)</span> <span class="p">:</span> <span class="n">centralValue</span> <span class="o">=</span> <span class="n">centralValue</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">centralValue</span><span class="o">.</span><span class="n">uncertainties</span> <span class="o">=</span> <span class="n">uncertaintiesModule</span><span class="o">.</span><span class="n">uncertainties</span><span class="p">(</span>
                                <span class="p">[</span> <span class="n">uncertaintiesModule</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">(</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;covariance&#39;</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="n">linkModule</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">linkData</span> <span class="o">+=</span> <span class="n">tmp</span>
        <span class="k">except</span> <span class="n">BadCovariance</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MF</span><span class="si">%d</span><span class="s1"> MT</span><span class="si">%d</span><span class="s1"> covariance conversion failed with message &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="c1"># fix links for summed matrices:</span>
    <span class="k">for</span> <span class="n">summedMatrix</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;NC_data&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">pointer</span> <span class="ow">in</span> <span class="n">summedMatrix</span><span class="o">.</span><span class="n">pointerList</span><span class="p">:</span>
            <span class="n">pointed_to</span> <span class="o">=</span> <span class="p">[</span><span class="n">sec</span> <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">sections</span> <span class="k">if</span> <span class="n">sec</span><span class="o">.</span><span class="n">columnData</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">sec</span><span class="o">.</span><span class="n">rowData</span><span class="p">[</span><span class="s1">&#39;ENDF_MFMT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pointer</span><span class="p">[</span><span class="s1">&#39;ENDF_MFMT&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pointed_to</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">thisMFMT</span> <span class="o">=</span> <span class="n">summedMatrix</span><span class="o">.</span><span class="n">ancestor</span><span class="o">.</span><span class="n">rowData</span><span class="p">[</span><span class="s1">&#39;ENDF_MFMT&#39;</span><span class="p">]</span>
                <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;Covariance for MF,MT=</span><span class="si">%s</span><span class="s2"> attempts to sum over non-existant covariance </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">thisMFMT</span><span class="p">,</span> <span class="n">pointer</span><span class="p">[</span><span class="s1">&#39;ENDF_MFMT&#39;</span><span class="p">])</span> <span class="p">)</span>
                <span class="n">info</span><span class="o">.</span><span class="n">doRaise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">warningList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">pointer</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">pointed_to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># fix lumped channel covariances (MT851-871) and summed channels (MT1,4,103-107)</span>
    <span class="n">summedReactions</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>  <span class="n">summedReactions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTL_2&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">summedReactions</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lumpedChannels</span> <span class="o">=</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;lumpedChannels&#39;</span><span class="p">][(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warningList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Cannot find lumped channel </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">summandList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Qs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">mt2</span><span class="p">,</span><span class="n">mf2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">summedReactions</span><span class="p">[(</span><span class="n">mt</span><span class="p">,</span><span class="n">mf</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">mt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">851</span><span class="p">,</span><span class="mi">872</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mt2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MTdict&#39;</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">reac</span><span class="p">,</span> <span class="o">=</span> <span class="p">[</span><span class="n">r1</span> <span class="k">for</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">r1</span><span class="o">.</span><span class="n">ENDF_MT</span> <span class="o">==</span> <span class="n">mt2</span><span class="p">]</span>
            <span class="n">xsc</span> <span class="o">=</span> <span class="n">reac</span><span class="o">.</span><span class="n">crossSection</span>
            <span class="n">summandList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">sumsModule</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">link</span><span class="o">=</span><span class="n">xsc</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">Qs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">reac</span><span class="o">.</span><span class="n">outputChannel</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">getConstantAs</span><span class="p">(</span><span class="s1">&#39;eV&#39;</span><span class="p">))</span>
        <span class="n">lumpedChannels</span><span class="o">.</span><span class="n">summands</span> <span class="o">=</span> <span class="n">sumsModule</span><span class="o">.</span><span class="n">listOfSummands</span><span class="p">(</span> <span class="n">summandList</span> <span class="p">)</span>
        <span class="n">newXsc</span> <span class="o">=</span> <span class="n">lumpedChannels</span><span class="o">.</span><span class="n">sumSummands</span><span class="p">()</span>
        <span class="n">newXsc</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span>
        <span class="n">lumpedChannels</span><span class="o">.</span><span class="n">crossSection</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">newXsc</span> <span class="p">)</span>
        <span class="n">lumpedChannels</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">QModule</span><span class="o">.</span><span class="n">constant1d</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">Qs</span><span class="p">),</span> <span class="n">newXsc</span><span class="o">.</span><span class="n">domainMin</span><span class="p">,</span> <span class="n">newXsc</span><span class="o">.</span><span class="n">domainMax</span><span class="p">,</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">channelsModule</span><span class="o">.</span><span class="n">QModule</span><span class="o">.</span><span class="n">defaultAxes</span><span class="p">(</span><span class="s1">&#39;eV&#39;</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">sums</span><span class="o">.</span><span class="n">crossSections</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">lumpedChannels</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">exReac</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;externalReactions&#39;</span><span class="p">]):</span>
        <span class="n">covarianceSuite</span><span class="o">.</span><span class="n">addExternalReaction</span><span class="p">(</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;externalReactions&#39;</span><span class="p">][</span><span class="n">exReac</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">cov_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MF34_missingFrames&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">LegendreLVals</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cov_info</span><span class="p">[</span><span class="s1">&#39;MF34_missingFrames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">matchingreactions</span><span class="o">=</span><span class="p">[</span><span class="n">tmp</span> <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">reactionSuite</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">ENDF_MT</span><span class="o">==</span><span class="n">mt</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matchingreactions</span><span class="p">:</span>
                <span class="n">reaction</span> <span class="o">=</span> <span class="n">matchingreactions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># MF=34 is only for neutrons, so only need to look at neutron product:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">outputChannel</span><span class="o">.</span><span class="n">getProductWithName</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distribution</span><span class="p">[</span> <span class="n">info</span><span class="o">.</span><span class="n">style</span> <span class="p">]</span><span class="o">.</span><span class="n">productFrame</span>
                <span class="k">for</span> <span class="n">lval</span> <span class="ow">in</span> <span class="n">LegendreLVals</span><span class="p">:</span>
                    <span class="n">lval</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
                    <span class="c1"># FIXME: add an &#39;endfConversionFlag&#39; to write back as LCT=0</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warningList</span> <span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;       WARNING: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">warning</span><span class="p">,</span> <span class="n">stderrWriting</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">covarianceSuite</span><span class="p">,</span> <span class="n">linkData</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/gnd.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Fudge and GND 4.2.2 beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012, B.Beck, D. Brown, C. Mattoon, N. Patel, N. Summers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>